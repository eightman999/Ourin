<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", "Hiragino Kaku Gothic ProN", "Hiragino Sans", "游ゴシック", YuGothic, "メイリオ", Meiryo, sans-serif;
            line-height: 1.6;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .content {
            background-color: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            border-bottom: 3px solid #333;
            padding-bottom: 10px;
            color: #333;
        }
        h2 {
            border-bottom: 2px solid #666;
            padding-bottom: 8px;
            margin-top: 30px;
            color: #444;
        }
        h3 {
            margin-top: 25px;
            color: #555;
        }
        code {
            background-color: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: "SF Mono", "Menlo", "Monaco", "Courier New", monospace;
            font-size: 0.9em;
        }
        pre {
            background-color: #f4f4f4;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            border-left: 4px solid #333;
        }
        pre code {
            background-color: transparent;
            padding: 0;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #f8f8f8;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        a {
            color: #0066cc;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
        blockquote {
            border-left: 4px solid #ddd;
            padding-left: 20px;
            margin-left: 0;
            color: #666;
            font-style: italic;
        }
        ul, ol {
            padding-left: 30px;
        }
        li {
            margin: 8px 0;
        }
        hr {
            border: none;
            border-top: 2px solid #ddd;
            margin: 30px 0;
        }
        .toc {
            background-color: #f8f8f8;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
        }
        input[type="checkbox"] {
            margin-right: 8px;
        }
        .footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            text-align: center;
            color: #666;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="content">
        <h1 id="headline20m-macos-draft">HEADLINE/2.0M — macOS ネイティブ差分仕様（Draft）</h1>
<p><strong>Status:</strong> Draft<br />
<strong>Updated:</strong> 2025-07-26<br />
<strong>Audience:</strong> ベースウェア（Ourin/桜鈴）実装者・モジュール作者<br />
<strong>Scope:</strong> UKADOC <strong>HEADLINE/2.0</strong> を母体に、<strong>macOS ネイティブ</strong>（.plugin/.bundle）で安全に運用するための差分を規定します。<br />
<strong>非目標:</strong> Windows DLL のバイナリ互換（語彙・挙動の互換のみ対象）。</p>
<hr />
<h2 id="_1">目次</h2>
<ul>
<li><a href="#1-目的と設計方針">1. 目的と設計方針</a></li>
<li><a href="#2-用語">2. 用語</a></li>
<li><a href="#3-適用範囲と互換性">3. 適用範囲と互換性</a></li>
<li><a href="#4-oscpu-と配布">4. OS/CPU と配布</a></li>
<li><a href="#5-実体とエクスポートpluginbundle">5. 実体とエクスポート（.plugin/.bundle）</a></li>
<li><a href="#6-ワイヤheadline20-との差分">6. ワイヤ（HEADLINE/2.0 との差分）</a></li>
<li><a href="#7-path-の表現macos-最適化">7. Path の表現（macOS 最適化）</a></li>
<li><a href="#8-設定ファイルdescripttxt差分">8. 設定ファイル（descript.txt）差分</a></li>
<li><a href="#9-エラー応答の指針">9. エラー応答の指針</a></li>
<li><a href="#10-セキュリティ安定性xpc隔離は推奨">10. セキュリティ/安定性（XPC隔離は推奨）</a></li>
<li><a href="#11-例version--headline-取得">11. 例（Version / Headline 取得）</a></li>
<li><a href="#12-最小実装c">12. 最小実装（C）</a></li>
<li><a href="#13-適合チェックリスト">13. 適合チェックリスト</a></li>
<li><a href="#14-参照normative--informative">14. 参照（Normative / Informative）</a></li>
</ul>
<hr />
<h2 id="1">1. 目的と設計方針</h2>
<ul>
<li><strong>HEADLINE/2.0 の語彙・挙動を維持</strong>しつつ、<strong>macOS の Loadable Bundle（.plugin/.bundle）</strong>に対応。  </li>
<li><strong>文字コードは UTF‑8 を既定</strong>とし、互換のため <strong>Shift_JIS / Windows‑31J</strong> 等のラベルを <strong>同一系として受理</strong>します。  </li>
<li><strong>バイナリ互換は対象外</strong>。Windows 固有の API（HGLOBAL 等）は用いず、<strong>生バイト列 + 長さ</strong>の呼び出し規約に読み替えます。</li>
</ul>
<h2 id="2">2. 用語</h2>
<ul>
<li><strong>2.0M</strong>: 本仕様の Mac 差分版識別子。  </li>
<li><strong>ホスト</strong>: Ourin（桜鈴）など、HEADLINE モジュールを実行するベースウェア。  </li>
<li><strong>モジュール</strong>: HEADLINE の実装本体（.plugin/.bundle で配布）。  </li>
<li><strong>ワイヤ</strong>: <code>GET Version HEADLINE/2.x</code> / <code>GET Headline HEADLINE/2.x</code> を先頭行とするテキストの往復。</li>
</ul>
<h2 id="3">3. 適用範囲と互換性</h2>
<ul>
<li><strong>語彙互換</strong>：<code>GET Version</code> / <code>GET Headline</code>、<code>Charset</code>、<code>Option</code>、<code>Path</code>、<code>Headline</code>、<code>RequestCharset</code> など <strong>HEADLINE/2.0 と同一のヘッダ/意味</strong>を踏襲します。  </li>
<li><strong>既定文字コード</strong>：2.0M では未指定時 <strong>UTF‑8</strong>。<code>Shift_JIS</code> / <code>Windows‑31J</code> などは <strong>同一系（CP932 相当）</strong>として受理します。  </li>
<li><strong>呼び出し回数</strong>：<code>GET Headline</code> は <strong>旧ファイル→新ファイル</strong>の <strong>2 回</strong>呼び出され得ます（順不同）。モジュールは順に依存しないこと。</li>
</ul>
<h2 id="4-oscpu">4. OS/CPU と配布</h2>
<ul>
<li><strong>最小 OS:</strong> <strong>macOS 10.15（Catalina）以降</strong>。  </li>
<li><strong>配布形態:</strong> <strong>Universal 2</strong>（<code>arm64 + x86_64</code>）を推奨必須。  </li>
<li><strong>実体:</strong> <strong>Bundle（.plugin/.bundle）</strong> とし、CFBundle/Bundle API でロードします。</li>
</ul>
<h2 id="5-pluginbundle">5. 実体とエクスポート（.plugin/.bundle）</h2>
<ul>
<li><strong>必須エクスポート（C ABI）</strong>
  ```c
  // HEADLINE/2.0 の “execute” を踏襲
  const unsigned char<em> execute(const unsigned char</em> req, size_t len, size_t* out_len);</li>
</ul>
<p>// 任意：メモリ解放フック（ホストが即時コピーする設計を推奨）
  void headline_free(void* p);</p>
<p>// 任意：ライフサイクル（UTF‑8 パス受領を推奨）
  int  loadu(const char<em> plugin_dir_utf8); // 成功0
  void unload(void);
  <code>``
- **ロード/解決**：ホストは</code>CFBundleGetFunctionPointerForName<code>で</code>execute` を取得。返却バッファは </em><em>UTF‑8</em>* を推奨。</p>
<h2 id="6-headline20">6. ワイヤ（HEADLINE/2.0 との差分）</h2>
<ul>
<li><strong>版表記</strong>：<code>HEADLINE/2.0M</code>（構文は 2.0 と同形）。  </li>
<li><strong>CRLF/空行終端</strong>：2.0 と同じ。ゼロ終端は前提にしない。  </li>
<li><strong><code>Option: url</code></strong>：2.0 と同じく有効。<code>Headline:</code> 値は <strong>本文 + 0x01 + URL</strong>（複数行可）。  </li>
<li><strong><code>RequestCharset</code></strong>：モジュールからホストへ <strong>次回の希望文字コード</strong>を提示可。</li>
</ul>
<h2 id="7-path-macos">7. Path の表現（macOS 最適化）</h2>
<ul>
<li><strong>推奨</strong>：<code>Path:</code> は <strong>POSIX 絶対パス（UTF‑8）</strong> または <strong><code>file://</code> URL（RFC 8089 準拠）</strong>。  </li>
<li><strong>互換</strong>：Windows 風パス <code>C:\...</code> を受け取った場合、<strong>ホスト側で POSIX/<code>file://</code> に正規化</strong>してからモジュールに渡します。  </li>
<li><strong>実装ヒント</strong>：Foundation の <code>URL(fileURLWithPath:)</code> / <code>standardizedFileURL</code> を利用。</li>
</ul>
<h2 id="8-descripttxt">8. 設定ファイル（descript.txt）差分</h2>
<ul>
<li><strong>基本</strong>は HEADLINE/2.0 の規定に従います（<code>name</code>/<code>dllname</code>/<code>url</code>/<code>openurl</code> 等）。  </li>
<li><strong>2.0M 追加</strong>：<code>dllname</code> の代替として <strong><code>filename</code> に .plugin/.bundle</strong> を指定可能（両立時は <code>filename</code> を優先）。  </li>
<li><strong>文字コード</strong>：<code>charset</code> は UTF‑8 推奨（旧互換で Shift_JIS も可）。  </li>
<li><strong>注意</strong>：行頭が <code>\</code> / <code>%</code> の文字列は<strong>破棄対象</strong>のため、利用時は<strong>エスケープ</strong>が必要。</li>
</ul>
<h2 id="9">9. エラー応答の指針</h2>
<ul>
<li><strong>400 Bad Request</strong>：CRLF/空行終端の欠落、必須ヘッダ不足。  </li>
<li><strong>415 Unsupported Charset</strong>：不明なラベル。  </li>
<li><strong>500 Module Error</strong>：モジュール内例外。</li>
</ul>
<h2 id="10-xpc">10. セキュリティ/安定性（XPC隔離は推奨）</h2>
<ul>
<li>解析負荷が高いモジュールは <strong>NSXPCConnection</strong> を用いて <strong>別プロセス</strong>化（<code>request(Data)-&gt;Data</code> 相当の橋渡し）。  </li>
<li>クラッシュ隔離・権限最小化に寄与。</li>
</ul>
<h2 id="11-version-headline">11. 例（Version / Headline 取得）</h2>
<h3 id="111-version">11.1 Version 照会</h3>
<p><strong>Request</strong></p>
<pre><code>GET Version HEADLINE/2.0M
Charset: UTF-8
Sender: Ourin
</code></pre>
<p><strong>Response</strong></p>
<pre><code>HEADLINE/2.0M 200 OK
Charset: UTF-8
Value: HeadlineModule 1.1
</code></pre>
<h3 id="112-headline-option-url">11.2 Headline 取得（<code>Option: url</code>）</h3>
<p><strong>Request</strong></p>
<pre><code>GET Headline HEADLINE/2.0M
Charset: UTF-8
Option: url
Path: file:///Users/you/Library/Application%20Support/Ourin/cache/news.html
</code></pre>
<p><strong>Response</strong></p>
<pre><code>HEADLINE/2.0M 200 OK
Charset: UTF-8
Headline: ほげ1\x01https://example.com/1
Headline: ほげ2\x01https://example.com/2
Headline: ほげ3\x01https://example.com/3
</code></pre>
<blockquote>
<p>注: <code>GET Headline</code> は <strong>旧/新ファイルに対して 2 回</strong>呼ばれ得ます。順序に依存しない実装としてください。</p>
</blockquote>
<h2 id="12-c">12. 最小実装（C）</h2>
<pre><code class="language-c">#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
static unsigned char* dupmsg(const char* s, size_t* out){ size_t n=strlen(s); unsigned char* p=malloc(n); memcpy(p,s,n); *out=n; return p; }

const unsigned char* execute(const unsigned char* req, size_t len, size_t* out_len) {
  (void)len; (void)req;
  // 超簡易: Versionリクエストだけ200で返すデモ（実用では解析必須）
  const char* ok =
    &quot;HEADLINE/2.0M 200 OK\r\n&quot;
    &quot;Charset: UTF-8\r\n&quot;
    &quot;Value: HeadlineModule 1.0\r\n&quot;
    &quot;\r\n&quot;;
  return dupmsg(ok, out_len);
}
void headline_free(void* p){ free(p); }
int loadu(const char* plugin_dir_utf8){ (void)plugin_dir_utf8; return 0; }
void unload(void){}
</code></pre>
<h2 id="13">13. 適合チェックリスト</h2>
<ul>
<li>[ ] 先頭行に <code>HEADLINE/2.0M</code> を用い、<strong>CRLF/空行終端</strong>で往復できる。  </li>
<li>[ ] <strong>UTF‑8 既定</strong>、<code>Shift_JIS</code>/<code>Windows‑31J</code> を受理。  </li>
<li>[ ] <code>Option: url</code> 時の <code>Headline: 本文\x01URL</code> を処理。  </li>
<li>[ ] <code>Path:</code> に <strong>POSIX/<code>file://</code></strong> を受理（Windows 風はホストで正規化）。  </li>
<li>[ ] 実体は <strong>.plugin/.bundle</strong>、<code>execute</code> を C ABI で公開。</li>
</ul>
<h2 id="14-normative-informative">14. 参照（Normative / Informative）</h2>
<ul>
<li>UKADOC: <strong>HEADLINE/2.0</strong>（語彙・<code>Option: url</code>・0x01区切り・2回呼び出しの注意）  </li>
<li>UKADOC: <strong>Headline 設定（descript.txt）</strong>（必須項目・文字コード・<code>\</code>/<code>%</code> エスケープ）  </li>
<li>UKADOC: <strong>DLL共通仕様</strong>（Windows 固有メモリ規約の参考—2.0M では置換）  </li>
<li>Apple: <strong>CFBundleGetFunctionPointerForName</strong>（関数名でポインタ解決）  </li>
<li>Apple: <strong>Universal 2</strong>（<code>arm64</code>/<code>x86_64</code>）  </li>
<li>Apple: <strong>32‑bit 非対応（10.15+）</strong>  </li>
<li>RFC 8089: <strong>file URL</strong>  </li>
</ul>
        <div class="footer">
            <p>Ourin (桜鈴) - macOS ネイティブ伺かベースウェア</p>
        </div>
    </div>
</body>
</html>