<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>yaya_core から Swift 製プラグインを扱う手順</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", "Hiragino Kaku Gothic ProN", "Hiragino Sans", "游ゴシック", YuGothic, "メイリオ", Meiryo, sans-serif;
            line-height: 1.6;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .content {
            background-color: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .lang-switcher {
            text-align: right;
            margin-bottom: 20px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
        }
        .lang-switcher a {
            margin: 0 5px;
            padding: 5px 15px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 3px;
            text-decoration: none;
            color: #333;
        }
        .lang-switcher a:hover {
            background-color: #e0e0e0;
        }
        .lang-switcher a.active {
            background-color: #0066cc;
            color: white;
            border-color: #0066cc;
        }
        h1 {
            border-bottom: 3px solid #333;
            padding-bottom: 10px;
            color: #333;
        }
        h2 {
            border-bottom: 2px solid #666;
            padding-bottom: 8px;
            margin-top: 30px;
            color: #444;
        }
        h3 {
            margin-top: 25px;
            color: #555;
        }
        code {
            background-color: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: "SF Mono", "Menlo", "Monaco", "Courier New", monospace;
            font-size: 0.9em;
        }
        pre {
            background-color: #f4f4f4;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            border-left: 4px solid #333;
        }
        pre code {
            background-color: transparent;
            padding: 0;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #f8f8f8;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        a {
            color: #0066cc;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
        blockquote {
            border-left: 4px solid #ddd;
            padding-left: 20px;
            margin-left: 0;
            color: #666;
            font-style: italic;
        }
        ul, ol {
            padding-left: 30px;
        }
        li {
            margin: 8px 0;
        }
        hr {
            border: none;
            border-top: 2px solid #ddd;
            margin: 30px 0;
        }
        .footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            text-align: center;
            color: #666;
            font-size: 0.9em;
        }
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #0066cc;
            text-decoration: none;
        }
        .back-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="content">
        <div class="lang-switcher">
            
        </div>
        <div class="back-link">
            <a href="index.html">← 目次に戻る</a>
        </div>
        <h1 id="yaya_core-swift">yaya_core から Swift 製プラグインを扱う手順</h1>
<p>本書では、<code>yaya_core</code>（C++ 製ヘルパー実行ファイル）から macOS ネイティブの Swift プラグイン（<code>.plugin</code> / <code>.bundle</code>）をロードし、SHIORI/PLUGIN プロトコルのやり取りを行うための手順を整理します。すべて UTF-8 を既定とし、記述は日本語で統一しています。</p>
<h2 id="1">1. 全体像</h2>
<ol>
<li>Swift で PLUGIN/2.0M 仕様に準拠したロード可能バンドルを用意する。</li>
<li>バンドルをアプリの <code>Ourin.app/Contents/PlugIns/</code> など既定ディレクトリへ配置する。</li>
<li><code>yaya_core</code> が CFBundle API を介してプラグインをロードし、<code>load</code> / <code>request</code> / <code>unload</code> を呼び出す。</li>
<li>PLUGIN で返されたワイヤ文字列を <code>yaya_core</code> 側でパースし、JSON IPC 応答として Swift 層へ返す。</li>
</ol>
<p>Swift プラグインは Swift コードで実装されますが、エクスポートは C ABI で提供されるため、<code>yaya_core</code>（C++）からも透過的に呼び出すことができます。</p>
<h2 id="2-swift">2. Swift プラグインの要件</h2>
<h3 id="21">2.1 ターゲット設定</h3>
<ul>
<li>Xcode で <strong>Bundle（Mach-O Type: Bundle）</strong> を選択し、出力拡張子を <code>.plugin</code> に設定します。</li>
<li><strong>Architectures:</strong> <code>arm64</code> / <code>x86_64</code>（Universal 2）を有効にすること。</li>
<li><strong>Deployment Target:</strong> macOS 10.15 以上。</li>
</ul>
<h3 id="22">2.2 エクスポート関数</h3>
<p>Swift コードからは <code>@_cdecl</code> で C ABI の関数を公開します。</p>
<div class="codehilite"><pre><span></span><code><span class="p">@</span><span class="n">_cdecl</span><span class="p">(</span><span class="s">&quot;load&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">func</span> <span class="nf">pluginLoad</span><span class="p">(</span><span class="kc">_</span> <span class="n">pluginDir</span><span class="p">:</span> <span class="nb">UnsafePointer</span><span class="p">&lt;</span><span class="nb">CChar</span><span class="p">&gt;)</span> <span class="p">-&gt;</span> <span class="nb">Int32</span> <span class="p">{</span>
    <span class="c1">// 初期化処理（必要ならバンドルパス解析など）</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="p">}</span>

<span class="p">@</span><span class="n">_cdecl</span><span class="p">(</span><span class="s">&quot;request&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">func</span> <span class="nf">pluginRequest</span><span class="p">(</span><span class="kc">_</span> <span class="n">bytes</span><span class="p">:</span> <span class="nb">UnsafePointer</span><span class="p">&lt;</span><span class="nb">UInt8</span><span class="p">&gt;,</span> <span class="kc">_</span> <span class="n">length</span><span class="p">:</span> <span class="nb">Int</span><span class="p">,</span> <span class="kc">_</span> <span class="n">outLength</span><span class="p">:</span> <span class="nb">UnsafeMutablePointer</span><span class="p">&lt;</span><span class="nb">Int</span><span class="p">&gt;)</span> <span class="p">-&gt;</span> <span class="nb">UnsafePointer</span><span class="p">&lt;</span><span class="nb">UInt8</span><span class="p">&gt;?</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">data</span> <span class="p">=</span> <span class="n">Data</span><span class="p">(</span><span class="n">bytes</span><span class="p">:</span> <span class="n">bytes</span><span class="p">,</span> <span class="bp">count</span><span class="p">:</span> <span class="n">length</span><span class="p">)</span>
    <span class="k">guard</span> <span class="kd">let</span> <span class="nv">response</span> <span class="p">=</span> <span class="n">handleWire</span><span class="p">(</span><span class="nb">String</span><span class="p">(</span><span class="n">decoding</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="k">as</span><span class="p">:</span> <span class="nb">UTF8</span><span class="p">.</span><span class="kc">self</span><span class="p">))</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">outLength</span><span class="p">.</span><span class="n">pointee</span> <span class="p">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="kc">nil</span>
    <span class="p">}</span>
    <span class="kd">let</span> <span class="nv">utf8</span> <span class="p">=</span> <span class="nb">Array</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">utf8</span><span class="p">)</span>
    <span class="kd">let</span> <span class="nv">buffer</span> <span class="p">=</span> <span class="nb">UnsafeMutablePointer</span><span class="p">&lt;</span><span class="nb">UInt8</span><span class="p">&gt;.</span><span class="n">allocate</span><span class="p">(</span><span class="n">capacity</span><span class="p">:</span> <span class="n">utf8</span><span class="p">.</span><span class="bp">count</span><span class="p">)</span>
    <span class="kc">_</span> <span class="p">=</span> <span class="n">buffer</span><span class="p">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="n">utf8</span><span class="p">,</span> <span class="bp">count</span><span class="p">:</span> <span class="n">utf8</span><span class="p">.</span><span class="bp">count</span><span class="p">)</span>
    <span class="n">outLength</span><span class="p">.</span><span class="n">pointee</span> <span class="p">=</span> <span class="n">utf8</span><span class="p">.</span><span class="bp">count</span>
    <span class="k">return</span> <span class="nb">UnsafePointer</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">}</span>

<span class="p">@</span><span class="n">_cdecl</span><span class="p">(</span><span class="s">&quot;unload&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">func</span> <span class="nf">pluginUnload</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// 後始末</span>
<span class="p">}</span>
<span class="p">@</span><span class="n">_cdecl</span><span class="p">(</span><span class="s">&quot;plugin_free&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">func</span> <span class="nf">pluginFree</span><span class="p">(</span><span class="kc">_</span> <span class="n">pointer</span><span class="p">:</span> <span class="nb">UnsafeMutablePointer</span><span class="p">&lt;</span><span class="nb">UInt8</span><span class="p">&gt;?)</span> <span class="p">{</span>
    <span class="n">pointer</span><span class="p">?.</span><span class="n">deallocate</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>

<blockquote>
<p><strong>メモ:</strong> <code>request</code> から返すバッファはライフサイクル管理が重要です。コピーして返す場合は、<code>plugin_free</code> を併せて公開し <code>yaya_core</code> 側が解放できるようにします。</p>
</blockquote>
<h2 id="3">3. プラグインの配置</h2>
<ul>
<li><code>Ourin.app</code> バンドル配下の <code>Contents/PlugIns/</code> に配置するのが推奨です。</li>
<li>プラグインバンドル内には最低限 <code>Contents/Info.plist</code> と <code>Contents/MacOS/&lt;Executable&gt;</code>、<code>Contents/Resources/descript.txt</code> を含めます。</li>
<li><code>descript.txt</code> の <code>filename</code> は <code>.plugin</code> を指定し、文字コードは UTF-8 を推奨します。</li>
</ul>
<h2 id="4-yaya_core">4. yaya_core 側でのロード処理</h2>
<p>C++17 以降で CoreFoundation をリンクし、<code>CFBundle</code> API を利用します。以下は概念的なコード断片です。</p>
<div class="codehilite"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;CoreFoundation/CoreFoundation.h&gt;</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">PluginHandle</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">CFBundleRef</span><span class="w"> </span><span class="n">bundle</span><span class="p">;</span>
<span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="n">LoadFn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">int32_t</span><span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="n">RequestFn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="o">*</span><span class="p">);</span>
<span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="n">UnloadFn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">void</span><span class="p">(</span><span class="o">*</span><span class="p">)();</span>

<span class="w">    </span><span class="n">LoadFn</span><span class="w"> </span><span class="n">load</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<span class="w">    </span><span class="n">RequestFn</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<span class="w">    </span><span class="n">UnloadFn</span><span class="w"> </span><span class="n">unload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">PluginHandle</span><span class="w"> </span><span class="nf">loadPlugin</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">path</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">PluginHandle</span><span class="w"> </span><span class="n">handle</span><span class="p">{};</span>
<span class="w">    </span><span class="n">CFURLRef</span><span class="w"> </span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CFURLCreateWithFileSystemPath</span><span class="p">(</span><span class="n">kCFAllocatorDefault</span><span class="p">,</span><span class="w"> </span><span class="n">CFStringCreateWithCString</span><span class="p">(</span><span class="k">nullptr</span><span class="p">,</span><span class="w"> </span><span class="n">path</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="n">kCFStringEncodingUTF8</span><span class="p">),</span><span class="w"> </span><span class="n">kCFURLPOSIXPathStyle</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
<span class="w">    </span><span class="n">handle</span><span class="p">.</span><span class="n">bundle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CFBundleCreate</span><span class="p">(</span><span class="n">kCFAllocatorDefault</span><span class="p">,</span><span class="w"> </span><span class="n">url</span><span class="p">);</span>
<span class="w">    </span><span class="n">CFRelease</span><span class="p">(</span><span class="n">url</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">handle</span><span class="p">.</span><span class="n">bundle</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">CFBundleLoadExecutable</span><span class="p">(</span><span class="n">handle</span><span class="p">.</span><span class="n">bundle</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;Failed to load plugin bundle&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">handle</span><span class="p">.</span><span class="n">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">PluginHandle</span><span class="o">::</span><span class="n">RequestFn</span><span class="o">&gt;</span><span class="p">(</span><span class="n">CFBundleGetFunctionPointerForName</span><span class="p">(</span><span class="n">handle</span><span class="p">.</span><span class="n">bundle</span><span class="p">,</span><span class="w"> </span><span class="n">CFSTR</span><span class="p">(</span><span class="s">&quot;request&quot;</span><span class="p">)));</span>
<span class="w">    </span><span class="n">handle</span><span class="p">.</span><span class="n">load</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">PluginHandle</span><span class="o">::</span><span class="n">LoadFn</span><span class="o">&gt;</span><span class="p">(</span><span class="n">CFBundleGetFunctionPointerForName</span><span class="p">(</span><span class="n">handle</span><span class="p">.</span><span class="n">bundle</span><span class="p">,</span><span class="w"> </span><span class="n">CFSTR</span><span class="p">(</span><span class="s">&quot;load&quot;</span><span class="p">)));</span>
<span class="w">    </span><span class="n">handle</span><span class="p">.</span><span class="n">unload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">PluginHandle</span><span class="o">::</span><span class="n">UnloadFn</span><span class="o">&gt;</span><span class="p">(</span><span class="n">CFBundleGetFunctionPointerForName</span><span class="p">(</span><span class="n">handle</span><span class="p">.</span><span class="n">bundle</span><span class="p">,</span><span class="w"> </span><span class="n">CFSTR</span><span class="p">(</span><span class="s">&quot;unload&quot;</span><span class="p">)));</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">handle</span><span class="p">.</span><span class="n">request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;request symbol missing&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">handle</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="41">4.1 ライフサイクル</h3>
<ol>
<li><code>load()</code> が存在する場合はバンドルディレクトリ（UTF-8 パス）を渡して初期化します。</li>
<li><code>request()</code> でワイヤ文字列（CRLF + 空行終端）を UTF-8 バイト列として渡します。</li>
<li><code>unload()</code> が存在する場合は終了処理で必ず呼び出します。</li>
<li><code>CFBundleUnloadExecutable</code> と <code>CFRelease</code> でバンドルを解放します。</li>
</ol>
<h2 id="5-json">5. ワイヤ ↔ JSON 変換</h2>
<ul>
<li>プラグインとの通信は <strong>PLUGIN/2.0M</strong> のワイヤ文字列です。</li>
<li><code>yaya_core</code> はこれを受け取り、SHIORI レイヤで <code>status</code> や <code>Value</code> を抽出して JSON IPC 形式にマッピングします。</li>
<li>例: Swift プラグインが <code>PLUGIN/2.0M 200 OK</code> を返した場合、<code>yaya_core</code> は <code>{ "ok": true, "status": 200, ... }</code> へ変換します。</li>
</ul>
<h2 id="6">6. エラー処理とデバッグ</h2>
<ul>
<li>シンボル取得に失敗した場合は即座にアンロードし、JSON IPC でエラーを返す。</li>
<li><code>request()</code> の戻り値が <code>nullptr</code> の場合は <code>500</code> 相当のエラーとして扱う。</li>
<li>Xcode の <code>DYLD_PRINT_LIBRARIES</code> や <code>CFBundleCopyBundleURL</code> でロード状況を確認できます。</li>
<li>ログは JSON 形式で出力し、Swift 側・<code>yaya_core</code> 側で突き合わせます。</li>
</ul>
<h2 id="7">7. マルチアーキテクチャ対応</h2>
<ul>
<li>プラグインと <code>yaya_core</code> の両方を Universal 2 でビルドし、Rosetta 実行時の不整合を避けます。</li>
<li><code>lipo -info MyPlugin.plugin/Contents/MacOS/MyPlugin</code> でアーキテクチャを確認します。</li>
</ul>
<h2 id="8">8. テスト戦略</h2>
<ol>
<li><strong>単体テスト:</strong> Swift プラグイン側で <code>request()</code> の入出力を XCTest で検証。</li>
<li><strong>結合テスト:</strong> <code>yaya_core</code> から実際にロードして JSON IPC 経由で応答を確認するスクリプトを整備。</li>
<li><strong>ロングラン:</strong> プラグインを連続ロード/アンロードし、メモリリークが発生しないかを Instruments で監視します。</li>
</ol>
<hr />
<p>以上が <code>yaya_core</code> から Swift 製プラグインを安全に扱うための手順です。実装時には <code>SPEC_PLUGIN_2.0M.md</code> や <code>OURIN_YAYA_ADAPTER_SPEC_1.0M.md</code> の規定も併せて参照し、ワイヤ仕様や IPC の整合性を確認してください。</p>
        <div class="footer">
            <p>Generated: 2025-10-23 | <a href="../README_ja-jp.md">Source (MD)</a></p>
        </div>
    </div>
</body>
</html>
