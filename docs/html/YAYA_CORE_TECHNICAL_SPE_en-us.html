<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YAYA Core 技術仕様書</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", "Hiragino Kaku Gothic ProN", "Hiragino Sans", "游ゴシック", YuGothic, "メイリオ", Meiryo, sans-serif;
            line-height: 1.6;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .content {
            background-color: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .lang-switcher {
            text-align: right;
            margin-bottom: 20px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
        }
        .lang-switcher a {
            margin: 0 5px;
            padding: 5px 15px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 3px;
            text-decoration: none;
            color: #333;
        }
        .lang-switcher a:hover {
            background-color: #e0e0e0;
        }
        .lang-switcher a.active {
            background-color: #0066cc;
            color: white;
            border-color: #0066cc;
        }
        h1 {
            border-bottom: 3px solid #333;
            padding-bottom: 10px;
            color: #333;
        }
        h2 {
            border-bottom: 2px solid #666;
            padding-bottom: 8px;
            margin-top: 30px;
            color: #444;
        }
        h3 {
            margin-top: 25px;
            color: #555;
        }
        code {
            background-color: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: "SF Mono", "Menlo", "Monaco", "Courier New", monospace;
            font-size: 0.9em;
        }
        pre {
            background-color: #f4f4f4;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            border-left: 4px solid #333;
        }
        pre code {
            background-color: transparent;
            padding: 0;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #f8f8f8;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        a {
            color: #0066cc;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
        blockquote {
            border-left: 4px solid #ddd;
            padding-left: 20px;
            margin-left: 0;
            color: #666;
            font-style: italic;
        }
        ul, ol {
            padding-left: 30px;
        }
        li {
            margin: 8px 0;
        }
        hr {
            border: none;
            border-top: 2px solid #ddd;
            margin: 30px 0;
        }
        .footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            text-align: center;
            color: #666;
            font-size: 0.9em;
        }
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #0066cc;
            text-decoration: none;
        }
        .back-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="content">
        <div class="lang-switcher">
            
        </div>
        <div class="back-link">
            <a href="index.html">← Back to Index</a>
        </div>
        <h1 id="yaya-core">YAYA Core 技術仕様書</h1>
<p><strong>バージョン</strong>: 1.0<br />
<strong>日付</strong>: 2025-10-16<br />
<strong>対象</strong>: macOS (Universal Binary: arm64 + x86_64)<br />
<strong>ライセンス</strong>: BSD-3-Clause (YAYA準拠)</p>
<hr />
<h2 id="1">1. 概要</h2>
<h3 id="11">1.1 目的</h3>
<p>本ドキュメントは、Ourin向けYAYA Core実装の技術的な詳細を定義します。Windows版YAYAの言語仕様を参考にしつつ、macOSネイティブ環境に最適化された実装を提供します。</p>
<h3 id="12">1.2 スコープ</h3>
<ul>
<li>YAYA言語の字句解析・構文解析</li>
<li>YAYA仮想マシン（VM）の実装</li>
<li>SHIORI/3.0Mプロトコルとの統合</li>
<li>UTF-8/CP932文字コードのサポート</li>
</ul>
<h3 id="13">1.3 非スコープ</h3>
<ul>
<li>Windows DLLバイナリ互換（不可能）</li>
<li>SAORI連携（Phase 2以降）</li>
<li>デバッガUI（将来拡張）</li>
</ul>
<hr />
<h2 id="2-yaya">2. YAYA言語仕様（実装対象）</h2>
<h3 id="21-lexical-elements">2.1 字句要素（Lexical Elements）</h3>
<h4 id="211">2.1.1 トークン種別</h4>
<div class="codehilite"><pre><span></span><code><span class="k">enum</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">TokenType</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// リテラル</span>
<span class="w">    </span><span class="n">String</span><span class="p">,</span><span class="w">          </span><span class="c1">// &quot;文字列&quot;</span>
<span class="w">    </span><span class="n">Integer</span><span class="p">,</span><span class="w">         </span><span class="c1">// 123</span>
<span class="w">    </span><span class="n">Float</span><span class="p">,</span><span class="w">           </span><span class="c1">// 3.14</span>

<span class="w">    </span><span class="c1">// 識別子・キーワード</span>
<span class="w">    </span><span class="n">Identifier</span><span class="p">,</span><span class="w">      </span><span class="c1">// 変数名・関数名</span>
<span class="w">    </span><span class="n">If</span><span class="p">,</span><span class="w">              </span><span class="c1">// if</span>
<span class="w">    </span><span class="n">Else</span><span class="p">,</span><span class="w">            </span><span class="c1">// else</span>
<span class="w">    </span><span class="n">ElseIf</span><span class="p">,</span><span class="w">          </span><span class="c1">// elseif</span>
<span class="w">    </span><span class="n">When</span><span class="p">,</span><span class="w">            </span><span class="c1">// when</span>
<span class="w">    </span><span class="n">While</span><span class="p">,</span><span class="w">           </span><span class="c1">// while</span>
<span class="w">    </span><span class="n">For</span><span class="p">,</span><span class="w">             </span><span class="c1">// for</span>
<span class="w">    </span><span class="n">Foreach</span><span class="p">,</span><span class="w">         </span><span class="c1">// foreach</span>
<span class="w">    </span><span class="n">Break</span><span class="p">,</span><span class="w">           </span><span class="c1">// break</span>
<span class="w">    </span><span class="n">Continue</span><span class="p">,</span><span class="w">        </span><span class="c1">// continue</span>
<span class="w">    </span><span class="n">Return</span><span class="p">,</span><span class="w">          </span><span class="c1">// return</span>

<span class="w">    </span><span class="c1">// 演算子</span>
<span class="w">    </span><span class="n">Assign</span><span class="p">,</span><span class="w">          </span><span class="c1">// =</span>
<span class="w">    </span><span class="n">Plus</span><span class="p">,</span><span class="w">            </span><span class="c1">// +</span>
<span class="w">    </span><span class="n">Minus</span><span class="p">,</span><span class="w">           </span><span class="c1">// -</span>
<span class="w">    </span><span class="n">Multiply</span><span class="p">,</span><span class="w">        </span><span class="c1">// *</span>
<span class="w">    </span><span class="n">Divide</span><span class="p">,</span><span class="w">          </span><span class="c1">// /</span>
<span class="w">    </span><span class="n">Modulo</span><span class="p">,</span><span class="w">          </span><span class="c1">// %</span>
<span class="w">    </span><span class="n">Equal</span><span class="p">,</span><span class="w">           </span><span class="c1">// ==</span>
<span class="w">    </span><span class="n">NotEqual</span><span class="p">,</span><span class="w">        </span><span class="c1">// !=</span>
<span class="w">    </span><span class="n">Less</span><span class="p">,</span><span class="w">            </span><span class="c1">// &lt;</span>
<span class="w">    </span><span class="n">Greater</span><span class="p">,</span><span class="w">         </span><span class="c1">// &gt;</span>
<span class="w">    </span><span class="n">LessEqual</span><span class="p">,</span><span class="w">       </span><span class="c1">// &lt;=</span>
<span class="w">    </span><span class="n">GreaterEqual</span><span class="p">,</span><span class="w">    </span><span class="c1">// &gt;=</span>
<span class="w">    </span><span class="n">LogicalAnd</span><span class="p">,</span><span class="w">      </span><span class="c1">// &amp;&amp;</span>
<span class="w">    </span><span class="n">LogicalOr</span><span class="p">,</span><span class="w">       </span><span class="c1">// ||</span>
<span class="w">    </span><span class="n">LogicalNot</span><span class="p">,</span><span class="w">      </span><span class="c1">// !</span>
<span class="w">    </span><span class="n">BitwiseAnd</span><span class="p">,</span><span class="w">      </span><span class="c1">// &amp;</span>
<span class="w">    </span><span class="n">BitwiseOr</span><span class="p">,</span><span class="w">       </span><span class="c1">// |</span>
<span class="w">    </span><span class="n">BitwiseXor</span><span class="p">,</span><span class="w">      </span><span class="c1">// ^</span>
<span class="w">    </span><span class="n">LeftShift</span><span class="p">,</span><span class="w">       </span><span class="c1">// &lt;&lt;</span>
<span class="w">    </span><span class="n">RightShift</span><span class="p">,</span><span class="w">      </span><span class="c1">// &gt;&gt;</span>
<span class="w">    </span><span class="n">Increment</span><span class="p">,</span><span class="w">       </span><span class="c1">// ++</span>
<span class="w">    </span><span class="n">Decrement</span><span class="p">,</span><span class="w">       </span><span class="c1">// --</span>
<span class="w">    </span><span class="n">Question</span><span class="p">,</span><span class="w">        </span><span class="c1">// ?</span>
<span class="w">    </span><span class="n">Colon</span><span class="p">,</span><span class="w">           </span><span class="c1">// :</span>
<span class="w">    </span><span class="n">Comma</span><span class="p">,</span><span class="w">           </span><span class="c1">// ,</span>
<span class="w">    </span><span class="n">Semicolon</span><span class="p">,</span><span class="w">       </span><span class="c1">// ;</span>
<span class="w">    </span><span class="n">Match</span><span class="p">,</span><span class="w">           </span><span class="c1">// =~ (正規表現マッチ)</span>
<span class="w">    </span><span class="n">NotMatch</span><span class="p">,</span><span class="w">        </span><span class="c1">// !~ (正規表現非マッチ)</span>

<span class="w">    </span><span class="c1">// 区切り文字</span>
<span class="w">    </span><span class="n">LeftBrace</span><span class="p">,</span><span class="w">       </span><span class="c1">// {</span>
<span class="w">    </span><span class="n">RightBrace</span><span class="p">,</span><span class="w">      </span><span class="c1">// }</span>
<span class="w">    </span><span class="n">LeftParen</span><span class="p">,</span><span class="w">       </span><span class="c1">// (</span>
<span class="w">    </span><span class="n">RightParen</span><span class="p">,</span><span class="w">      </span><span class="c1">// )</span>
<span class="w">    </span><span class="n">LeftBracket</span><span class="p">,</span><span class="w">     </span><span class="c1">// [</span>
<span class="w">    </span><span class="n">RightBracket</span><span class="p">,</span><span class="w">    </span><span class="c1">// ]</span>

<span class="w">    </span><span class="c1">// 特殊</span>
<span class="w">    </span><span class="n">Comment</span><span class="p">,</span><span class="w">         </span><span class="c1">// // または /* */</span>
<span class="w">    </span><span class="n">Newline</span><span class="p">,</span><span class="w">         </span><span class="c1">// 改行</span>
<span class="w">    </span><span class="n">Eof</span><span class="p">,</span><span class="w">             </span><span class="c1">// ファイル終端</span>
<span class="w">    </span><span class="n">Invalid</span><span class="w">          </span><span class="c1">// エラートークン</span>
<span class="p">};</span>
</code></pre></div>

<h4 id="212">2.1.2 コメント</h4>
<div class="codehilite"><pre><span></span><code><span class="c1">// 行コメント（行末まで）</span>

<span class="o">/*</span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span>ブロックコメント
<span class="w"> </span><span class="o">*</span><span class="w"> </span>複数行対応
<span class="w"> </span><span class="o">*/</span>
</code></pre></div>

<h4 id="213">2.1.3 文字列リテラル</h4>
<div class="codehilite"><pre><span></span><code><span class="c1">// 基本文字列</span>
<span class="s">&quot;Hello, World&quot;</span>

<span class="c1">// SakuraScript埋め込み</span>
<span class="s">&quot;\0\s[0]こんにちは\e&quot;</span>

<span class="c1">// エスケープシーケンス</span>
<span class="s">&quot;改行\n タブ\t クォート\&quot;</span><span class="w"> </span>バックスラッシュ<span class="o">\\</span>&quot;
</code></pre></div>

<p><strong>エスケープ処理</strong>:
- <code>\n</code> → LF (0x0A)
- <code>\t</code> → TAB (0x09)
- <code>\"</code> → <code>"</code>
- <code>\\</code> → <code>\</code>
- その他 → そのまま（SakuraScript互換）</p>
<h3 id="22">2.2 データ型</h3>
<h4 id="221">2.2.1 基本型</h4>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Value</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="k">enum</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Type</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Void</span><span class="p">,</span><span class="w">       </span><span class="c1">// 未初期化・戻り値なし</span>
<span class="w">        </span><span class="n">Integer</span><span class="p">,</span><span class="w">    </span><span class="c1">// 整数（int64_t）</span>
<span class="w">        </span><span class="n">Float</span><span class="p">,</span><span class="w">      </span><span class="c1">// 浮動小数点（double）</span>
<span class="w">        </span><span class="n">String</span><span class="p">,</span><span class="w">     </span><span class="c1">// 文字列（std::string, UTF-8）</span>
<span class="w">        </span><span class="n">Array</span><span class="p">,</span><span class="w">      </span><span class="c1">// 配列（std::vector&lt;Value&gt;）</span>
<span class="w">        </span><span class="n">Dict</span><span class="w">        </span><span class="c1">// 連想配列（std::map&lt;std::string, Value&gt;）</span>
<span class="w">    </span><span class="p">};</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="n">Type</span><span class="w"> </span><span class="n">type_</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">variant</span><span class="o">&lt;</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">monostate</span><span class="p">,</span><span class="w">              </span><span class="c1">// Void</span>
<span class="w">        </span><span class="kt">int64_t</span><span class="p">,</span><span class="w">                     </span><span class="c1">// Integer</span>
<span class="w">        </span><span class="kt">double</span><span class="p">,</span><span class="w">                      </span><span class="c1">// Float</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w">                 </span><span class="c1">// String</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;</span><span class="p">,</span><span class="w">          </span><span class="c1">// Array</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="o">&gt;</span><span class="w"> </span><span class="c1">// Dict</span>
<span class="w">    </span><span class="o">&gt;</span><span class="w"> </span><span class="n">data_</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>

<h4 id="222">2.2.2 型変換規則</h4>
<p><strong>暗黙的変換</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="o">//</span><span class="w"> </span><span class="err">数値</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="err">文字列（算術演算外の文脈）</span>
<span class="n">_var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">123</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;abc&quot;</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="s2">&quot;123abc&quot;</span>

<span class="o">//</span><span class="w"> </span><span class="err">文字列</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="err">数値（算術演算）</span>
<span class="n">_num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;123&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">456</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="mi">579</span>

<span class="o">//</span><span class="w"> </span><span class="err">論理値（真偽判定）</span>
<span class="o">//</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="err">整数</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">false</span><span class="p">,</span><span class="w"> </span><span class="err">非</span><span class="mi">0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">true</span>
<span class="o">//</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="err">文字列</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">false</span><span class="p">,</span><span class="w"> </span><span class="err">非空</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">true</span>
<span class="o">//</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="err">配列</span><span class="p">:</span><span class="w"> </span><span class="err">空</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">false</span><span class="p">,</span><span class="w"> </span><span class="err">非空</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">true</span>
</code></pre></div>

<h3 id="23">2.3 式と文</h3>
<h4 id="231-expressions">2.3.1 式（Expressions）</h4>
<div class="codehilite"><pre><span></span><code><span class="c1">// 算術式</span>
<span class="n">_result</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">(</span><span class="mi">10</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span>

<span class="c1">// 比較式</span>
<span class="n">_is_greater</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_a</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">_b</span>

<span class="c1">// 論理式</span>
<span class="n">_both</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">(</span><span class="n">_a</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">_b</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span>

<span class="c1">// 三項演算子</span>
<span class="n">_value</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_condition</span><span class="w"> </span>?<span class="w"> </span><span class="s">&quot;yes&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s">&quot;no&quot;</span>

<span class="c1">// 文字列連結</span>
<span class="n">_greeting</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;Hello, &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">_name</span>

<span class="c1">// 配列アクセス</span>
<span class="n">_item</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1">// 関数呼び出し</span>
<span class="n">_random</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">RAND</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</code></pre></div>

<h4 id="232-statements">2.3.2 文（Statements）</h4>
<div class="codehilite"><pre><span></span><code><span class="o">//</span><span class="w"> </span><span class="err">代入文</span>
<span class="n">_var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">123</span>

<span class="o">//</span><span class="w"> </span><span class="err">条件分岐</span>
<span class="k">if</span><span class="w"> </span><span class="n">_condition</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="err">真の場合</span>
<span class="p">}</span>
<span class="n">elseif</span><span class="w"> </span><span class="n">_another</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="err">別の条件</span>
<span class="p">}</span>
<span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="err">それ以外</span>
<span class="p">}</span>

<span class="o">//</span><span class="w"> </span><span class="n">when文</span><span class="err">（値による分岐）</span>
<span class="n">when</span><span class="w"> </span><span class="n">_value</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;one&quot;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="mi">2</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;two&quot;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="n">others</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;many&quot;</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>

<span class="o">//</span><span class="w"> </span><span class="n">while文</span>
<span class="k">while</span><span class="w"> </span><span class="n">_count</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">_count</span><span class="o">++</span>
<span class="p">}</span>

<span class="o">//</span><span class="w"> </span><span class="n">foreach文</span>
<span class="n">foreach</span><span class="w"> </span><span class="n">_array</span><span class="p">;</span><span class="w"> </span><span class="n">_item</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="n">_itemで各要素にアクセス</span>
<span class="p">}</span>

<span class="o">//</span><span class="w"> </span><span class="k">break</span><span class="o">/</span><span class="k">continue</span>
<span class="k">break</span>
<span class="k">continue</span>

<span class="o">//</span><span class="w"> </span><span class="k">return</span><span class="err">（関数終了・戻り値）</span>
<span class="k">return</span><span class="w"> </span><span class="n">_result</span>
</code></pre></div>

<h3 id="24">2.4 関数定義</h3>
<h4 id="241">2.4.1 基本構文</h4>
<div class="codehilite"><pre><span></span><code><span class="c1">// 関数定義</span>
<span class="n">FunctionName</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 処理</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;result&quot;</span>
<span class="p">}</span>

<span class="c1">// 引数なし関数</span>
<span class="n">OnBoot</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s">&quot;\0\s[0]起動しました\e&quot;</span>
<span class="p">}</span>

<span class="c1">// 引数あり関数（暗黙的パラメータ）</span>
<span class="n">OnMouseClick</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// reference[0], reference[1], ... で引数アクセス</span>
<span class="w">    </span><span class="n">when</span><span class="w"> </span><span class="n">reference</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s">&quot;\0\s[0]さくらがクリックされました&quot;</span><span class="w"> </span><span class="p">}</span>
<span class="w">        </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s">&quot;\1\s[10]うにゅうがクリックされました&quot;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="242">2.4.2 組み込み変数</h4>
<p><strong>SHIORI固有</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">reference</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="w">     </span><span class="o">//</span><span class="w"> </span><span class="n">第1引数</span>
<span class="n">reference</span><span class="o">[</span><span class="n">1</span><span class="o">]</span><span class="w">     </span><span class="o">//</span><span class="w"> </span><span class="n">第2引数</span>
<span class="n">reference</span><span class="o">[</span><span class="n">n</span><span class="o">]</span><span class="w">     </span><span class="o">//</span><span class="w"> </span><span class="n">第n</span><span class="o">+</span><span class="mi">1</span><span class="n">引数</span>

<span class="n">charset</span><span class="w">          </span><span class="o">//</span><span class="w"> </span><span class="n">文字コード</span><span class="err">（</span><span class="ss">&quot;UTF-8&quot;</span><span class="w"> </span><span class="n">など</span><span class="err">）</span>
<span class="n">sender</span><span class="w">           </span><span class="o">//</span><span class="w"> </span><span class="n">送信元</span><span class="err">（</span><span class="ss">&quot;Ourin&quot;</span><span class="w"> </span><span class="n">など</span><span class="err">）</span>
</code></pre></div>

<p><strong>システム変数</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="o">//</span><span class="w"> </span><span class="n">実装予定</span>
<span class="n">_argc</span><span class="w">            </span><span class="o">//</span><span class="w"> </span><span class="n">引数の数</span>
<span class="n">_argv</span><span class="o">[</span><span class="n">n</span><span class="o">]</span><span class="w">         </span><span class="o">//</span><span class="w"> </span><span class="n">引数配列</span><span class="err">（</span><span class="n">reference</span><span class="err">[]</span><span class="n">のエイリアス</span><span class="err">）</span>
</code></pre></div>

<h3 id="25">2.5 組み込み関数</h3>
<h4 id="251-phase-1">2.5.1 Phase 1 必須関数</h4>
<p><strong>乱数</strong>:</p>
<div class="codehilite"><pre><span></span><code>RAND(max)        // 0 〜 max-1 の整数乱数
</code></pre></div>

<p><strong>文字列操作</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">STRLEN</span><span class="p">(</span><span class="nf">str</span><span class="p">)</span><span class="w">      </span><span class="o">//</span><span class="w"> </span><span class="n">文字列長</span><span class="err">（</span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span><span class="n">文字数</span><span class="err">）</span>
<span class="n">STRSTR</span><span class="p">(</span><span class="n">hay</span><span class="p">,</span><span class="w"> </span><span class="n">needle</span><span class="p">,</span><span class="w"> </span><span class="o">[</span><span class="n">start</span><span class="o">]</span><span class="p">)</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n">部分文字列検索</span><span class="err">（</span><span class="n">位置返却</span><span class="err">、</span><span class="o">-</span><span class="mi">1</span><span class="o">=</span><span class="n">未発見</span><span class="err">、</span><span class="n">start省略可</span><span class="err">）</span>
<span class="n">SUBSTR</span><span class="p">(</span><span class="nf">str</span><span class="p">,</span><span class="w"> </span><span class="k">start</span><span class="p">,</span><span class="w"> </span><span class="nf">len</span><span class="p">)</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n">部分文字列取得</span>
<span class="n">TOUPPER</span><span class="p">(</span><span class="nf">str</span><span class="p">)</span><span class="w">     </span><span class="o">//</span><span class="w"> </span><span class="n">大文字化</span>
<span class="n">TOLOWER</span><span class="p">(</span><span class="nf">str</span><span class="p">)</span><span class="w">     </span><span class="o">//</span><span class="w"> </span><span class="n">小文字化</span>
</code></pre></div>

<p><strong>配列操作</strong>:</p>
<div class="codehilite"><pre><span></span><code>ARRAYSIZE(arr)   // 配列サイズ
IARRAY           // 空配列作成
</code></pre></div>

<p><strong>型変換</strong>:</p>
<div class="codehilite"><pre><span></span><code>TOINT(val)       // 整数化
TOSTR(val)       // 文字列化
</code></pre></div>

<p><strong>判定</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">ISVAR</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="w">   </span><span class="o">//</span><span class="w"> </span><span class="err">変数が定義済みか</span>
<span class="n">ISFUNC</span><span class="p">(</span><span class="n">funcname</span><span class="p">)</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="err">関数が定義済みか</span>
</code></pre></div>

<h4 id="252-phase-2">2.5.2 Phase 2 拡張関数</h4>
<p><strong>正規表現</strong>:</p>
<div class="codehilite"><pre><span></span><code>RE_MATCH(str, pattern)     // マッチ判定
RE_SEARCH(str, pattern)    // マッチ位置
RE_REPLACE(str, pattern, replacement)  // 置換
</code></pre></div>

<p><strong>日時</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="k">GETTIME</span>[<span class="mi">0</span>]<span class="w">       </span><span class="o">//</span><span class="w"> </span>年
<span class="k">GETTIME</span>[<span class="mi">1</span>]<span class="w">       </span><span class="o">//</span><span class="w"> </span>月
<span class="k">GETTIME</span>[<span class="mi">2</span>]<span class="w">       </span><span class="o">//</span><span class="w"> </span>日
<span class="k">GETTIME</span>[<span class="mi">3</span>]<span class="w">       </span><span class="o">//</span><span class="w"> </span>時
<span class="k">GETTIME</span>[<span class="mi">4</span>]<span class="w">       </span><span class="o">//</span><span class="w"> </span>分
<span class="k">GETTIME</span>[<span class="mi">5</span>]<span class="w">       </span><span class="o">//</span><span class="w"> </span>秒
</code></pre></div>

<p><strong>ファイル操作</strong>:</p>
<div class="codehilite"><pre><span></span><code>FOPEN(path, mode)
FREAD(handle)
FWRITE(handle, data)
FCLOSE(handle)
</code></pre></div>

<hr />
<h2 id="3">3. アーキテクチャ詳細</h2>
<h3 id="31">3.1 クラス構成</h3>
<div class="codehilite"><pre><span></span><code>yaya_core/src/
├── main.cpp                    # エントリポイント
├── YayaCore.{cpp,hpp}          # コントローラー
├── DictionaryManager.{cpp,hpp} # 辞書管理
├── Lexer.{cpp,hpp}             # 字句解析
├── Parser.{cpp,hpp}            # 構文解析
├── AST.{cpp,hpp}               # 抽象構文木
├── VM.{cpp,hpp}                # 仮想マシン
├── Value.{cpp,hpp}             # 値型
├── FunctionRegistry.{cpp,hpp}  # 関数テーブル
├── VariableStore.{cpp,hpp}     # 変数ストレージ
├── BuiltinFunctions.{cpp,hpp}  # 組み込み関数
├── ShioriAdapter.{cpp,hpp}     # SHIORI変換
└── Utils.{cpp,hpp}             # ユーティリティ
</code></pre></div>

<h3 id="32-lexer">3.2 字句解析器（Lexer）</h3>
<h4 id="321">3.2.1 責務</h4>
<ul>
<li>ファイル読み込み（UTF-8/CP932自動検出）</li>
<li>トークン列への分割</li>
<li>コメント除去</li>
<li>エラー位置記録</li>
</ul>
<h4 id="322">3.2.2 インターフェース</h4>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Lexer</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="k">explicit</span><span class="w"> </span><span class="n">Lexer</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">source</span><span class="p">);</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Token</span><span class="o">&gt;</span><span class="w"> </span><span class="n">tokenize</span><span class="p">();</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">source_</span><span class="p">;</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">pos_</span><span class="p">;</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">line_</span><span class="p">;</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">column_</span><span class="p">;</span>

<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="nf">peek</span><span class="p">();</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="nf">advance</span><span class="p">();</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="nf">match</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="n">expected</span><span class="p">);</span>

<span class="w">    </span><span class="n">Token</span><span class="w"> </span><span class="nf">makeToken</span><span class="p">(</span><span class="n">TokenType</span><span class="w"> </span><span class="n">type</span><span class="p">);</span>
<span class="w">    </span><span class="n">Token</span><span class="w"> </span><span class="nf">makeString</span><span class="p">();</span>
<span class="w">    </span><span class="n">Token</span><span class="w"> </span><span class="nf">makeNumber</span><span class="p">();</span>
<span class="w">    </span><span class="n">Token</span><span class="w"> </span><span class="nf">makeIdentifier</span><span class="p">();</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">skipWhitespace</span><span class="p">();</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">skipLineComment</span><span class="p">();</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">skipBlockComment</span><span class="p">();</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="33-parser">3.3 構文解析器（Parser）</h3>
<h4 id="331-bnf">3.3.1 文法（簡略版BNF）</h4>
<div class="codehilite"><pre><span></span><code><span class="nv">Program</span><span class="w">       </span><span class="o">:=</span><span class="w"> </span><span class="nv">FunctionDef</span><span class="o">*</span>
<span class="nv">FunctionDef</span><span class="w">   </span><span class="o">:=</span><span class="w"> </span><span class="nv">Identifier</span><span class="w"> </span><span class="o">&#39;</span><span class="p">{</span><span class="o">&#39;</span><span class="w"> </span><span class="nv">Statement</span><span class="o">*</span><span class="w"> </span><span class="o">&#39;</span><span class="p">}</span><span class="o">&#39;</span>
<span class="nv">Statement</span><span class="w">     </span><span class="o">:=</span><span class="w"> </span><span class="nv">IfStmt</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nv">WhileStmt</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nv">ForEachStmt</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nv">ReturnStmt</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nv">ExprStmt</span>
<span class="nv">IfStmt</span><span class="w">        </span><span class="o">:=</span><span class="w"> </span><span class="o">&#39;</span><span class="k">if</span><span class="o">&#39;</span><span class="w"> </span><span class="nv">Expression</span><span class="w"> </span><span class="o">&#39;</span><span class="p">{</span><span class="o">&#39;</span><span class="w"> </span><span class="nv">Statement</span><span class="o">*</span><span class="w"> </span><span class="o">&#39;</span><span class="p">}</span><span class="o">&#39;</span><span class="w"> </span><span class="nv">ElseClause</span>?
<span class="nv">ElseClause</span><span class="w">    </span><span class="o">:=</span><span class="w"> </span><span class="o">&#39;</span><span class="k">else</span><span class="o">&#39;</span><span class="w"> </span><span class="p">(</span><span class="nv">IfStmt</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">&#39;</span><span class="p">{</span><span class="o">&#39;</span><span class="w"> </span><span class="nv">Statement</span><span class="o">*</span><span class="w"> </span><span class="o">&#39;</span><span class="p">}</span><span class="o">&#39;</span><span class="p">)</span>
<span class="nv">WhileStmt</span><span class="w">     </span><span class="o">:=</span><span class="w"> </span><span class="o">&#39;</span><span class="k">while</span><span class="o">&#39;</span><span class="w"> </span><span class="nv">Expression</span><span class="w"> </span><span class="o">&#39;</span><span class="p">{</span><span class="o">&#39;</span><span class="w"> </span><span class="nv">Statement</span><span class="o">*</span><span class="w"> </span><span class="o">&#39;</span><span class="p">}</span><span class="o">&#39;</span>
<span class="nv">ForEachStmt</span><span class="w">   </span><span class="o">:=</span><span class="w"> </span><span class="o">&#39;</span><span class="k">for</span><span class="nv">each</span><span class="o">&#39;</span><span class="w"> </span><span class="nv">Expression</span><span class="w"> </span><span class="o">&#39;</span><span class="p">;</span><span class="o">&#39;</span><span class="w"> </span><span class="nv">Identifier</span><span class="w"> </span><span class="o">&#39;</span><span class="p">{</span><span class="o">&#39;</span><span class="w"> </span><span class="nv">Statement</span><span class="o">*</span><span class="w"> </span><span class="o">&#39;</span><span class="p">}</span><span class="o">&#39;</span>
<span class="nv">ReturnStmt</span><span class="w">    </span><span class="o">:=</span><span class="w"> </span><span class="o">&#39;</span><span class="nv">return</span><span class="o">&#39;</span><span class="w"> </span><span class="nv">Expression</span>?
<span class="nv">ExprStmt</span><span class="w">      </span><span class="o">:=</span><span class="w"> </span><span class="nv">Expression</span>

<span class="nv">Expression</span><span class="w">    </span><span class="o">:=</span><span class="w"> </span><span class="nv">Assignment</span>
<span class="nv">Assignment</span><span class="w">    </span><span class="o">:=</span><span class="w"> </span><span class="nf">Ternary</span><span class="w"> </span><span class="p">(</span><span class="o">&#39;=&#39;</span><span class="w"> </span><span class="nv">Assignment</span><span class="p">)</span>?
<span class="nv">Ternary</span><span class="w">       </span><span class="o">:=</span><span class="w"> </span><span class="nf">LogicalOr</span><span class="w"> </span><span class="p">(</span><span class="o">&#39;</span>?<span class="o">&#39;</span><span class="w"> </span><span class="nv">Expression</span><span class="w"> </span><span class="o">&#39;:&#39;</span><span class="w"> </span><span class="nv">Ternary</span><span class="p">)</span>?
<span class="nv">LogicalOr</span><span class="w">     </span><span class="o">:=</span><span class="w"> </span><span class="nf">LogicalAnd</span><span class="w"> </span><span class="p">(</span><span class="o">&#39;||&#39;</span><span class="w"> </span><span class="nv">LogicalAnd</span><span class="p">)</span><span class="o">*</span>
<span class="nv">LogicalAnd</span><span class="w">    </span><span class="o">:=</span><span class="w"> </span><span class="nf">Equality</span><span class="w"> </span><span class="p">(</span><span class="o">&#39;</span>&amp;&amp;<span class="o">&#39;</span><span class="w"> </span><span class="nv">Equality</span><span class="p">)</span><span class="o">*</span>
<span class="nv">Equality</span><span class="w">      </span><span class="o">:=</span><span class="w"> </span><span class="nf">Relational</span><span class="w"> </span><span class="p">((</span><span class="o">&#39;==&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">&#39;!=&#39;</span><span class="p">)</span><span class="w"> </span><span class="nv">Relational</span><span class="p">)</span><span class="o">*</span>
<span class="nv">Relational</span><span class="w">    </span><span class="o">:=</span><span class="w"> </span><span class="nf">Additive</span><span class="w"> </span><span class="p">((</span><span class="o">&#39;&lt;&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">&#39;&gt;&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">&#39;&lt;=&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">&#39;&gt;=&#39;</span><span class="p">)</span><span class="w"> </span><span class="nv">Additive</span><span class="p">)</span><span class="o">*</span>
<span class="nv">Additive</span><span class="w">      </span><span class="o">:=</span><span class="w"> </span><span class="nf">Multiplicative</span><span class="w"> </span><span class="p">((</span><span class="o">&#39;+&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">&#39;-&#39;</span><span class="p">)</span><span class="w"> </span><span class="nv">Multiplicative</span><span class="p">)</span><span class="o">*</span>
<span class="nv">Multiplicative</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">Unary</span><span class="w"> </span><span class="p">((</span><span class="o">&#39;*&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">&#39;/&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">&#39;</span><span class="nv">%</span><span class="o">&#39;</span><span class="p">)</span><span class="w"> </span><span class="nv">Unary</span><span class="p">)</span><span class="o">*</span>
<span class="nv">Unary</span><span class="w">         </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="o">&#39;!&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">&#39;-&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">&#39;++&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">&#39;--&#39;</span><span class="p">)</span><span class="w"> </span><span class="nv">Unary</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nv">Postfix</span>
<span class="nv">Postfix</span><span class="w">       </span><span class="o">:=</span><span class="w"> </span><span class="nf">Primary</span><span class="w"> </span><span class="p">(</span><span class="o">&#39;++&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">&#39;--&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">&#39;</span><span class="p">[</span><span class="o">&#39;</span><span class="w"> </span><span class="nv">Expression</span><span class="w"> </span><span class="o">&#39;</span><span class="p">]</span><span class="o">&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="o">&#39;</span><span class="w"> </span><span class="nv">ArgList</span>?<span class="w"> </span><span class="o">&#39;</span><span class="p">)</span><span class="o">&#39;</span><span class="p">)</span><span class="o">*</span>
<span class="nv">Primary</span><span class="w">       </span><span class="o">:=</span><span class="w"> </span><span class="nv">Identifier</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nv">Number</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nv">String</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="o">&#39;</span><span class="w"> </span><span class="nv">Expression</span><span class="w"> </span><span class="o">&#39;</span><span class="p">)</span><span class="o">&#39;</span>

<span class="nv">ArgList</span><span class="w">       </span><span class="o">:=</span><span class="w"> </span><span class="nf">Expression</span><span class="w"> </span><span class="p">(</span><span class="o">&#39;</span><span class="p">,</span><span class="o">&#39;</span><span class="w"> </span><span class="nv">Expression</span><span class="p">)</span><span class="o">*</span>
</code></pre></div>

<h4 id="332-ast">3.3.2 抽象構文木（AST）</h4>
<div class="codehilite"><pre><span></span><code><span class="c1">// 基底クラス</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ASTNode</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="o">~</span><span class="n">ASTNode</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">default</span><span class="p">;</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="n">VM</span><span class="o">&amp;</span><span class="w"> </span><span class="n">vm</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// 式ノード</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ExpressionNode</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">ASTNode</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* ... */</span><span class="w"> </span><span class="p">};</span>
<span class="k">class</span><span class="w"> </span><span class="nc">BinaryOpNode</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">ExpressionNode</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* ... */</span><span class="w"> </span><span class="p">};</span>
<span class="k">class</span><span class="w"> </span><span class="nc">UnaryOpNode</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">ExpressionNode</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* ... */</span><span class="w"> </span><span class="p">};</span>
<span class="k">class</span><span class="w"> </span><span class="nc">LiteralNode</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">ExpressionNode</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* ... */</span><span class="w"> </span><span class="p">};</span>
<span class="k">class</span><span class="w"> </span><span class="nc">IdentifierNode</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">ExpressionNode</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* ... */</span><span class="w"> </span><span class="p">};</span>
<span class="k">class</span><span class="w"> </span><span class="nc">CallNode</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">ExpressionNode</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* ... */</span><span class="w"> </span><span class="p">};</span>

<span class="c1">// 文ノード</span>
<span class="k">class</span><span class="w"> </span><span class="nc">StatementNode</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">ASTNode</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* ... */</span><span class="w"> </span><span class="p">};</span>
<span class="k">class</span><span class="w"> </span><span class="nc">IfStatementNode</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">StatementNode</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* ... */</span><span class="w"> </span><span class="p">};</span>
<span class="k">class</span><span class="w"> </span><span class="nc">WhileStatementNode</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">StatementNode</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* ... */</span><span class="w"> </span><span class="p">};</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ReturnStatementNode</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">StatementNode</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* ... */</span><span class="w"> </span><span class="p">};</span>

<span class="c1">// 関数定義</span>
<span class="k">class</span><span class="w"> </span><span class="nc">FunctionNode</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">ASTNode</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">name</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">StatementNode</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">body</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="34-vm">3.4 仮想マシン（VM）</h3>
<h4 id="341">3.4.1 実行モデル</h4>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">VM</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="n">execute</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FunctionNode</span><span class="o">&amp;</span><span class="w"> </span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">args</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 変数アクセス</span>
<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="nf">getVariable</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">name</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">setVariable</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">Value</span><span class="o">&amp;</span><span class="w"> </span><span class="n">value</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 組み込み関数呼び出し</span>
<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="nf">callBuiltin</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">args</span><span class="p">);</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="n">VariableStore</span><span class="w"> </span><span class="n">variables_</span><span class="p">;</span>
<span class="w">    </span><span class="n">FunctionRegistry</span><span class="w"> </span><span class="n">functions_</span><span class="p">;</span>
<span class="w">    </span><span class="n">BuiltinFunctions</span><span class="w"> </span><span class="n">builtins_</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// 実行スタック（関数呼び出し）</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">CallFrame</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">functionName</span><span class="p">;</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="o">&gt;</span><span class="w"> </span><span class="n">localVars</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">CallFrame</span><span class="o">&gt;</span><span class="w"> </span><span class="n">callStack_</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>

<h4 id="342">3.4.2 実行フロー</h4>
<ol>
<li><strong>関数呼び出し</strong></li>
<li>新しいCallFrameをスタックに積む</li>
<li>ローカル変数スコープ作成</li>
<li>
<p>引数を<code>reference[]</code>に設定</p>
</li>
<li>
<p><strong>文の実行</strong></p>
</li>
<li>ASTノードを再帰的に評価</li>
<li>
<p>変数代入・関数呼び出し処理</p>
</li>
<li>
<p><strong>戻り値処理</strong></p>
</li>
<li><code>return</code>文で明示的に返却</li>
<li>
<p>または関数末尾の式評価結果</p>
</li>
<li>
<p><strong>スタック解放</strong></p>
</li>
<li>CallFrameをpop</li>
<li>ローカル変数破棄</li>
</ol>
<h3 id="35">3.5 変数ストア</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">VariableStore</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="n">get</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">name</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">set</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">Value</span><span class="o">&amp;</span><span class="w"> </span><span class="n">value</span><span class="p">);</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="nf">exists</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">name</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">clear</span><span class="p">();</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="o">&gt;</span><span class="w"> </span><span class="n">globals_</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// スコープ管理（将来拡張）</span>
<span class="p">};</span>
</code></pre></div>

<p><strong>変数命名規則</strong>:
- <code>_var</code>: ローカル変数（関数内）
- <code>var</code>: グローバル変数
- <code>reference[n]</code>: SHIORI引数（読み取り専用）</p>
<h3 id="36-shiori">3.6 SHIORI アダプタ</h3>
<h4 id="361">3.6.1 リクエスト処理</h4>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ShioriAdapter</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">processRequest</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">method</span><span class="p">,</span><span class="w"> </span>
<span class="w">                               </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">id</span><span class="p">,</span>
<span class="w">                               </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">headers</span><span class="p">,</span>
<span class="w">                               </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">references</span><span class="p">);</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="n">VM</span><span class="o">&amp;</span><span class="w"> </span><span class="n">vm_</span><span class="p">;</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">setReferenceVariables</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">refs</span><span class="p">);</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="nf">buildResponse</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Value</span><span class="o">&amp;</span><span class="w"> </span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">status</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div>

<h4 id="362">3.6.2 レスポンス形式</h4>
<p><strong>GET成功時</strong>:</p>
<div class="codehilite"><pre><span></span><code>SHIORI/3.0 200 OK
Charset: UTF-8
Sender: yaya_core

\0\s[0]こんにちは\e
</code></pre></div>

<p><strong>NOTIFY成功時</strong>:</p>
<div class="codehilite"><pre><span></span><code>SHIORI/3.0 204 No Content
Charset: UTF-8
</code></pre></div>

<p><strong>エラー時</strong>:</p>
<div class="codehilite"><pre><span></span><code>SHIORI/3.0 500 Internal Server Error
Charset: UTF-8

Error: Function &#39;Unknown&#39; not found
</code></pre></div>

<hr />
<h2 id="4">4. 文字コード処理</h2>
<h3 id="41">4.1 対応エンコーディング</h3>
<ul>
<li><strong>UTF-8</strong>: 標準（推奨）</li>
<li><strong>CP932</strong> (Shift_JIS): Windows互換</li>
</ul>
<h3 id="42">4.2 自動検出アルゴリズム</h3>
<div class="codehilite"><pre><span></span><code><span class="n">Encoding</span><span class="w"> </span><span class="nf">detectEncoding</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 1. BOMチェック</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hasUtf8Bom</span><span class="p">(</span><span class="n">data</span><span class="p">))</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Encoding</span><span class="o">::</span><span class="n">UTF8</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// 2. UTF-8妥当性検証</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isValidUtf8</span><span class="p">(</span><span class="n">data</span><span class="p">))</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Encoding</span><span class="o">::</span><span class="n">UTF8</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// 3. CP932とみなす（フォールバック）</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Encoding</span><span class="o">::</span><span class="n">CP932</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="43">4.3 変換処理</h3>
<div class="codehilite"><pre><span></span><code><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="nf">convertToUtf8</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">Encoding</span><span class="w"> </span><span class="n">enc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">enc</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Encoding</span><span class="o">::</span><span class="n">UTF8</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// ICU使用</span>
<span class="w">    </span><span class="n">UErrorCode</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">U_ZERO_ERROR</span><span class="p">;</span>
<span class="w">    </span><span class="n">UConverter</span><span class="o">*</span><span class="w"> </span><span class="n">conv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ucnv_open</span><span class="p">(</span><span class="s">&quot;windows-932&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// ... 変換処理</span>
<span class="w">    </span><span class="n">ucnv_close</span><span class="p">(</span><span class="n">conv</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">utf8_result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<hr />
<h2 id="5">5. エラーハンドリング</h2>
<h3 id="51">5.1 エラー種別</h3>
<div class="codehilite"><pre><span></span><code><span class="k">enum</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">ErrorType</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">LexicalError</span><span class="p">,</span><span class="w">    </span><span class="c1">// 字句解析エラー</span>
<span class="w">    </span><span class="n">SyntaxError</span><span class="p">,</span><span class="w">     </span><span class="c1">// 構文エラー</span>
<span class="w">    </span><span class="n">RuntimeError</span><span class="p">,</span><span class="w">    </span><span class="c1">// 実行時エラー</span>
<span class="w">    </span><span class="n">TypeError</span><span class="p">,</span><span class="w">       </span><span class="c1">// 型エラー</span>
<span class="w">    </span><span class="n">NameError</span><span class="p">,</span><span class="w">       </span><span class="c1">// 未定義名</span>
<span class="w">    </span><span class="n">FileError</span><span class="w">        </span><span class="c1">// ファイルI/Oエラー</span>
<span class="p">};</span>

<span class="k">class</span><span class="w"> </span><span class="nc">YayaException</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">exception</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">YayaException</span><span class="p">(</span><span class="n">ErrorType</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span>
<span class="w">                  </span><span class="kt">size_t</span><span class="w"> </span><span class="n">line</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">column</span><span class="p">);</span>

<span class="w">    </span><span class="n">ErrorType</span><span class="w"> </span><span class="nf">type</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="nf">message</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="nf">line</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="nf">column</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="52">5.2 エラー報告</h3>
<p><strong>開発時（詳細）</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Error</span><span class="o">:</span><span class="w"> </span><span class="n">Undefined</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="s1">&#39;_unknown&#39;</span>
<span class="w">  </span><span class="n">at</span><span class="w"> </span><span class="n">line</span><span class="w"> </span><span class="mi">42</span><span class="o">,</span><span class="w"> </span><span class="n">column</span><span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">aya_bootend</span><span class="o">.</span><span class="na">dic</span>

<span class="w">  </span><span class="mi">41</span><span class="o">:</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">_condition</span><span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="mi">42</span><span class="o">:</span><span class="w">     </span><span class="n">_result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_unknown</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">123</span>
<span class="w">                    </span><span class="o">^^^^^^^^^</span>
<span class="w">  </span><span class="mi">43</span><span class="o">:</span><span class="w"> </span><span class="o">}</span>
</code></pre></div>

<p><strong>本番時（簡潔）</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;ok&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">500</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;RuntimeError: Undefined variable &#39;_unknown&#39; (aya_bootend.dic:42)&quot;</span>
<span class="p">}</span>
</code></pre></div>

<hr />
<h2 id="6">6. パフォーマンス最適化</h2>
<h3 id="61">6.1 目標</h3>
<ul>
<li><strong>辞書ロード</strong>: &lt; 500ms (Emily4全体)</li>
<li><strong>関数実行</strong>: &lt; 10ms (OnBoot)</li>
<li><strong>メモリ使用</strong>: &lt; 100MB (辞書ロード後)</li>
</ul>
<h3 id="62">6.2 最適化手法</h3>
<h4 id="621-phase-1">6.2.1 Phase 1（基本）</h4>
<ul>
<li>ASTキャッシュ（再パース不要）</li>
<li>文字列インターン（重複文字列の共有）</li>
<li>関数テーブルのハッシュマップ化</li>
</ul>
<h4 id="622-phase-2">6.2.2 Phase 2（拡張）</h4>
<ul>
<li>バイトコードコンパイル</li>
<li>JIT コンパイル（LLVM使用、将来）</li>
<li>メモリプール</li>
</ul>
<h3 id="63">6.3 プロファイリング</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Instruments（macOS標準）</span>
instruments<span class="w"> </span>-t<span class="w"> </span><span class="s2">&quot;Time Profiler&quot;</span><span class="w"> </span>./yaya_core

<span class="c1"># Valgrind（メモリリーク検出）</span>
valgrind<span class="w"> </span>--leak-check<span class="o">=</span>full<span class="w"> </span>./yaya_core<span class="w"> </span>&lt;<span class="w"> </span>test_input.json
</code></pre></div>

<hr />
<h2 id="7">7. テスト仕様</h2>
<h3 id="71">7.1 ユニットテスト構成</h3>
<div class="codehilite"><pre><span></span><code>yaya_core/tests/
├── lexer_test.cpp
├── parser_test.cpp
├── vm_test.cpp
├── builtin_test.cpp
└── integration_test.cpp
</code></pre></div>

<h3 id="72">7.2 テストケース例</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// Lexerテスト</span>
<span class="n">TEST</span><span class="p">(</span><span class="n">LexerTest</span><span class="p">,</span><span class="w"> </span><span class="n">TokenizeString</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Lexer</span><span class="w"> </span><span class="n">lex</span><span class="p">(</span><span class="sa">R</span><span class="s">&quot;</span><span class="dl">(</span><span class="s">&quot;Hello, World&quot;</span><span class="dl">)</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">tokens</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lex</span><span class="p">.</span><span class="n">tokenize</span><span class="p">();</span>
<span class="w">    </span><span class="n">ASSERT_EQ</span><span class="p">(</span><span class="n">tokens</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w"> </span><span class="c1">// String + EOF</span>
<span class="w">    </span><span class="n">EXPECT_EQ</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">TokenType</span><span class="o">::</span><span class="n">String</span><span class="p">);</span>
<span class="w">    </span><span class="n">EXPECT_EQ</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Hello, World&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Parserテスト</span>
<span class="n">TEST</span><span class="p">(</span><span class="n">ParserTest</span><span class="p">,</span><span class="w"> </span><span class="n">ParseFunctionDefinition</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Parser</span><span class="w"> </span><span class="n">parser</span><span class="p">(</span><span class="s">&quot;OnBoot { </span><span class="se">\&quot;</span><span class="s">test</span><span class="se">\&quot;</span><span class="s"> }&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">ast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parser</span><span class="p">.</span><span class="n">parse</span><span class="p">();</span>
<span class="w">    </span><span class="n">ASSERT_EQ</span><span class="p">(</span><span class="n">ast</span><span class="p">.</span><span class="n">functions</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="n">EXPECT_EQ</span><span class="p">(</span><span class="n">ast</span><span class="p">.</span><span class="n">functions</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;OnBoot&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// VMテスト</span>
<span class="n">TEST</span><span class="p">(</span><span class="n">VMTest</span><span class="p">,</span><span class="w"> </span><span class="n">ExecuteSimpleFunction</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">VM</span><span class="w"> </span><span class="n">vm</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// ... 関数登録</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vm</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;OnBoot&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{});</span>
<span class="w">    </span><span class="n">EXPECT_EQ</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">asString</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\\</span><span class="s">0</span><span class="se">\\</span><span class="s">s[0]test</span><span class="se">\\</span><span class="s">e&quot;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="73">7.3 統合テスト</h3>
<div class="codehilite"><pre><span></span><code><span class="n">TEST</span><span class="p">(</span><span class="n">IntegrationTest</span><span class="p">,</span><span class="w"> </span><span class="n">LoadEmily4</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">DictionaryManager</span><span class="w"> </span><span class="n">dm</span><span class="p">;</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dm</span><span class="p">.</span><span class="n">load</span><span class="p">({</span>
<span class="w">        </span><span class="s">&quot;emily4/ghost/master/aya_bootend.dic&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="c1">// ... 他の辞書</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="s">&quot;utf-8&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">ASSERT_TRUE</span><span class="p">(</span><span class="n">ok</span><span class="p">);</span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dm</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;OnBoot&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{});</span>
<span class="w">    </span><span class="n">EXPECT_FALSE</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">empty</span><span class="p">());</span>
<span class="w">    </span><span class="n">EXPECT_TRUE</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\\</span><span class="s">0</span><span class="se">\\</span><span class="s">s[&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">::</span><span class="n">npos</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<hr />
<h2 id="8">8. ライセンスとクレジット</h2>
<h3 id="81-yaya-core">8.1 YAYA Core ライセンス</h3>
<p><strong>BSD-3-Clause License</strong>（公式YAYA準拠）</p>
<div class="codehilite"><pre><span></span><code>Copyright (c) 2025, Ourin Project
All rights reserved.

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are met:
...
</code></pre></div>

<h3 id="82">8.2 依存ライブラリ</h3>
<ul>
<li><strong>nlohmann/json</strong>: MIT License</li>
<li><strong>ICU</strong>: Unicode License</li>
<li><strong>Google Test</strong>: BSD-3-Clause License</li>
</ul>
<h3 id="83">8.3 参考実装クレジット</h3>
<p>本実装は以下を参考にしています:
- <strong>YAYA (C++)</strong>: https://github.com/YAYA-shiori/yaya-shiori (BSD-3-Clause)
- <strong>yaya-rs (Rust)</strong>: https://github.com/apxxxxxxe/yaya-rs (MIT)</p>
<hr />
<h2 id="9">9. バージョン履歴</h2>
<ul>
<li><strong>1.0</strong> (2025-10-16): 初版作成</li>
</ul>
<hr />
<p><strong>ドキュメント管理</strong><br />
- リポジトリ: https://github.com/eightman999/Ourin
- パス: <code>docs/YAYA_CORE_TECHNICAL_SPEC.md</code></p>
        <div class="footer">
            <p>Generated: 2025-10-23 | <a href="../README_ja-jp.md">Source (MD)</a></p>
        </div>
    </div>
</body>
</html>
