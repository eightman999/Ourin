<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property System Implementation</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", "Hiragino Kaku Gothic ProN", "Hiragino Sans", "游ゴシック", YuGothic, "メイリオ", Meiryo, sans-serif;
            line-height: 1.6;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .content {
            background-color: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .lang-switcher {
            text-align: right;
            margin-bottom: 20px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
        }
        .lang-switcher a {
            margin: 0 5px;
            padding: 5px 15px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 3px;
            text-decoration: none;
            color: #333;
        }
        .lang-switcher a:hover {
            background-color: #e0e0e0;
        }
        .lang-switcher a.active {
            background-color: #0066cc;
            color: white;
            border-color: #0066cc;
        }
        h1 {
            border-bottom: 3px solid #333;
            padding-bottom: 10px;
            color: #333;
        }
        h2 {
            border-bottom: 2px solid #666;
            padding-bottom: 8px;
            margin-top: 30px;
            color: #444;
        }
        h3 {
            margin-top: 25px;
            color: #555;
        }
        code {
            background-color: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: "SF Mono", "Menlo", "Monaco", "Courier New", monospace;
            font-size: 0.9em;
        }
        pre {
            background-color: #f4f4f4;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            border-left: 4px solid #333;
        }
        pre code {
            background-color: transparent;
            padding: 0;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #f8f8f8;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        a {
            color: #0066cc;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
        blockquote {
            border-left: 4px solid #ddd;
            padding-left: 20px;
            margin-left: 0;
            color: #666;
            font-style: italic;
        }
        ul, ol {
            padding-left: 30px;
        }
        li {
            margin: 8px 0;
        }
        hr {
            border: none;
            border-top: 2px solid #ddd;
            margin: 30px 0;
        }
        .footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            text-align: center;
            color: #666;
            font-size: 0.9em;
        }
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #0066cc;
            text-decoration: none;
        }
        .back-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="content">
        <div class="lang-switcher">
            
        </div>
        <div class="back-link">
            <a href="index.html">← Back to Index</a>
        </div>
        <h1 id="property-system-implementation">Property System Implementation</h1>
<h2 id="overview">Overview</h2>
<p>The Property System allows ghost scripts to read and write baseware parameters at runtime, following the ukagaka property system specification. This provides a standardized way for ghosts to access system information, baseware details, and runtime data.</p>
<h2 id="architecture">Architecture</h2>
<h3 id="core-components">Core Components</h3>
<ol>
<li><strong>PropertyProvider Protocol</strong> (<code>PropertyProvider.swift</code>)</li>
<li>Base protocol for all property providers</li>
<li>Supports <code>get(key:)</code> for reading properties</li>
<li>
<p>Supports <code>set(key:value:)</code> for writing properties (optional)</p>
</li>
<li>
<p><strong>PropertyManager</strong> (<code>PropertyManager.swift</code>)</p>
</li>
<li>Central manager that coordinates all property providers</li>
<li>Routes property requests to appropriate providers based on prefix</li>
<li>Supports <code>%property[...]</code> environment variable expansion</li>
</ol>
<h3 id="property-providers">Property Providers</h3>
<h4 id="systempropertyprovider">SystemPropertyProvider</h4>
<p>Provides <code>system.*</code> properties:
- Date/time: <code>system.year</code>, <code>system.month</code>, <code>system.day</code>, <code>system.hour</code>, <code>system.minute</code>, <code>system.second</code>, <code>system.millisecond</code>, <code>system.dayofweek</code>
- Cursor: <code>system.cursor.pos</code>
- OS information: <code>system.os.type</code>, <code>system.os.name</code>, <code>system.os.version</code>, <code>system.os.build</code>
- CPU information: <code>system.cpu.num</code>, <code>system.cpu.vendor</code>, <code>system.cpu.name</code>, <code>system.cpu.clock</code>, <code>system.cpu.features</code>, <code>system.cpu.load</code>
- Memory information: <code>system.memory.phyt</code>, <code>system.memory.phya</code>, <code>system.memory.load</code></p>
<h4 id="basewarepropertyprovider">BasewarePropertyProvider</h4>
<p>Provides <code>baseware.*</code> properties:
- <code>baseware.name</code> - Returns "Ourin"
- <code>baseware.version</code> - Returns application version</p>
<h4 id="ghostpropertyprovider">GhostPropertyProvider</h4>
<p>Provides ghost-related properties for <code>ghostlist.*</code>, <code>activeghostlist.*</code>, and <code>currentghost.*</code>:</p>
<p><strong>Common Properties:</strong>
- <code>name</code>, <code>sakuraname</code>, <code>keroname</code>
- <code>craftmanw</code>, <code>craftmanurl</code>
- <code>path</code>, <code>icon</code>, <code>homeurl</code>
- <code>username</code></p>
<p><strong>ghostlist:</strong>
- <code>ghostlist.count</code> - Number of installed ghosts
- <code>ghostlist.index(n).{property}</code> - Access ghost by index
- <code>ghostlist({name|sakuraname|path}).{property}</code> - Access ghost by identifier</p>
<p><strong>currentghost:</strong>
- Basic properties as above
- <code>currentghost.status</code> - Ghost status
- <code>currentghost.shelllist.count</code> - Number of shells
- <code>currentghost.shelllist.current.{property}</code> - Current shell properties
- <code>currentghost.shelllist({name|path}).{property}</code> - Shell by identifier
- <code>currentghost.shelllist.index(n).{property}</code> - Shell by index
- <code>currentghost.scope.count</code> - Number of scopes
- <code>currentghost.scope(n).surface.num</code> - Surface number for scope
- <code>currentghost.scope(n).{x|y|rect|name}</code> - Scope position and info</p>
<p><strong>Shell Properties:</strong>
- <code>name</code>, <code>path</code>, <code>menu</code> (hidden/empty)</p>
<p><strong>Scope Properties:</strong>
- <code>surface.num</code>, <code>surface.x</code>, <code>surface.y</code>
- <code>x</code>, <code>y</code>, <code>rect</code>
- <code>name</code>, <code>seriko.defaultsurface</code></p>
<h4 id="balloonpropertyprovider">BalloonPropertyProvider</h4>
<p>Provides balloon-related properties:</p>
<p><strong>balloonlist:</strong>
- <code>balloonlist.count</code>
- <code>balloonlist.index(n).{name|path|craftmanw|craftmanurl}</code>
- <code>balloonlist({name|path}).{property}</code></p>
<p><strong>currentghost.balloon:</strong>
- <code>balloon.scope(n).count</code> - Balloon image count
- <code>balloon.scope(n).num</code> - Balloon ID
- <code>balloon.scope(n).validwidth</code> - Text drawing width
- <code>balloon.scope(n).validheight</code> - Text drawing height
- <code>balloon.scope(n).lines</code> - Maximum lines
- <code>balloon.scope(n).basepos.{x|y}</code> - Text start position
- <code>balloon.scope(n).char_width</code> - Character width</p>
<h4 id="headlinepropertyprovider">HeadlinePropertyProvider</h4>
<p>Provides <code>headlinelist.*</code> properties:
- <code>headlinelist.count</code>
- <code>headlinelist.index(n).{name|path|craftmanw|craftmanurl}</code>
- <code>headlinelist({name|path}).{property}</code></p>
<h4 id="pluginpropertyprovider">PluginPropertyProvider</h4>
<p>Provides <code>pluginlist.*</code> properties:
- <code>pluginlist.count</code>
- <code>pluginlist.index(n).{name|path|id|craftmanw|craftmanurl}</code>
- <code>pluginlist({name|path|id}).{property}</code></p>
<h2 id="usage">Usage</h2>
<h3 id="environment-variable-expansion">Environment Variable Expansion</h3>
<p>In SakuraScript text, use <code>%property[key]</code> to embed property values:</p>
<div class="codehilite"><pre><span></span><code><span class="nf">%property</span><span class="p">[</span><span class="n">baseware</span><span class="p">.</span><span class="n">name</span><span class="p">]</span><span class="w"> </span><span class="n">ver</span><span class="p">,</span><span class="nf">%property</span><span class="p">[</span><span class="n">baseware</span><span class="p">.</span><span class="n">version</span><span class="p">]</span>
</code></pre></div>

<p>This will be expanded to:</p>
<div class="codehilite"><pre><span></span><code>Ourin ver,1.0
</code></pre></div>

<h3 id="sakurascript-tags">SakuraScript Tags</h3>
<h4 id="get-property">Get Property</h4>
<p>Retrieve a property value and trigger a SHIORI event with the value:</p>
<div class="codehilite"><pre><span></span><code>\![get,property,EventName,PropertyKey]
</code></pre></div>

<p>Example:</p>
<div class="codehilite"><pre><span></span><code>\![get,property,OnGetSakuraName,ghostlist(Emily/Phase4.5).keroname]
</code></pre></div>

<p>This will trigger the <code>OnGetSakuraName</code> event with <code>Reference0</code> containing the value "Teddy".</p>
<h4 id="set-property">Set Property</h4>
<p>Set a writable property value:</p>
<div class="codehilite"><pre><span></span><code>\![set,property,PropertyKey,Value]
</code></pre></div>

<p>Example:</p>
<div class="codehilite"><pre><span></span><code>\![set,property,currentghost.shelllist(ULTIMATE FORM).menu,hidden]
</code></pre></div>

<p>This hides the "ULTIMATE FORM" shell from the shell change menu.</p>
<h3 id="programmatic-access">Programmatic Access</h3>
<div class="codehilite"><pre><span></span><code><span class="kd">let</span> <span class="nv">manager</span> <span class="p">=</span> <span class="n">PropertyManager</span><span class="p">()</span>

<span class="c1">// Get property</span>
<span class="k">if</span> <span class="kd">let</span> <span class="nv">year</span> <span class="p">=</span> <span class="n">manager</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="s">&quot;system.year&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Current year: </span><span class="si">\(</span><span class="n">year</span><span class="si">)</span><span class="s">&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Set property</span>
<span class="n">manager</span><span class="p">.</span><span class="kr">set</span><span class="p">(</span><span class="s">&quot;currentghost.shelllist(Default).menu&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="s">&quot;hidden&quot;</span><span class="p">)</span>

<span class="c1">// Expand text with properties</span>
<span class="kd">let</span> <span class="nv">text</span> <span class="p">=</span> <span class="s">&quot;Welcome to %property[baseware.name]!&quot;</span>
<span class="kd">let</span> <span class="nv">expanded</span> <span class="p">=</span> <span class="n">manager</span><span class="p">.</span><span class="n">expand</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="n">text</span><span class="p">)</span>
</code></pre></div>

<h2 id="writable-properties">Writable Properties</h2>
<p>Currently, the following properties support write operations:</p>
<ol>
<li><code>currentghost.shelllist({name}).menu</code> - Set to "hidden" to hide shell from menu</li>
</ol>
<h2 id="integration-points">Integration Points</h2>
<h3 id="ghostmanager">GhostManager</h3>
<p>The <code>GhostManager</code> class handles property-related SakuraScript commands:
- <code>\![get,property,...]</code> at line 408
- <code>\![set,property,...]</code> at line 421</p>
<h3 id="sakurascriptengine">SakuraScriptEngine</h3>
<p>The <code>SakuraScriptEngine</code> integrates with <code>PropertyManager</code>:
- Provides <code>propertyManager</code> property for property access
- Delegates to <code>EnvironmentExpander</code> for <code>%property[...]</code> expansion</p>
<h3 id="environmentexpander">EnvironmentExpander</h3>
<p>Handles <code>%property[key]</code> expansion in text:
- Line 109-111 in <code>EnvironmentExpander.swift</code>
- Delegates to <code>PropertyManager.get()</code></p>
<h2 id="testing">Testing</h2>
<p>Comprehensive tests are provided in <code>PropertySystemTests.swift</code>:
- System properties (date/time, OS info)
- Baseware properties
- Ghost properties (ghostlist, currentghost)
- Property expansion
- Balloon, headline, and plugin properties
- SET functionality</p>
<p>Run tests with:</p>
<div class="codehilite"><pre><span></span><code>xcodebuild<span class="w"> </span><span class="nb">test</span><span class="w"> </span>-project<span class="w"> </span>Ourin.xcodeproj<span class="w"> </span>-scheme<span class="w"> </span>Ourin
</code></pre></div>

<h2 id="future-enhancements">Future Enhancements</h2>
<p>Potential additions for complete specification compliance:</p>
<ol>
<li><strong>History Properties</strong> (<code>history.*</code>)</li>
<li><code>history.ghost.*</code>, <code>history.balloon.*</code>, etc.</li>
<li>
<p>Most recently used items tracking</p>
</li>
<li>
<p><strong>Rate of Use</strong> (<code>rateofuselist.*</code>)</p>
</li>
<li>Ghost usage statistics</li>
<li>Boot time tracking</li>
<li>
<p>Usage percentage calculation</p>
</li>
<li>
<p><strong>Additional Writable Properties</strong></p>
</li>
<li>Mouse cursor customization (<code>currentghost.mousecursor.*</code>)</li>
<li>Tooltip customization (<code>currentghost.seriko.tooltip.*</code>)</li>
<li>
<p>Surface list properties (<code>currentghost.seriko.surfacelist.*</code>)</p>
</li>
<li>
<p><strong>Dynamic Data Integration</strong></p>
</li>
<li>Connect to actual runtime ghost/shell/balloon data</li>
<li>Real-time scope position tracking</li>
<li>Live balloon metrics</li>
</ol>
<h2 id="references">References</h2>
<ul>
<li>UKADOC Property System Specification: https://usada.sakura.vg/contents/specification.html</li>
<li>SSP Property Implementation</li>
<li>CROW Property Test Cases</li>
</ul>
        <div class="footer">
            <p>Generated: 2025-10-23 | <a href="../README_ja-jp.md">Source (MD)</a></p>
        </div>
    </div>
</body>
</html>
