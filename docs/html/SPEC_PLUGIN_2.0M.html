<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLUGIN/2.0M — macOS ネイティブ差分仕様（Draft）</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", "Hiragino Kaku Gothic ProN", "Hiragino Sans", "游ゴシック", YuGothic, "メイリオ", Meiryo, sans-serif;
            line-height: 1.6;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .content {
            background-color: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            border-bottom: 3px solid #333;
            padding-bottom: 10px;
            color: #333;
        }
        h2 {
            border-bottom: 2px solid #666;
            padding-bottom: 8px;
            margin-top: 30px;
            color: #444;
        }
        h3 {
            margin-top: 25px;
            color: #555;
        }
        code {
            background-color: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: "SF Mono", "Menlo", "Monaco", "Courier New", monospace;
            font-size: 0.9em;
        }
        pre {
            background-color: #f4f4f4;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            border-left: 4px solid #333;
        }
        pre code {
            background-color: transparent;
            padding: 0;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #f8f8f8;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        a {
            color: #0066cc;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
        blockquote {
            border-left: 4px solid #ddd;
            padding-left: 20px;
            margin-left: 0;
            color: #666;
            font-style: italic;
        }
        ul, ol {
            padding-left: 30px;
        }
        li {
            margin: 8px 0;
        }
        hr {
            border: none;
            border-top: 2px solid #ddd;
            margin: 30px 0;
        }
        .toc {
            background-color: #f8f8f8;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
        }
        input[type="checkbox"] {
            margin-right: 8px;
        }
        .footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            text-align: center;
            color: #666;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="content">
        <h1 id="plugin20m-macos-draft">PLUGIN/2.0M — macOS ネイティブ差分仕様（Draft）</h1>
<p><strong>Status:</strong> Draft<br />
<strong>Updated:</strong> 2025-07-26<br />
<strong>Audience:</strong> ベースウェア実装者 / プラグイン作者<br />
<strong>Scope:</strong> UKADOC <strong>PLUGIN/2.0</strong> を母体に、macOS ネイティブで運用するための差分を規定<br />
<strong>非目標:</strong> PLUGIN/1.0 DLL のバイナリ互換（※語彙・挙動の互換のみ対象）</p>
<hr />
<h2 id="_1">目次</h2>
<ul>
<li><a href="#1-目的と設計方針">1. 目的と設計方針</a></li>
<li><a href="#2-用語">2. 用語</a></li>
<li><a href="#3-適用範囲と互換性">3. 適用範囲と互換性</a></li>
<li><a href="#4-os--cpu-要件">4. OS / CPU 要件</a></li>
<li><a href="#5-実体バンドル形式">5. 実体（バンドル形式）</a></li>
<li><a href="#6-ワイヤプロトコル20-との差分">6. ワイヤプロトコル（2.0 との差分）</a></li>
<li><a href="#7-apiエクスポート関数メモリ管理">7. API（エクスポート関数・メモリ管理）</a></li>
<li><a href="#8-イベント分岐実装指針">8. イベント分岐（実装指針）</a></li>
<li><a href="#9-設定ファイルdescripttxt差分">9. 設定ファイル（descript.txt）差分</a></li>
<li><a href="#10-セキュリティ安定性xpc隔離推奨">10. セキュリティ/安定性：XPC隔離（推奨）</a></li>
<li><a href="#11-例">11. 例</a></li>
<li><a href="#12-適合チェックリスト">12. 適合チェックリスト</a></li>
<li><a href="#13-既知の差分windows-前提語彙">13. 既知の差分（Windows 前提語彙）</a></li>
<li><a href="#14-付録adll--plugin-ポーティング手順最短">14. 付録A：DLL → .plugin ポーティング手順（最短）</a></li>
<li><a href="#15-付録bビルドレシピxcodecmake">15. 付録B：ビルドレシピ（Xcode/CMake）</a></li>
<li><a href="#16-付録c最小ホストローダswift">16. 付録C：最小ホストローダ（Swift）</a></li>
<li><a href="#17-参照normative--informative">17. 参照（Normative / Informative）</a></li>
</ul>
<hr />
<h2 id="1">1. 目的と設計方針</h2>
<ul>
<li><strong>PLUGIN/2.0</strong> の語彙・プロトコル（<code>GET/NOTIFY PLUGIN/2.x</code>・CRLF区切り・<code>ID/Reference*</code>・<code>Script/ScriptOption</code>・<code>Target</code> など）を維持しつつ、<strong>macOS のネイティブ実体（Bundle/.plugin）</strong>で安全に拡張できるよう差分規定する。  </li>
<li>文字コードは <strong>UTF‑8 を既定</strong>に改め、<strong>JIS 系（Shift_JIS / Windows‑31J）互換</strong>は受理する方針。  </li>
<li><strong>1.0 互換は挙動互換</strong>（語彙・振る舞い）に限り、<strong>バイナリ互換は対象外</strong>。</li>
</ul>
<h2 id="2">2. 用語</h2>
<ul>
<li><strong>2.0M</strong>: 本仕様の版識別子（Mac 差分）。  </li>
<li><strong>ホスト</strong>: ベースウェア本体（プラグインをロードする側）。  </li>
<li><strong>プラグイン</strong>: .plugin/.bundle で配布される拡張。  </li>
<li><strong>ワイヤ</strong>: <code>GET/NOTIFY PLUGIN/2.x</code> のヘッダ文法と往復。</li>
</ul>
<h2 id="3">3. 適用範囲と互換性</h2>
<ul>
<li><strong>PLUGIN/2.0 とワイヤ互換</strong>：行構造（CRLF 区切り/空行終端）、<code>ID</code>/<code>Reference*</code>/<code>Script</code>/<code>ScriptOption</code>/<code>Target</code> の意味論を維持する。  </li>
<li><strong>NOTIFY 強制イベント</strong>では、返したスクリプトは無視される——2.0 と同一解釈。</li>
</ul>
<h2 id="4-os-cpu">4. OS / CPU 要件</h2>
<ul>
<li><strong>最小 OS:</strong> <strong>macOS 10.15（Catalina）以降</strong>（= 32bit 非対応世代）。  </li>
<li><strong>配布形態:</strong> <strong>Universal 2</strong>（<code>arm64 + x86_64</code>）を推奨必須。  </li>
<li><strong>Rosetta 2:</strong> Apple silicon 上で <strong>x86_64 ホストを Rosetta</strong>で動かす場合、<strong>読み込むプラグインも x86_64</strong>で一致させる。</li>
</ul>
<h2 id="5">5. 実体（バンドル形式）</h2>
<ul>
<li>Windows の <strong>DLL</strong> に相当する実体は、macOS では <strong>Loadable Bundle（<code>.plugin</code> / <code>.bundle</code>）</strong> とする。ロードは <strong>CFBundle/Bundle</strong> API を用いる。  </li>
<li>バンドル構造（典型）：
  <code>text
  MyPlugin.plugin/
    Contents/
      Info.plist
      MacOS/MyPlugin      # 実行ファイル（Mach-O, Universal 2）
      Resources/descript.txt</code>
  App バンドル配下の <strong><code>Contents/PlugIns/</code></strong> に配置するのが通例。</li>
</ul>
<h2 id="6-20">6. ワイヤプロトコル（2.0 との差分）</h2>
<ul>
<li><strong>版表記:</strong> 先頭行のプロトコル名は <code>PLUGIN/2.0M</code> を用いる（構文は 2.0 と同形）。  </li>
<li><strong>Charset 既定:</strong> 2.0M では <strong>UTF‑8</strong> を未指定時の既定とする。互換のため <code>Shift_JIS</code> / <code>Windows‑31J</code> 等のラベルを受理する（実体は CP932 相当として扱ってよい）。  </li>
<li><strong>改行・終端:</strong> 2.0 と同じく <strong>CRLF</strong>、<strong>空行でヘッダ終端</strong>。値中の改行等は URL エンコードを推奨（2.0 の慣行に従う）。</li>
</ul>
<h2 id="7-api">7. API（エクスポート関数・メモリ管理）</h2>
<ul>
<li><strong>必須エクスポート（C ABI）</strong>
  <code>c
  int  load (const char* plugin_dir_utf8);
  int  loadu(const char* plugin_dir_utf8);   // UTF-8 パス受領
  void unload(void);
  const unsigned char* request(const unsigned char* buf, size_t len, size_t* out_len);
  /* optional */ void plugin_free(void* p);</code>
  ※ 2.0 の関数構成を C ABI に読み替える（HGLOBAL 等の WinAPI 前提は撤廃）。</li>
<li><strong>メモリ管理</strong>：既定は <strong>呼び出し側（ホスト）でコピー/破棄</strong>。必要なら <code>plugin_free()</code> を任意提供。</li>
</ul>
<h2 id="8">8. イベント分岐（実装指針）</h2>
<ul>
<li>リクエストは <strong>ID ヘッダ</strong>と任意個の <strong>ReferenceN</strong> で表現される（2.0 と同様）。ID ごとに処理を分岐する。  </li>
<li>代表例：</li>
<li><code>ID: version</code> … <code>Value:</code> ヘッダで自プラグインのバージョンを返す。必要なら <code>Charset:</code> をここで宣言。  </li>
<li><code>ID: OnMenuExec</code>（GET） … メニュー選択に応じた <code>Script:</code> を返す。  </li>
<li><code>ID: OnSecondChange</code>（NOTIFY 強制） … スクリプトは返しても処理系で無視され得るため、<code>204 No Content</code> か <code>200 OK</code> のみ返す実装を推奨。  </li>
<li><code>Sender</code>/<code>Target</code> の意味は 2.0 と同一（Sender は起点、Target は返信先）。</li>
</ul>
<h2 id="9-descripttxt">9. 設定ファイル（descript.txt）差分</h2>
<ul>
<li><strong>必須:</strong> <code>name</code> / <code>id</code> / <code>filename</code>（2.0 踏襲）。  </li>
<li><strong>文字コード:</strong> 「旧環境配慮なら Shift_JIS、そうでなければ UTF‑8 推奨」。  </li>
<li><strong>2.0M 追加許容:</strong> <code>filename</code> に <strong><code>.plugin</code> / <code>.bundle</code></strong> を指定可。</li>
</ul>
<h2 id="10-xpc">10. セキュリティ/安定性：XPC隔離（推奨）</h2>
<ul>
<li>不安定/高負荷プラグインは <strong>XPC サービス</strong>として別プロセスに分離し、ホスト↔プラグイン間は<strong>テキスト（ワイヤ文字列）のまま透過転送</strong>する。  </li>
<li>型安全にしたい場合は、<code>request(Data) -&gt; Data</code> 相当のメソッドを持つ <strong>NSXPCConnection</strong> ベースのインターフェースを定義する。  </li>
<li>XPC 隔離は<strong>規格必須ではない</strong>が、クラッシュ隔離・権限最小化の観点から強く推奨。</li>
</ul>
<h2 id="11">11. 例</h2>
<h3 id="111-version-get">11.1 version 問合せ（GET）</h3>
<pre><code>GET PLUGIN/2.0M
ID: version
Charset: UTF-8
Sender: Host
</code></pre>
<pre><code>PLUGIN/2.0M 200 OK
Charset: UTF-8
Value: SamplePlugin 1.0.0
</code></pre>
<h3 id="112-notify-onsecondchange">11.2 NOTIFY 強制イベント（OnSecondChange）</h3>
<pre><code>NOTIFY PLUGIN/2.0M
ID: OnSecondChange
Charset: UTF-8
</code></pre>
<p>（スクリプトを返しても処理系で無視され得る。<code>204 No Content</code> または <code>200 OK</code> のみ推奨）</p>
<h2 id="12-implementation-status">12. 実装状況（Implementation Status）</h2>
<p><strong>更新日:</strong> 2025-10-20</p>
<h3 id="121-ourin">12.1 Ourin ホスト側の実装</h3>
<ul>
<li>[x] <strong>プラグイン検出とロード</strong>: <code>PluginRegistry.swift</code> にて実装済み</li>
<li>[x] <strong>CFBundle ロード</strong>: <code>.plugin</code> および <code>.bundle</code> ファイルのロード機能を実装済み</li>
<li>[x] <strong>descript.txt 解析</strong>: プラグインメタデータの読み取りを実装済み</li>
<li>[x] <strong>文字コード対応</strong>: UTF-8 既定、Shift_JIS/CP932 の自動検出を実装済み</li>
<li>[ ] <strong>PLUGIN/2.0M プロトコル</strong>: ワイヤプロトコルの完全実装は未完了</li>
<li>[ ] <strong>イベントディスパッチ</strong>: <code>PluginEventDispatcher.swift</code> にて基本構造は実装済みだが、完全な PLUGIN/2.0M 互換は未達成</li>
<li>[ ] <strong>XPC 隔離</strong>: 未実装（現在は同一プロセス内で実行）</li>
</ul>
<h3 id="122">12.2 実装済みの機能</h3>
<ol>
<li><strong>プラグイン検出</strong></li>
<li>App バンドル内の <code>Contents/PlugIns/</code> からの検出</li>
<li><code>~/Library/Application Support/Ourin/PlugIns/</code> からの検出</li>
<li>
<p><code>.plugin</code> および <code>.bundle</code> 拡張子のサポート</p>
</li>
<li>
<p><strong>プラグインメタデータ</strong></p>
</li>
<li><code>descript.txt</code> の解析（name, id, filename, secondchange.interval など）</li>
<li>
<p>UTF-8 および Shift_JIS のエンコーディング自動検出</p>
</li>
<li>
<p><strong>ライフサイクル管理</strong></p>
</li>
<li><code>load()</code>/<code>loadu()</code> 関数の呼び出し</li>
<li><code>unload()</code> 関数の呼び出し</li>
<li>プラグインの一括アンロード</li>
</ol>
<h3 id="123">12.3 未実装の機能</h3>
<ol>
<li><strong>完全な PLUGIN/2.0M プロトコル</strong></li>
<li><code>request()</code> 関数の呼び出しとワイヤプロトコル処理</li>
<li><code>ID</code>/<code>Reference*</code>/<code>Script</code>/<code>ScriptOption</code>/<code>Target</code> の完全な実装</li>
<li>
<p>NOTIFY 強制イベントの処理</p>
</li>
<li>
<p><strong>XPC プロセス分離</strong></p>
</li>
<li>プラグインの別プロセス実行</li>
<li>
<p>セキュリティサンドボックス分離</p>
</li>
<li>
<p><strong>高度なイベント処理</strong></p>
</li>
<li>全ての PLUGIN/2.0 イベントタイプの完全サポート</li>
</ol>
<h2 id="13">13. 適合チェックリスト</h2>
<ul>
<li>[ ] <code>PLUGIN/2.0M</code> 行で 2.0 と同構文のワイヤを話せる（未実装）  </li>
<li>[x] 既定 <code>Charset</code> は <strong>UTF‑8</strong>、<code>Shift_JIS</code>/<code>Windows‑31J</code> を受理（実装済み）  </li>
<li>[ ] CRLF/空行終端などの 2.0 仕様に従う（未実装）  </li>
<li>[x] 実体は <strong>.plugin/.bundle</strong>（CFBundle）で Universal 2 を配布（対応済み）  </li>
<li>[x] 最小 OS は <strong>10.15+</strong>（対応済み）</li>
</ul>
<h2 id="14-windows">14. 既知の差分（Windows 前提語彙）</h2>
<ul>
<li><code>HWND</code> 相当のフィールドは macOS では <strong>未使用/0</strong> とする（必要なら将来の UI 連携拡張で定義）。</li>
</ul>
<h2 id="15-adll-plugin">15. 付録A：DLL → .plugin ポーティング手順（最短）</h2>
<p>1) <strong>ターゲットを Bundle（Mach‑O: bundle）</strong> に切替（Xcode）。<strong>Universal 2</strong> を有効化。<br />
2) <strong>エクスポート関数</strong>は <code>request/load(u)/unload</code> を <strong>C ABI</strong> で再掲（<code>__declspec</code> は不要）。<br />
3) <strong>文字コード</strong>は <strong>UTF‑8 既定</strong>、<code>Shift_JIS</code>/<code>Windows‑31J</code> ラベルは <strong>CP932 同等</strong>として受理。<br />
4) <strong>配置</strong>は <code>MyPlugin.plugin/Contents/{MacOS,Resources}</code>。App 側は <code>Contents/PlugIns/</code> からロード。<br />
5) <strong>Rosetta 注意</strong>：x86_64 のみの配布ならホストも x86_64 で実行（Apple silicon では Rosetta）。</p>
<h2 id="16-bxcodecmake">16. 付録B：ビルドレシピ（Xcode/CMake）</h2>
<ul>
<li><strong>Xcode（推奨）</strong></li>
<li>Target: <em>Bundle</em>（Mach‑O Type: <em>Bundle</em>）  </li>
<li>Architectures: <strong>Standard</strong>（<code>arm64</code>/<code>x86_64</code>）＝ Universal 2  </li>
<li>Deployment Target: <code>macOS 10.15</code> 以上  </li>
<li>出力: <code>MyPlugin.plugin</code>（自動で <code>Contents/</code> 構造を生成）</li>
<li><strong>CMake</strong>
  <code>cmake
  set(CMAKE_OSX_ARCHITECTURES "arm64;x86_64")
  add_library(MyPlugin MODULE plugin.c)
  set_target_properties(MyPlugin PROPERTIES BUNDLE TRUE BUNDLE_EXTENSION "plugin" OUTPUT_NAME "MyPlugin")</code></li>
</ul>
<h2 id="17-cswift">17. 付録C：最小ホストローダ（Swift）</h2>
<blockquote>
<p>macOS の <strong>Bundle</strong> API で <code>.plugin</code> をロードし、<code>request</code> 関数にワイヤ文字列（CRLF/空行終端）を渡す最小例。</p>
</blockquote>
<pre><code class="language-swift">import Foundation

typealias ReqFn = @convention(c) (UnsafePointer&lt;UInt8&gt;, Int, UnsafeMutablePointer&lt;Int&gt;) -&gt; UnsafePointer&lt;UInt8&gt;?
typealias LoadFn = @convention(c) (UnsafePointer&lt;CChar&gt;) -&gt; Int32
typealias UnloadFn = @convention(c) () -&gt; Void

struct Plugin {
    let bundle: Bundle
    let request: ReqFn
    let load: LoadFn?
    let unload: UnloadFn?

    init(url: URL) throws {
        guard let bundle = Bundle(url: url) else { throw NSError(domain: &quot;Plugin&quot;, code: -1) }
        self.bundle = bundle
        // Force load the bundle image
        _ = bundle.principalClass
        func sym&lt;T&gt;(_ name: String) -&gt; T? {
            let fp = CFBundleGetFunctionPointerForName(bundle._cfBundle, name as CFString)
            guard fp != nil else { return nil }
            return unsafeBitCast(fp, to: Optional&lt;T&gt;.self)
        }
        guard let req: ReqFn = sym(&quot;request&quot;) else { throw NSError(domain:&quot;Plugin&quot;, code:-2) }
        self.request = req
        self.load = sym(&quot;load&quot;)
        self.unload = sym(&quot;unload&quot;)
    }

    func send(_ text: String) -&gt; String {
        var outLen: Int = 0
        var bytes = Array(text.utf8)
        let respPtr = bytes.withUnsafeMutableBytes { raw -&gt; UnsafePointer&lt;UInt8&gt;? in
            return request(raw.bindMemory(to: UInt8.self).baseAddress!, bytes.count, &amp;outLen)
        }
        guard let p = respPtr else { return &quot;&quot; }
        let buf = UnsafeBufferPointer(start: p, count: outLen)
        return String(decoding: buf, as: UTF8.self)
    }
}

private extension Bundle { var _cfBundle: CFBundle { CFBundleGetBundleWithIdentifier(self.bundleIdentifier! as CFString)! } }
</code></pre>
<h2 id="18-normative-informative">18. 参照（Normative / Informative）</h2>
<ul>
<li>UKADOC: PLUGIN/2.0（リクエスト/レスポンス、CRLF、ID/Reference/Script/Target 等）  </li>
<li>UKADOC: Plugin 設定（descript.txt）  </li>
<li>Apple: CFBundle / Bundle（バンドル実体・ロード）  </li>
<li>Apple: Building a universal macOS binary（Universal 2）  </li>
<li>Apple: 32‑bit 非対応（macOS 10.15+）  </li>
<li>Apple: XPC / XPC Service（プロセス分離）  </li>
<li>WHATWG/MDN: Encoding labels（Shift_JIS / Windows‑31J 等の同義ラベル集合）</li>
</ul>
<blockquote>
<p>注: 本文中の例・定数は説明用。実装では例外処理・境界チェック・SJIS→UTF‑8 変換のエラー処理等を追加すること。</p>
</blockquote>
        <div class="footer">
            <p>Ourin (桜鈴) - macOS ネイティブ伺かベースウェア</p>
        </div>
    </div>
</body>
</html>