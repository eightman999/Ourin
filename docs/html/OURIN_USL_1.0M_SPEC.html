<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", "Hiragino Kaku Gothic ProN", "Hiragino Sans", "游ゴシック", YuGothic, "メイリオ", Meiryo, sans-serif;
            line-height: 1.6;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .content {
            background-color: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            border-bottom: 3px solid #333;
            padding-bottom: 10px;
            color: #333;
        }
        h2 {
            border-bottom: 2px solid #666;
            padding-bottom: 8px;
            margin-top: 30px;
            color: #444;
        }
        h3 {
            margin-top: 25px;
            color: #555;
        }
        code {
            background-color: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: "SF Mono", "Menlo", "Monaco", "Courier New", monospace;
            font-size: 0.9em;
        }
        pre {
            background-color: #f4f4f4;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            border-left: 4px solid #333;
        }
        pre code {
            background-color: transparent;
            padding: 0;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #f8f8f8;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        a {
            color: #0066cc;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
        blockquote {
            border-left: 4px solid #ddd;
            padding-left: 20px;
            margin-left: 0;
            color: #666;
            font-style: italic;
        }
        ul, ol {
            padding-left: 30px;
        }
        li {
            margin: 8px 0;
        }
        hr {
            border: none;
            border-top: 2px solid #ddd;
            margin: 30px 0;
        }
        .toc {
            background-color: #f8f8f8;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
        }
        input[type="checkbox"] {
            margin-right: 8px;
        }
        .footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            text-align: center;
            color: #666;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="content">
        <h1 id="ourin-universalshiori-loader-usl10m-macos-toc">Ourin — Universal‑SHIORI Loader <strong>USL/1.0M</strong> 仕様書（macOS, ToC 付き）</h1>
<p><strong>Status:</strong> Draft<br />
<strong>Updated:</strong> 2025-07-28 (JST)<br />
<strong>Target:</strong> macOS 10.15+（Catalina〜）/ Universal 2（x86_64, arm64）</p>
<blockquote>
<p>目的：Ourin（ベースウェア）が <strong>SHIORI DLL 互換モジュール</strong>（YAYA/AYA/華和梨/美坂など）を macOS で統一的にロード・実行するための“最小で実用的”なローダ規格。<br />
<strong>語彙・挙動は SHIORI/3.x に準拠</strong>し（<code>GET/NOTIFY</code>・CRLF・<code>Charset</code>・<code>Reference*</code> 等）、DLL共通仕様の <strong><code>load(u)/request/unload</code> 3 関数</strong>を呼び出す。</p>
</blockquote>
<hr />
<h2 id="_1">目次</h2>
<ul>
<li><a href="#0-用語">0. 用語</a></li>
<li><a href="#1-適用範囲と非目標">1. 適用範囲と非目標</a></li>
<li><a href="#2-依存規格">2. 依存規格</a></li>
<li><a href="#3-サポートするモジュール形式">3. サポートするモジュール形式</a></li>
<li><a href="#4-エントリポイントと呼出規約">4. エントリポイントと呼出規約</a></li>
<li><a href="#5-リクエストレスポンス規約shiori3x-準拠">5. リクエスト/レスポンス規約（SHIORI/3.x 準拠）</a></li>
<li><a href="#6-文字コード改行">6. 文字コード・改行</a></li>
<li><a href="#7-検索パスと名称正規化">7. 検索パスと名称正規化</a></li>
<li><a href="#8-アーキテクチャ互換universal-rosetta-oop-フォールバック">8. アーキテクチャ互換（Universal/ Rosetta / OOP フォールバック）</a></li>
<li><a href="#9-セキュリティ署名ロード先制限">9. セキュリティ・署名・ロード先制限</a></li>
<li><a href="#10-タイムアウトエラー処理">10. タイムアウト・エラー処理</a></li>
<li><a href="#11-ログと計測">11. ログと計測</a></li>
<li><a href="#12-互換性メモwindows-由来との橋渡し">12. 互換性メモ（Windows 由来との橋渡し）</a></li>
<li><a href="#付録a-usl10m-要求仕様チェックリスト">付録A. USL/1.0M 要求仕様チェックリスト</a></li>
<li><a href="#付録b-サンプル構成典型的な-yaya-ゴースト">付録B. サンプル構成（典型的な YAYA ゴースト）</a></li>
<li><a href="#変更履歴">変更履歴</a></li>
</ul>
<hr />
<h2 id="0">0. 用語</h2>
<ul>
<li><strong>SHIORI/3.x</strong>：<code>GET/NOTIFY</code> とヘッダ群から成るメッセージ規約。  </li>
<li><strong>DLL共通仕様</strong>：<code>load(u)</code> / <code>request</code> / <code>unload</code> の 3 関数とメモリ受け渡し規約。  </li>
<li><strong>USL（Universal‑SHIORI Loader）</strong>：本仕様で定める Ourin のローダ。  </li>
<li><strong>モジュール</strong>：YAYA/AYA/華和梨/美坂などの SHIORI 実装 (<code>*.dylib</code> / <code>*.bundle</code> / <code>*.so</code> 相当)。</li>
</ul>
<h2 id="1">1. 適用範囲と非目標</h2>
<ul>
<li><strong>対象</strong>：macOS ネイティブで SHIORI をロード・実行し、<strong>語彙／挙動互換</strong>を満たすこと。  </li>
<li><strong>非目標</strong>：Windows DLL の<strong>バイナリ互換</strong>。名前やパスの互換吸収は行うが、PE/DLL を直接読み込まない。</li>
</ul>
<h2 id="2">2. 依存規格</h2>
<ul>
<li><strong>SHIORI/3.x</strong>：メッセージフォーマット、<code>Charset</code>、CRLF、末尾空行。  </li>
<li><strong>DLL共通仕様</strong>：<code>loadu</code>（UTF‑8）/<code>load</code>（CP932 等）/<code>request</code>/<code>unload</code> の存在と役割。</li>
</ul>
<h2 id="3">3. サポートするモジュール形式</h2>
<ul>
<li><strong>Mach‑O ダイナミックライブラリ</strong>：<code>*.dylib</code>（推奨）。  </li>
<li><strong>バンドル</strong>：<code>*.bundle</code>（<code>CFBundleExecutable</code> を <code>dlopen</code> 相当で解決）。  </li>
<li><strong>互換名称</strong>：<code>*.so</code> も受理（中身が Mach‑O であること）。  </li>
<li><strong>想定格納</strong>：ゴースト配下 <code>ghost/master/</code> または <code>modules/</code>。アプリバンドル <code>Frameworks/</code> も探索。</li>
</ul>
<h2 id="4">4. エントリポイントと呼出規約</h2>
<h3 id="41">4.1 必須/任意エントリ</h3>
<ul>
<li><strong>必須</strong>：<code>request(h, len) -&gt; HGLOBAL</code>  </li>
<li><strong>任意だが推奨</strong>：<code>loadu(h, len) -&gt; BOOL</code>（UTF‑8 パス）  </li>
<li><strong>任意</strong>：<code>load(h, len) -&gt; BOOL</code>（CP932 等の従来互換）、<code>unload() -&gt; BOOL</code></li>
</ul>
<h3 id="42">4.2 呼出順と引数</h3>
<ol>
<li><strong><code>loadu</code> → <code>load</code> の順で存在検出</strong>。<code>loadu</code> があれば <strong>優先</strong>。  </li>
<li>引数 <code>h</code> は <strong>モジュールのディレクトリパス</strong>。USL は UTF‑8（<code>loadu</code>）/CP932（<code>load</code>）でエンコード済みの <strong>連続バイト列</strong>を渡す。  </li>
<li><strong><code>request</code></strong> には <strong>SHIORI リクエスト全体（CRLF 区切り）</strong>を渡す。戻りはレスポンス全体。  </li>
<li><strong><code>unload</code></strong> はベースウェア終了時に 1 回。</li>
</ol>
<h3 id="43-darwin-usl10m">4.3 Darwin メモリ契約（USL/1.0M 補足）</h3>
<ul>
<li>入力 <code>h</code>/<code>request</code> のバッファは <strong>呼出中のみ有効</strong>（モジュール側は解放しないこと）。  </li>
<li>モジュールが返すレスポンスは <strong>呼出側が <code>free()</code> で解放</strong>できる領域で確保すること（<code>malloc</code> 系）。  </li>
<li>互換のため、USL は <strong>返却文字列を常にコピー</strong>し、モジュール側解放関数があれば呼び出す（将来拡張）。</li>
</ul>
<h2 id="5-shiori3x">5. リクエスト/レスポンス規約（SHIORI/3.x 準拠）</h2>
<ul>
<li>行末は <strong>CR+LF</strong>。末尾は <strong>空行</strong>で終端。  </li>
<li><code>Charset</code> を尊重。<strong>既定 UTF‑8</strong>、<strong>CP932 を受理</strong>。  </li>
<li><code>GET</code> は <code>Value</code> を返す、<code>NOTIFY</code> は <code>Value</code> を無視（<code>Status</code> は通例 <code>204</code> ）。</li>
</ul>
<h2 id="6">6. 文字コード・改行</h2>
<ul>
<li><strong>入出力の既定</strong>：UTF‑8。<code>load</code> 系に限り CP932 も受理。  </li>
<li>SJIS/CP932 を受理した場合、<strong>内部は UTF‑8 正規化</strong>して SHIORI へ渡す/受け取る。</li>
</ul>
<h2 id="7">7. 検索パスと名称正規化</h2>
<h3 id="71">7.1 検索順</h3>
<ol>
<li>ゴースト直下 <code>ghost/master/</code>  </li>
<li>同ディレクトリの <code>modules/</code>  </li>
<li>アプリバンドル <code>Contents/Frameworks/</code>  </li>
<li><code>@rpath</code> / <code>DYLD_*</code> 経路（開発向け）</li>
</ol>
<h3 id="72">7.2 名称正規化（例）</h3>
<ul>
<li><code>yaya.dll</code> → <code>yaya.dylib</code> → <code>libyaya.dylib</code> の順で試行（接頭辞 <code>lib</code>／拡張子差を吸収）。  </li>
<li><code>shiori.dll</code> → <code>shiori.dylib</code>／<code>shiori.bundle</code>。  </li>
<li>ファイル名の <strong>大文字小文字</strong>は厳格に一致させる。</li>
</ul>
<h2 id="8-universal-rosetta-oop">8. アーキテクチャ互換（Universal/ Rosetta / OOP フォールバック）</h2>
<ul>
<li><strong>優先</strong>：<strong>Universal 2</strong>（arm64 + x86_64）なモジュールをロード。  </li>
<li><strong>不一致</strong>（arm64 アプリ ↔ x86_64 モジュール等）：<br />
  1) <strong>同名の別アーキテクチャ版</strong>があれば選択。<br />
  2) それも無い場合、<strong>OOP（Out‑of‑Process）フォールバック</strong>：同梱ヘルパ（XPC/補助アプリ）上でモジュールをロードし、<code>request</code> を IPC で中継。  </li>
<li><strong>Rosetta 依存の強制はしない</strong>（ホストを Rosetta で再起動させないのが原則）。</li>
</ul>
<h2 id="9">9. セキュリティ・署名・ロード先制限</h2>
<ul>
<li>アプリは <strong>公証/署名</strong>済みを前提。モジュールは基本的に <strong>アプリ内（又はユーザ領域）</strong>からのみ読み込み。  </li>
<li>サンドボックス想定時は <strong>XPC サービス</strong>にモジュールロードを委譲可能。  </li>
<li>外部パスや隔離属性のあるバイナリは <strong>読み込みを拒否</strong>し、ユーザに移動/許可を促す。</li>
</ul>
<h2 id="10">10. タイムアウト・エラー処理</h2>
<ul>
<li><code>load(u)</code>/<code>unload</code>：各 10 秒、<code>request</code>：<strong>既定 10 秒</strong>（設定可能）。  </li>
<li>タイムアウト時は <strong>モジュールをアンロード</strong>し、再ロードを試行。連続失敗で無効化。  </li>
<li>代表エラー：<code>NoEntryPoint</code> / <code>BadArch</code> / <code>SignatureInvalid</code> / <code>Timeout</code> / <code>ProtocolError</code>。</li>
</ul>
<h2 id="11">11. ログと計測</h2>
<ul>
<li>ログ：<code>subsystem=jp.ourin.usl</code>、イベント <code>open/close/request/timeout/ipc_fallback</code>。  </li>
<li>計測：平均応答時間・タイムアウト率・クラッシュ回数。</li>
</ul>
<h2 id="12-windows">12. 互換性メモ（Windows 由来との橋渡し）</h2>
<ul>
<li><code>load</code> の第1引数は <strong>モジュールのディレクトリパス</strong>。YAYA/AYA 等の辞書配置はここを基準に解決。  </li>
<li><code>yaya.dll</code> 等の <strong>名称差</strong>は USL が吸収（名称正規化）。  </li>
<li><strong>SJIS辞書</strong>は USL で UTF‑8 化（内部）して SHIORI に渡す。</li>
</ul>
<hr />
<h2 id="a-usl10m">付録A. USL/1.0M 要求仕様チェックリスト</h2>
<ul>
<li>[ ] <code>dlopen</code> / <code>dlsym</code> で <code>request</code> を解決できる  </li>
<li>[ ] <code>loadu</code> があれば UTF‑8 パスで初期化、なければ <code>load</code>（CP932）  </li>
<li>[ ] <code>GET/NOTIFY</code> の応答差を処理（<code>Value</code> の有無）  </li>
<li>[ ] タイムアウト設定を持ち、未応答時に OOP フォールバックが可能  </li>
<li>[ ] arm64/x86_64 の <strong>両対応</strong>（Universal 推奨、OOP で代替可）  </li>
<li>[ ] SJIS/UTF‑8 受理・内部 UTF‑8 正規化  </li>
<li>[ ] CRLF/最終空行の自動付与/検査</li>
</ul>
<h2 id="b-yaya">付録B. サンプル構成（典型的な YAYA ゴースト）</h2>
<pre><code>MyGhost/
  ghost/master/
    descript.txt
    yaya.dylib         ; macOS 版 YAYA（例名）
    yaya.txt           ; 設定
    dic/...
</code></pre>
<p><code>descript.txt: shiori,yaya.dylib</code> を想定。Windows 版は <code>yaya.dll</code>。USL の名称正規化で差を吸収。</p>
<hr />
<h2 id="_2">変更履歴</h2>
<ul>
<li>2025-07-28 (JST): 初版（USL/1.0M）。</li>
</ul>
        <div class="footer">
            <p>Ourin (桜鈴) - macOS ネイティブ伺かベースウェア</p>
        </div>
    </div>
</body>
</html>