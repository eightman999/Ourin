<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHIORI Events — **3.0M / 2.0M 互換（macOS）** 仕様書</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", "Hiragino Kaku Gothic ProN", "Hiragino Sans", "游ゴシック", YuGothic, "メイリオ", Meiryo, sans-serif;
            line-height: 1.6;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .content {
            background-color: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .lang-switcher {
            text-align: right;
            margin-bottom: 20px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
        }
        .lang-switcher a {
            margin: 0 5px;
            padding: 5px 15px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 3px;
            text-decoration: none;
            color: #333;
        }
        .lang-switcher a:hover {
            background-color: #e0e0e0;
        }
        .lang-switcher a.active {
            background-color: #0066cc;
            color: white;
            border-color: #0066cc;
        }
        h1 {
            border-bottom: 3px solid #333;
            padding-bottom: 10px;
            color: #333;
        }
        h2 {
            border-bottom: 2px solid #666;
            padding-bottom: 8px;
            margin-top: 30px;
            color: #444;
        }
        h3 {
            margin-top: 25px;
            color: #555;
        }
        code {
            background-color: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: "SF Mono", "Menlo", "Monaco", "Courier New", monospace;
            font-size: 0.9em;
        }
        pre {
            background-color: #f4f4f4;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            border-left: 4px solid #333;
        }
        pre code {
            background-color: transparent;
            padding: 0;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #f8f8f8;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        a {
            color: #0066cc;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
        blockquote {
            border-left: 4px solid #ddd;
            padding-left: 20px;
            margin-left: 0;
            color: #666;
            font-style: italic;
        }
        ul, ol {
            padding-left: 30px;
        }
        li {
            margin: 8px 0;
        }
        hr {
            border: none;
            border-top: 2px solid #ddd;
            margin: 30px 0;
        }
        .footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            text-align: center;
            color: #666;
            font-size: 0.9em;
        }
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #0066cc;
            text-decoration: none;
        }
        .back-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="content">
        <div class="lang-switcher">
            
        </div>
        <div class="back-link">
            <a href="index.html">← 目次に戻る</a>
        </div>
        <h1 id="shiori-events-30m-20m-macos">SHIORI Events — <strong>3.0M / 2.0M 互換（macOS）</strong> 仕様書</h1>
<p><strong>Status:</strong> Draft / macOS 10.15+ / Universal 2（arm64・x86_64）<br />
<strong>Updated:</strong> 2025-07-27 (JST)<br />
<strong>互換方針:</strong> UKADOC の <strong>SHIORI イベント語彙（3.0/3.1拡張）</strong>を踏襲し、OS 依存の値・通知だけを <strong>macOS ネイティブ API</strong> へ置換。<br />
<strong>文字コード:</strong> 入出力とも UTF‑8 を標準。互換のため <strong>CP932（SJIS）受理 → 内部で UTF‑8 正規化</strong>。<br />
<strong>改行:</strong> <code>LF</code> 推奨（<code>CRLF</code> 受理）。</p>
<hr />
<h2 id="_1">目次</h2>
<ul>
<li><a href="#1-目的と範囲">1. 目的と範囲</a></li>
<li><a href="#2-基本ポリシー互換座標uttype時刻">2. 基本ポリシー（互換/座標/UTType/時刻）</a></li>
<li><a href="#3-イベント分類">3. イベント分類</a></li>
<li><a href="#4-イベント別マッピング表抜粋">4. イベント別マッピング表（抜粋）</a></li>
<li><a href="#41-ライフサイクル">4.1 ライフサイクル</a></li>
<li><a href="#42-入力キーボードマウス">4.2 入力（キーボード/マウス）</a></li>
<li><a href="#43-ドラッグドロップ">4.3 ドラッグ＆ドロップ</a></li>
<li><a href="#44-表示ウィンドウデスクトップ">4.4 表示/ウィンドウ/デスクトップ</a></li>
<li><a href="#45-電源バッテリーサーマル">4.5 電源/バッテリー/サーマル</a></li>
<li><a href="#46-ロケール外観言語">4.6 ロケール/外観/言語</a></li>
<li><a href="#47-weburl-連携">4.7 Web/URL 連携</a></li>
<li><a href="#5-追加定義madd">5. 追加定義（<strong>M‑Add</strong>）</a></li>
<li><a href="#6-パラメータ規定">6. パラメータ規定</a></li>
<li><a href="#7-サンドボックスセキュリティ">7. サンドボックス/セキュリティ</a></li>
<li><a href="#8-互換性の注意と非対応">8. 互換性の注意と非対応</a></li>
<li><a href="#9-仕様例リクエストレスポンス">9. 仕様例（リクエスト/レスポンス）</a></li>
<li><a href="#付録a-代表-api-対応表">付録A: 代表 API 対応表</a></li>
<li><a href="#付録b-テスト観点チェックリスト">付録B: テスト観点チェックリスト</a></li>
</ul>
<hr />
<h2 id="1">1. 目的と範囲</h2>
<ul>
<li>本仕様は、Ourin（ベースウェア, macOS）で <strong>SHIORI イベント</strong>を発火・配送するための<strong>対応表と動作要件</strong>を定義する。  </li>
<li>SSP/UKADOC のイベント名・意味は<strong>語彙互換</strong>で維持し、Windows 固有値は <strong>macOS の等価データ</strong>へ置換または省略（未定義）。</li>
</ul>
<h2 id="2-uttype">2. 基本ポリシー（互換/座標/UTType/時刻）</h2>
<ul>
<li><strong>互換</strong>：既存イベント名・解釈は UKADOC に従う。  </li>
<li><strong>座標系</strong>：イベントで渡すスクリーン座標は <strong>AppKit 既定＝左下原点（pt）</strong>。必要に応じて <strong>トップ左基準の補助値</strong>（<code>TopLeftX/Y</code>）を M‑Add で併送可。  </li>
<li><strong>UTType</strong>：ドラッグ＆ドロップやクリップボードは <strong>NSPasteboard/UTType</strong> を基準とする（<code>public.plain-text</code>/<code>public.url</code>/<code>public.file-url</code> 等）。  </li>
<li><strong>時刻</strong>：ローカル時刻を返却。ミリ秒は <code>Date</code> + <code>mach_absolute_time</code> などで補完可。</li>
</ul>
<h2 id="3">3. イベント分類</h2>
<ul>
<li><strong>ライフサイクル</strong>（起動/終了/切替）  </li>
<li><strong>入力</strong>（キーボード/マウス/ホイール）  </li>
<li><strong>ドラッグ＆ドロップ</strong>（テキスト/URL/ファイル）  </li>
<li><strong>表示/ウィンドウ/デスクトップ</strong>（画面変更/Spaces/スケール）  </li>
<li><strong>電源/バッテリー/サーマル</strong>  </li>
<li><strong>ロケール/外観（テーマ）/言語</strong>  </li>
<li><strong>Web/URL</strong>（x‑ukagaka‑link 等）</li>
</ul>
<hr />
<h2 id="4">4. イベント別マッピング表（抜粋）</h2>
<h3 id="41">4.1 ライフサイクル</h3>
<table>
<thead>
<tr>
<th>SHIORI Event</th>
<th>macOS トリガ</th>
<th>備考</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>OnBoot</code></td>
<td>アプリ起動</td>
<td>Ourin 起動直後</td>
</tr>
<tr>
<td><code>OnClose</code></td>
<td>終了（Terminate）</td>
<td>終了前</td>
</tr>
<tr>
<td><code>OnGhostChanged</code></td>
<td>ゴースト切替</td>
<td>既存語彙準拠</td>
</tr>
<tr>
<td><code>OnIdle</code>/<code>OnMinuteChange</code></td>
<td>タイマー</td>
<td>既存間隔通り</td>
</tr>
</tbody>
</table>
<h3 id="42">4.2 入力（キーボード/マウス）</h3>
<table>
<thead>
<tr>
<th>Event</th>
<th>トリガ</th>
<th>パラメータ例</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>OnKeyDown</code>/<code>OnKeyUp</code>/<code>OnKeyPress</code></td>
<td><code>NSEvent</code>（key）</td>
<td><code>keyCode</code>（US 仮想キー）, <code>characters</code>, <code>modifierFlags</code></td>
</tr>
<tr>
<td><code>OnMouseDown</code>/<code>OnMouseUp</code>/<code>OnMouseMove</code>/<code>OnMouseWheel</code></td>
<td><code>NSEvent</code>（mouse/scroll）</td>
<td><code>screenX/Y</code>（左下原点）, <code>button</code>, <code>delta</code></td>
</tr>
</tbody>
</table>
<h3 id="43">4.3 ドラッグ＆ドロップ</h3>
<table>
<thead>
<tr>
<th>Event</th>
<th>トリガ</th>
<th>パラメータ</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>OnTextDrop</code></td>
<td><code>NSDraggingDestination</code> + <code>UTType.plainText</code></td>
<td><code>Value</code> = テキスト</td>
</tr>
<tr>
<td><code>OnURLDrop</code></td>
<td><code>NSPasteboard.PasteboardType.url</code>/<code>UTType.url</code></td>
<td><code>Value</code> = URL 文字列</td>
</tr>
<tr>
<td><code>OnFileDrop</code></td>
<td><code>public.file-url</code></td>
<td><code>ValueN</code> = ファイル URL 群（セキュリティスコープ考慮）</td>
</tr>
</tbody>
</table>
<h3 id="44">4.4 表示/ウィンドウ/デスクトップ</h3>
<table>
<thead>
<tr>
<th>Event</th>
<th>トリガ</th>
<th>備考</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>OnDisplayChange</code></td>
<td><code>NSApplication.didChangeScreenParametersNotification</code>/CGDisplay</td>
<td>解像度/構成変更</td>
</tr>
<tr>
<td><code>OnResetWindowPos</code></td>
<td>内部</td>
<td>TopLeft 補助可（M‑Add）</td>
</tr>
<tr>
<td><code>OnDpiChanged</code> 相当</td>
<td><code>backingScaleFactor</code> 変化</td>
<td>画面またぎ移動時</td>
</tr>
</tbody>
</table>
<h3 id="45">4.5 電源/バッテリー/サーマル</h3>
<table>
<thead>
<tr>
<th>Event</th>
<th>トリガ</th>
<th>備考</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>OnPowerSourceChanged</code></td>
<td>IOKit Power Sources</td>
<td>AC/バッテリー</td>
</tr>
<tr>
<td><code>OnBatteryLevel</code> 系</td>
<td>同上（定期照会と併用）</td>
<td>しきい値で発火</td>
</tr>
<tr>
<td><strong><code>OnThermalStateChanged</code> (M‑Add)</strong></td>
<td><code>NSProcessInfo.thermalStateDidChangeNotification</code></td>
<td>低/中/高/重大</td>
</tr>
</tbody>
</table>
<h3 id="46">4.6 ロケール/外観/言語</h3>
<table>
<thead>
<tr>
<th>Event</th>
<th>トリガ</th>
<th>備考</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>OnLocaleChange</code></td>
<td><code>NSLocale.currentLocaleDidChangeNotification</code></td>
<td>地域/表記設定</td>
</tr>
<tr>
<td><strong><code>OnAppearanceChanged</code> (M‑Add)</strong></td>
<td><code>NSApp.effectiveAppearance</code> 監視</td>
<td>Light/Dark</td>
</tr>
<tr>
<td><code>OnInputSourceChanged</code>（任意）</td>
<td>TIS Input Source 監視</td>
<td>実装任意</td>
</tr>
</tbody>
</table>
<h3 id="47-weburl">4.7 Web/URL 連携</h3>
<table>
<thead>
<tr>
<th>Event</th>
<th>トリガ</th>
<th>備考</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>OnXUkagakaLinkOpen</code> 等</td>
<td>URL スキーム受理</td>
<td>既存語彙準拠</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="5-madd">5. 追加定義（<strong>M‑Add</strong>）</h2>
<ul>
<li><strong><code>OnSpaceChanged</code></strong>：<code>NSWorkspace.activeSpaceDidChangeNotification</code> により Spaces 切替を通知。  </li>
<li><strong><code>OnAppearanceChanged</code></strong>：ダーク/ライト切替を通知。<code>Appearance=light|dark|highcontrast</code> 等のパラメータを返す。  </li>
<li><strong><code>OnThermalStateChanged</code></strong>：<code>State=nominal|fair|serious|critical</code>。</li>
</ul>
<hr />
<h2 id="6">6. パラメータ規定</h2>
<ul>
<li><strong>座標</strong>：<code>screenX,screenY</code> は <strong>左下原点の pt</strong>。補助として <code>topLeftX,topLeftY</code> を併送可。  </li>
<li><strong>修飾キー</strong>：<code>Command|Option|Shift|Control|CapsLock|Function</code> などのビット名。  </li>
<li><strong>UTType</strong>：<code>public.plain-text</code>/<code>public.url</code>/<code>public.file-url</code> を基本。拡張は UTType 階層の同等性で判定。  </li>
<li><strong>Encoding</strong>：返却は UTF‑8 固定。</li>
</ul>
<hr />
<h2 id="7">7. サンドボックス/セキュリティ</h2>
<ul>
<li><strong>ファイル D&amp;D</strong>：App Sandbox 環境では <strong>security‑scoped URL</strong> を開始/終了で管理。  </li>
<li><strong>外部由来イベント</strong>（SSTP/URL スキーム）からのパス入力は<strong>制限パス</strong>にサニタイズ。</li>
</ul>
<h2 id="8">8. 互換性の注意と非対応</h2>
<ul>
<li>Windows 固有の語彙（<code>HWND</code> 等）は<strong>未定義</strong>。  </li>
<li>スクリーンセーバ <strong>Start/End</strong> は macOS 公開 API が無いため、<strong>ディスプレイスリープ/復帰</strong>で近似（任意有効化）。</li>
</ul>
<h2 id="9">9. 仕様例（リクエスト/レスポンス）</h2>
<div class="codehilite"><pre><span></span><code># OnURLDrop の例（単一）
GET SHIORI/3.0
ID: OnURLDrop
Sender: Ourin
Reference0: https://example.org/
SecurityLevel: external

###

SHIORI/3.0 200 OK
Value: \0\s[0]URLを受け取りました：%reference[0]\e
</code></pre></div>

<hr />
<h2 id="a-api">付録A: 代表 API 対応表</h2>
<ul>
<li>Spaces 変更 → <code>NSWorkspace.activeSpaceDidChangeNotification</code>  </li>
<li>画面構成変更 → <code>NSApplication.didChangeScreenParametersNotification</code> / CGDisplay Reconfig  </li>
<li>キー/修飾 → <code>NSEvent.keyCode</code> / <code>NSEvent.ModifierFlags</code>  </li>
<li>D&amp;D 種別 → <code>NSPasteboard.PasteboardType.url</code> / <code>public.plain-text</code> / <code>public.file-url</code>  </li>
<li>Power/Battery → IOKit Power Sources（通知＋照会）  </li>
<li>外観 → <code>NSApplication.effectiveAppearance</code></li>
</ul>
<h2 id="b">付録B: テスト観点チェックリスト</h2>
<ul>
<li>[ ] URL/ファイル/テキスト D&amp;D の判定と文字コード  </li>
<li>[ ] 複数ディスプレイ/スケール変更の座標・DPI 追随  </li>
<li>[ ] Sleep/Wake・AC/バッテリー切替・サーマル状態  </li>
<li>[ ] ロケール変更・テーマ切替  </li>
<li>[ ] セキュリティ（Sandbox の security‑scoped URL、外部入力の検証）</li>
</ul>
        <div class="footer">
            <p>Generated: 2025-10-23 | <a href="../README_ja-jp.md">Source (MD)</a></p>
        </div>
    </div>
</body>
</html>
