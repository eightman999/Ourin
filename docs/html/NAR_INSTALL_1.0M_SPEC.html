<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", "Hiragino Kaku Gothic ProN", "Hiragino Sans", "游ゴシック", YuGothic, "メイリオ", Meiryo, sans-serif;
            line-height: 1.6;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .content {
            background-color: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            border-bottom: 3px solid #333;
            padding-bottom: 10px;
            color: #333;
        }
        h2 {
            border-bottom: 2px solid #666;
            padding-bottom: 8px;
            margin-top: 30px;
            color: #444;
        }
        h3 {
            margin-top: 25px;
            color: #555;
        }
        code {
            background-color: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: "SF Mono", "Menlo", "Monaco", "Courier New", monospace;
            font-size: 0.9em;
        }
        pre {
            background-color: #f4f4f4;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            border-left: 4px solid #333;
        }
        pre code {
            background-color: transparent;
            padding: 0;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #f8f8f8;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        a {
            color: #0066cc;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
        blockquote {
            border-left: 4px solid #ddd;
            padding-left: 20px;
            margin-left: 0;
            color: #666;
            font-style: italic;
        }
        ul, ol {
            padding-left: 30px;
        }
        li {
            margin: 8px 0;
        }
        hr {
            border: none;
            border-top: 2px solid #ddd;
            margin: 30px 0;
        }
        .toc {
            background-color: #f8f8f8;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
        }
        input[type="checkbox"] {
            margin-right: 8px;
        }
        .footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            text-align: center;
            color: #666;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="content">
        <h1 id="ourin-nar-doubleclick-installer-nar-install10m-macos-toc">Ourin — <strong>NAR Double‑Click Installer</strong> 仕様書（NAR-INSTALL/1.0M, macOS, ToC付き）</h1>
<p><strong>Status:</strong> Draft<br />
<strong>Updated:</strong> 2025-07-28 20:07 UTC+09:00<br />
<strong>Target:</strong> macOS 10.15+（Catalina 以降）, Universal 2（arm64 / x86_64）</p>
<blockquote>
<p>目的：拡張子 <strong><code>.nar</code></strong>（実体は ZIP アーカイブ）を<strong>ダブルクリック</strong>または<strong>「このAppで開く」</strong>で Ourin が受け取り、<code>install.txt</code> の語彙に従って <strong>ghost / balloon / shell / plugin / package</strong> を所定ディレクトリに安全に展開・登録するための規格。SSP の慣行（D&amp;D/ダブルクリック）を踏襲しつつ、<strong>UTF‑8 を既定</strong>・<strong>CP932 受理</strong>・<strong>Zip Slip防止</strong>を必須とする。</p>
</blockquote>
<hr />
<h2 id="_1">目次</h2>
<ul>
<li><a href="#0-用語前提">0. 用語・前提</a></li>
<li><a href="#1-適用範囲と非目標">1. 適用範囲と非目標</a></li>
<li><a href="#2-依存仕様と参考">2. 依存仕様と参考</a></li>
<li><a href="#3-受付と関連付けutidocument-types">3. 受付と関連付け（UTI/Document Types）</a></li>
<li><a href="#4-受け口open-handler">4. 受け口（open handler）</a></li>
<li><a href="#5-アーカイブ検証と文字コード判定">5. アーカイブ検証と文字コード判定</a></li>
<li><a href="#6-installtxt-の語彙受理する要点">6. install.txt の語彙（受理する要点）</a></li>
<li><a href="#7-展開ポリシー安全な-unzip-と配置">7. 展開ポリシー（安全な unzip と配置）</a></li>
<li><a href="#8-競合と更新acceptdeletehomeurl">8. 競合と更新（accept/delete/homeurl）</a></li>
<li><a href="#9-ログ失敗時の-ux">9. ログ・失敗時の UX</a></li>
<li><a href="#10-セキュリティzip-slip--隔離属性">10. セキュリティ（Zip Slip / 隔離属性）</a></li>
<li><a href="#11-互換性メモwindows大小改行差分">11. 互換性メモ（Windows/大小・改行差分）</a></li>
<li><a href="#付録a-infoplist-宣言例">付録A. Info.plist 宣言例</a></li>
<li><a href="#付録b-成功失敗フロー">付録B. 成功/失敗フロー</a></li>
<li><a href="#付録c-サンプル構成">付録C. サンプル構成</a></li>
<li><a href="#変更履歴">変更履歴</a></li>
</ul>
<hr />
<h2 id="0">0. 用語・前提</h2>
<ul>
<li><strong>.nar</strong>：Ukagaka 配布パッケージ。<strong>実体は ZIP</strong>。  </li>
<li><strong>install.txt</strong>：アーカイブ最上位に置かれる<strong>インストール定義</strong>（<code>type</code>/<code>directory</code>/<code>*.directory</code> ほか）。  </li>
<li><strong>Ourin 標準設置先</strong>：<code>~/Library/Application Support/Ourin/</code> 配下。  </li>
<li><strong>文字コード</strong>：<strong>UTF‑8 既定</strong>、<strong>CP932 受理</strong>（内部は UTF‑8 正規化）。</li>
</ul>
<h2 id="1">1. 適用範囲と非目標</h2>
<ul>
<li><strong>対象</strong>：Finder の<strong>ダブルクリック</strong>／「このAppで開く」／Ourin ウィンドウへの<strong>D&amp;D</strong>でのインストール。  </li>
<li><strong>非目標</strong>：Windows のバイナリ互換再現や、Install UI の完全模倣。<strong>プロトコル（install.txt の語彙）互換</strong>を重視。</li>
</ul>
<h2 id="2">2. 依存仕様と参考</h2>
<ul>
<li><strong>Apple UTI/Document Types</strong>：<code>.nar</code> を <strong>custom UTI</strong> としてエクスポートし、<strong><code>public.zip-archive</code></strong> に準拠。<code>CFBundleDocumentTypes</code> で関連付け、App は <strong>open handler</strong> を実装する。  </li>
<li><strong>NSApplicationDelegate</strong>：<code>application(_:openFiles:)</code> / <code>application(_:open:)</code> で URL/パス受理。  </li>
<li><strong>Ukadoc</strong>：<strong>install.txt / 配布 / ネットワーク更新</strong>などの運用慣行に準拠（<code>updates2.dau</code>/<code>delete.txt</code>/ドラッグ&amp;ドロップ/ダブルクリック）。</li>
</ul>
<h2 id="3-utidocument-types">3. 受付と関連付け（UTI/Document Types）</h2>
<ul>
<li><strong>UTExportedTypeDeclarations</strong> に <code>jp.ourin.nar</code> を宣言し、<code>UTTypeConformsTo = public.zip-archive</code>、拡張子 <code>nar</code> を紐付ける。  </li>
<li><strong>CFBundleDocumentTypes</strong> に <code>LSItemContentTypes = jp.ourin.nar</code> を設定（Role は Viewer/Editor いずれでも可）。</li>
<li>競合した場合の優先度は <strong>LSHandlerRank</strong> で調整。</li>
</ul>
<h2 id="4-open-handler">4. 受け口（open handler）</h2>
<ul>
<li>App 起動時/起動中の<strong>両方</strong>で呼ばれるよう、<code>NSApplicationDelegate.application(_:openFiles:)</code>（複数）と <code>application(_:open:)</code>（URL）双方を実装。SwiftUI 構成でも AppKit デリゲートをブリッジ。</li>
</ul>
<h2 id="5">5. アーカイブ検証と文字コード判定</h2>
<ul>
<li>MIME/UTType で <strong>zip 互換</strong>を確認し、先頭レコードもチェック。  </li>
<li><code>install.txt</code> は <strong>UTF‑8 を優先</strong>して読む。失敗時は <strong>CP932</strong> で再試行し、内部は UTF‑8 正規化。BOM・CRLF も受理。</li>
</ul>
<h2 id="6-installtxt">6. install.txt の語彙（受理する要点）</h2>
<ul>
<li><strong>必須</strong>：<code>type,(ghost|balloon|shell|plugin|package)</code>／<code>directory,&lt;設置名&gt;</code>  </li>
<li><strong>任意</strong>：<code>accept,&lt;識別名&gt;</code>、<code>*.directory,&lt;同梱名&gt;</code>（例：<code>balloon.directory,MyBalloon</code>）、<code>*.source.directory</code> など。  </li>
<li><strong>推奨</strong>：<code>charset,UTF-8</code> を<strong>先頭</strong>に明記。</li>
</ul>
<h2 id="7-unzip">7. 展開ポリシー（安全な unzip と配置）</h2>
<ul>
<li>一時ディレクトリに<strong>安全に解凍</strong>→ <code>install.txt</code> を解釈 → <strong>設置先</strong>にコピー。  </li>
<li><strong>除外</strong>：<code>__MACOSX/</code>、<code>.DS_Store</code>、<code>Thumbs.db</code> は自動除外。  </li>
<li><strong>ケース整合</strong>：ファイル名の大小を<strong>厳密に</strong>扱い、重複衝突は警告。</li>
</ul>
<h2 id="8-acceptdeletehomeurl">8. 競合と更新（accept/delete/homeurl）</h2>
<ul>
<li>既存 <code>{directory}</code> がある場合：<code>accept</code> 一致なら上書き更新、相違なら別名提案。  </li>
<li><code>delete.txt</code> があれば不要資産を削除。更新配布は <code>homeurl</code> + <code>updates2.dau</code> に追従。</li>
</ul>
<h2 id="9-ux">9. ログ・失敗時の UX</h2>
<ul>
<li>主要フェーズ（検証/解析/展開/事後処理）を <code>OSLog</code> に記録。  </li>
<li>代表エラー：<code>InstallTxtMissing</code>、<code>UnsupportedType</code>、<code>ZipSlipDetected</code>、<code>NameConflict</code>、<code>DecodeFailed(sjis)</code>。</li>
</ul>
<h2 id="10-zip-slip">10. セキュリティ（Zip Slip / 隔離属性）</h2>
<ul>
<li><strong>Zip Slip</strong>：展開前にパス正規化し、<code>..</code>/絶対パス/シンボリックリンクによる<strong>ターゲット外書込み</strong>を<strong>拒否</strong>。  </li>
<li>ダウンロード由来の隔離属性は<strong>ユーザ操作起点</strong>（ダブルクリック/ドロップ）で正規フローと見做す。</li>
</ul>
<h2 id="11-windows">11. 互換性メモ（Windows/大小・改行差分）</h2>
<ul>
<li>Windows 既存配布は <strong>Shift_JIS</strong>／<code>\\</code> 区切りのまま入ってくることがある。Ourin は <strong>入力受理</strong>し、内部を UTF‑8/UNIX パスに正規化する。  </li>
<li>改行は CRLF/LF どちらも受理。</li>
</ul>
<hr />
<h2 id="a-infoplist">付録A. Info.plist 宣言例</h2>
<pre><code class="language-xml">&lt;!-- Info.plist 抜粋：UTI と Document Types --&gt;
&lt;key&gt;UTExportedTypeDeclarations&lt;/key&gt;
&lt;array&gt;
  &lt;dict&gt;
    &lt;key&gt;UTTypeIdentifier&lt;/key&gt;&lt;string&gt;jp.ourin.nar&lt;/string&gt;
    &lt;key&gt;UTTypeDescription&lt;/key&gt;&lt;string&gt;Ukagaka NAR&lt;/string&gt;
    &lt;key&gt;UTTypeConformsTo&lt;/key&gt;
    &lt;array&gt;&lt;string&gt;public.zip-archive&lt;/string&gt;&lt;/array&gt;
    &lt;key&gt;UTTypeTagSpecification&lt;/key&gt;
    &lt;dict&gt;
      &lt;key&gt;public.filename-extension&lt;/key&gt;&lt;array&gt;&lt;string&gt;nar&lt;/string&gt;&lt;/array&gt;
      &lt;key&gt;public.mime-type&lt;/key&gt;&lt;string&gt;application/x-ukagaka-nar&lt;/string&gt;
    &lt;/dict&gt;
  &lt;/dict&gt;
&lt;/array&gt;

&lt;key&gt;CFBundleDocumentTypes&lt;/key&gt;
&lt;array&gt;
  &lt;dict&gt;
    &lt;key&gt;CFBundleTypeName&lt;/key&gt;&lt;string&gt;Ukagaka NAR&lt;/string&gt;
    &lt;key&gt;LSItemContentTypes&lt;/key&gt;
    &lt;array&gt;&lt;string&gt;jp.ourin.nar&lt;/string&gt;&lt;/array&gt;
    &lt;key&gt;CFBundleTypeRole&lt;/key&gt;&lt;string&gt;Viewer&lt;/string&gt;
  &lt;/dict&gt;
&lt;/array&gt;
</code></pre>
<h2 id="b">付録B. 成功/失敗フロー</h2>
<pre><code>Finder(.nar) → Launch Services → Ourin(app open)
 → open handler
   → validate(zip) OK? → read install.txt → parse {type,directory,...}
   → resolve install path
   → safeExtract → copy/merge → post steps(readme/terms, switch)
   → success toast

NG:
  - no install.txt → error: InstallTxtMissing
  - unsupported type → error: UnsupportedType
  - zip slip → error: ZipSlipDetected
  - directory conflict → user prompt(rename/overwrite)
</code></pre>
<h2 id="c">付録C. サンプル構成</h2>
<pre><code>OURIN_NAR_INSTALL_1_0M/
  NAR_INSTALL_1.0M_SPEC.md
  NAR_INSTALL_1.0M_PLAN.md
  sample/
    Sources/OurinNarInstallerSample/
      AppDelegate.swift
      SampleNarInstaller.swift
      InstallTxtParser.swift
      ZipUtil.swift
      Paths.swift
    Info.plist (example)
</code></pre>
<hr />
<h2 id="implementation-status">実装状況（Implementation Status）</h2>
<p><strong>更新日:</strong> 2025-10-20</p>
<h3 id="ourin">Ourin における実装</h3>
<ul>
<li>[x] <strong>NAR ファイルの関連付け</strong>: Info.plist にて <code>.nar</code> の UTI 宣言と関連付けを実装済み</li>
<li>[x] <strong>ダブルクリック/D&amp;D 受付</strong>: AppDelegate での openFiles ハンドラ実装済み</li>
<li>[x] <strong>ZIP 展開</strong>: <code>ZipUtil.swift</code> にて実装済み</li>
<li>[x] <strong>install.txt 解析</strong>: <code>InstallTxtParser.swift</code> にて実装済み</li>
<li>[x] <strong>文字コード自動検出</strong>: UTF-8 および CP932 の自動検出を実装済み</li>
<li>[x] <strong>Zip Slip 防止</strong>: <code>ZipUtil.secureCopyTree()</code> にて実装済み</li>
<li>[x] <strong>型別インストール</strong>: <code>OurinPaths.installTarget()</code> にて ghost/balloon/shell/plugin の配置先解決を実装済み</li>
<li>[x] <strong>基本的なエラー処理</strong>: インストールエラーの検出と報告を実装済み</li>
<li>[ ] <strong>競合時の UI</strong>: accept/delete/homeurl の完全な UI 実装は未完了</li>
<li>[ ] <strong>更新機能</strong>: updates2.dau の処理は未実装</li>
<li>[ ] <strong>削除機能</strong>: delete.txt の処理は未実装</li>
</ul>
<h3 id="_2">実装済みの機能</h3>
<ol>
<li><strong>パッケージ受付</strong></li>
<li>Finder からのダブルクリック</li>
<li>Ourin ウィンドウへのドラッグ&amp;ドロップ</li>
<li>
<p>「このアプリケーションで開く」からの起動</p>
</li>
<li>
<p><strong>展開と検証</strong></p>
</li>
<li>ZIP ヘッダの検証（PK マジックナンバー）</li>
<li>一時ディレクトリへの安全な展開</li>
<li>
<p>install.txt の存在確認</p>
</li>
<li>
<p><strong>install.txt 解析</strong></p>
</li>
<li><code>type</code> フィールドの解析（ghost, balloon, shell, plugin, package）</li>
<li><code>directory</code> および <code>*.directory</code> の解析</li>
<li>
<p>UTF-8/CP932 の自動判定とデコード</p>
</li>
<li>
<p><strong>安全な配置</strong></p>
</li>
<li>Zip Slip 攻撃の防止（親ディレクトリへの脱出防止）</li>
<li><code>~/Library/Application Support/Ourin/</code> 配下への配置</li>
<li>
<p>型別のディレクトリ振り分け（ghost, balloon, shell, plugin）</p>
</li>
<li>
<p><strong>エラーハンドリング</strong></p>
</li>
<li>NAR 形式エラー（NotZip）</li>
<li>install.txt 欠落（InstallTxtNotFound）</li>
<li>デコードエラー（InstallTxtDecodeFailed）</li>
<li>未対応型（UnsupportedType）</li>
<li>Zip Slip 検出（ZipSlipDetected）</li>
<li>ディレクトリ衝突（DirectoryConflict）</li>
</ol>
<h3 id="_3">未実装の機能</h3>
<ol>
<li><strong>競合解決 UI</strong></li>
<li><code>accept</code> フィールドによる上書き確認ダイアログ</li>
<li>
<p>ユーザーへのリネーム/上書き選択肢の提示</p>
</li>
<li>
<p><strong>ネットワーク更新</strong></p>
</li>
<li><code>updates2.dau</code> の処理</li>
<li>
<p>自動更新チェック</p>
</li>
<li>
<p><strong>削除処理</strong></p>
</li>
<li><code>delete.txt</code> の処理</li>
<li>
<p>アンインストール時のファイル削除</p>
</li>
<li>
<p><strong>高度な機能</strong></p>
</li>
<li>README/利用規約の表示</li>
<li>インストール後の自動切り替え</li>
<li>homeurl の処理</li>
</ol>
<h3 id="_4">ソースコード位置</h3>
<ul>
<li><code>Ourin/NarInstall/LocalNarInstaller.swift</code>: インストーラ本体</li>
<li><code>Ourin/NarInstall/InstallTxtParser.swift</code>: install.txt 解析</li>
<li><code>Ourin/NarInstall/ZipUtil.swift</code>: ZIP 展開ユーティリティ</li>
<li><code>Ourin/NarInstall/Paths.swift</code>: パス解決（OurinPaths）</li>
<li><code>Ourin/NarInstall/NarInstallViewModel.swift</code>: UI ViewModel</li>
<li><code>Ourin/NarInstall/NarInstallView.swift</code>: SwiftUI インストール画面</li>
</ul>
<hr />
<h2 id="_5">変更履歴</h2>
<ul>
<li>2025-10-20: 実装状況セクションを追加</li>
<li>2025-07-28 20:07 UTC+09:00: 初版（NAR-INSTALL/1.0M）。</li>
</ul>
        <div class="footer">
            <p>Ourin (桜鈴) - macOS ネイティブ伺かベースウェア</p>
        </div>
    </div>
</body>
</html>