<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLUGIN Event — **2.0M（macOS）** 仕様書（UKADOC準拠・完全版）</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", "Hiragino Kaku Gothic ProN", "Hiragino Sans", "游ゴシック", YuGothic, "メイリオ", Meiryo, sans-serif;
            line-height: 1.6;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .content {
            background-color: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            border-bottom: 3px solid #333;
            padding-bottom: 10px;
            color: #333;
        }
        h2 {
            border-bottom: 2px solid #666;
            padding-bottom: 8px;
            margin-top: 30px;
            color: #444;
        }
        h3 {
            margin-top: 25px;
            color: #555;
        }
        code {
            background-color: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: "SF Mono", "Menlo", "Monaco", "Courier New", monospace;
            font-size: 0.9em;
        }
        pre {
            background-color: #f4f4f4;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            border-left: 4px solid #333;
        }
        pre code {
            background-color: transparent;
            padding: 0;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #f8f8f8;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        a {
            color: #0066cc;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
        blockquote {
            border-left: 4px solid #ddd;
            padding-left: 20px;
            margin-left: 0;
            color: #666;
            font-style: italic;
        }
        ul, ol {
            padding-left: 30px;
        }
        li {
            margin: 8px 0;
        }
        hr {
            border: none;
            border-top: 2px solid #ddd;
            margin: 30px 0;
        }
        .toc {
            background-color: #f8f8f8;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
        }
        input[type="checkbox"] {
            margin-right: 8px;
        }
        .footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            text-align: center;
            color: #666;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="content">
        <h1 id="plugin-event-20mmacos-ukadoc">PLUGIN Event — <strong>2.0M（macOS）</strong> 仕様書（UKADOC準拠・完全版）</h1>
<p><strong>Status:</strong> Draft / Ourin (macOS 10.15+ / Universal 2: arm64+x86_64)<br />
<strong>Updated:</strong> 2025-07-27 (JST)<br />
<strong>互換方針:</strong> UKADOC「PLUGIN Eventリスト」の<strong>イベントID／意味／Reference順</strong>を踏襲。<strong>OS依存値のみ macOS ネイティブ</strong>へ置換。<br />
<strong>文字コード:</strong> 既定 <strong>UTF‑8</strong>（互換で CP932/SJIS 受理→内部 UTF‑8 正規化）。<code>version</code> 応答の <code>Charset:</code> 指定があれば切り替え。<br />
<strong>改行:</strong> <code>CRLF</code> を厳守（受理）。内部処理は <code>LF</code> 正規化可。<br />
<strong>用語:</strong> 「バイト値1区切り」= <strong>0x01 (SOH)</strong> 区切り。</p>
<hr />
<h2 id="_1">目次</h2>
<ul>
<li><a href="#1-本仕様の目的">1. 本仕様の目的</a></li>
<li><a href="#2-通信符号化改行plugin20-準拠">2. 通信・符号化・改行（PLUGIN/2.0 準拠）</a></li>
<li><a href="#3-macos置換m-diff">3. macOS置換（M‑Diff）</a></li>
<li><a href="#4-イベント一覧完全">4. イベント一覧（完全）</a></li>
<li><a href="#41-version">4.1 version</a></li>
<li><a href="#42-installedplugin-notify">4.2 installedplugin [NOTIFY]</a></li>
<li><a href="#43-installedghostname-notify">4.3 installedghostname [NOTIFY]</a></li>
<li><a href="#44-installedballoonname-notify">4.4 installedballoonname [NOTIFY]</a></li>
<li><a href="#45-ghostpathlist-notify">4.5 ghostpathlist [NOTIFY]</a></li>
<li><a href="#46-balloonpathlist-notify">4.6 balloonpathlist [NOTIFY]</a></li>
<li><a href="#47-headlinepathlist-notify">4.7 headlinepathlist [NOTIFY]</a></li>
<li><a href="#48-pluginpathlist-notify">4.8 pluginpathlist [NOTIFY]</a></li>
<li><a href="#49-onsecondchange">4.9 OnSecondChange</a></li>
<li><a href="#410-onotherghosttalk">4.10 OnOtherGhostTalk</a></li>
<li><a href="#411-onghostboot">4.11 OnGhostBoot</a></li>
<li><a href="#412-onghostexit-notify">4.12 OnGhostExit [NOTIFY]</a></li>
<li><a href="#413-onghostinfoupdate-notify">4.13 OnGhostInfoUpdate [NOTIFY]</a></li>
<li><a href="#414-onmenuexec">4.14 OnMenuExec</a></li>
<li><a href="#415-oninstallcomplete">4.15 OnInstallComplete</a></li>
<li><a href="#416-onchoiceselectexonanchorselectexq-任意名">4.16 OnChoiceSelect(Ex)/OnAnchorSelect(Ex)/\q 任意名</a></li>
<li><a href="#417-raisepluginnotifyplugin-任意名">4.17 ![raiseplugin]/![notifyplugin] 任意名</a></li>
<li><a href="#5-応答戻り値ポリシー">5. 応答・戻り値ポリシー</a></li>
<li><a href="#6-例-フレーミング">6. 例: フレーミング</a></li>
<li><a href="#7-変更履歴">7. 変更履歴</a></li>
</ul>
<hr />
<h2 id="1">1. 本仕様の目的</h2>
<ul>
<li>Windows 固有の要素（<code>HWND</code>/パス表現）を <strong>macOS ネイティブ</strong>に差し替えつつ、<strong>語彙と意味は互換</strong>のままプラグインにイベントを通知する。</li>
</ul>
<h2 id="2-plugin20">2. 通信・符号化・改行（PLUGIN/2.0 準拠）</h2>
<ul>
<li>リクエスト/レスポンスは <strong>PLUGIN/2.0</strong> のヘッダ書式に準拠（<code>GET/NOTIFY PLUGIN/2.0</code>、<code>ID:</code>、<code>ReferenceN:</code>、<code>Charset:</code> 等）。  </li>
<li>改行は <strong>CR+LF</strong>。<code>Charset:</code> 指定があればそれに従う（既定: 2.0M では UTF‑8）。</li>
</ul>
<h2 id="3-macosmdiff">3. macOS置換（M‑Diff）</h2>
<ul>
<li><strong>ウィンドウ識別</strong>：<code>HWND</code>（Windows固有）は <strong><code>CGWindowID</code> の列</strong>に置換。Ourin の NSWindow からは <code>windowNumber</code> を参照し Window Server 番号として扱い、外部照会や検証は <code>CGWindowListCopyWindowInfo</code> の <code>kCGWindowNumber</code> を用いる。  </li>
<li><strong>パス</strong>：Windows パスは <strong>POSIX 絶対パス</strong>または <strong><code>file://</code> URL</strong> に置換（相対はプラグイン/ゴースト基点から解決）。  </li>
<li><strong>区切り</strong>：リストは <strong>0x01 区切り</strong>（原典の「バイト値1区切り」）。</li>
</ul>
<hr />
<h2 id="4">4. イベント一覧（完全）</h2>
<h3 id="41-version">4.1 <code>version</code></h3>
<ul>
<li><strong>時期</strong>: プラグインのロード直後。  </li>
<li><strong>応答</strong>: <code>Value:</code> にプラグインのバージョン文字列。任意で <code>Charset: &lt;enc&gt;</code> を付けると以後のリクエストに適用。  </li>
<li><strong>備考</strong>: 本イベントのみ応答様式が他と異なる。</li>
</ul>
<h3 id="42-installedplugin-notify">4.2 <code>installedplugin</code> <strong>[NOTIFY]</strong></h3>
<ul>
<li><strong>意味</strong>: インストール済プラグインの列挙。  </li>
<li><strong>Ref</strong>*: 0x01 区切り <code>プラグイン名,プラグインID</code>。</li>
</ul>
<h3 id="43-installedghostname-notify">4.3 <code>installedghostname</code> <strong>[NOTIFY]</strong></h3>
<ul>
<li><strong>Ref0</strong>: 0x01 区切りのゴースト名リスト。  </li>
<li><strong>Ref1</strong>: 0x01 区切りの <code>\0</code> 名リスト。  </li>
<li><strong>Ref2</strong>: 0x01 区切りの <code>\1</code> 名リスト。</li>
</ul>
<h3 id="44-installedballoonname-notify">4.4 <code>installedballoonname</code> <strong>[NOTIFY]</strong></h3>
<ul>
<li><strong>Ref0</strong>: 0x01 区切りのバルーン名リスト。</li>
</ul>
<h3 id="45-ghostpathlist-notify">4.5 <code>ghostpathlist</code> <strong>[NOTIFY]</strong></h3>
<ul>
<li><strong>Ref</strong><em>: 読み込んでいる </em><em>ゴーストフォルダのフルパス</em><em>（</em><em>POSIX/<code>file://</code></em>*）。複数ある場合は <code>Reference1..</code>。</li>
</ul>
<h3 id="46-balloonpathlist-notify">4.6 <code>balloonpathlist</code> <strong>[NOTIFY]</strong></h3>
<ul>
<li><strong>Ref0</strong>: 読み込んでいる <strong>バルーンフォルダのフルパス</strong>（POSIX/<code>file://</code>）。</li>
</ul>
<h3 id="47-headlinepathlist-notify">4.7 <code>headlinepathlist</code> <strong>[NOTIFY]</strong></h3>
<ul>
<li><strong>Ref</strong><em>: 読み込んでいる </em><em>ヘッドラインフォルダのフルパス</em>*（POSIX/<code>file://</code>）。</li>
</ul>
<h3 id="48-pluginpathlist-notify">4.8 <code>pluginpathlist</code> <strong>[NOTIFY]</strong></h3>
<ul>
<li><strong>Ref</strong><em>: 読み込んでいる </em><em>プラグインフォルダのフルパス</em>*（POSIX/<code>file://</code>）。</li>
</ul>
<h3 id="49-onsecondchange">4.9 <code>OnSecondChange</code></h3>
<ul>
<li><strong>意味</strong>: 秒間隔の通知。  </li>
<li><strong>間隔</strong>: <code>descript.txt</code> の <code>secondchangeinterval</code> に従う（秒）。</li>
</ul>
<h3 id="410-onotherghosttalk">4.10 <code>OnOtherGhostTalk</code></h3>
<ul>
<li><strong>Ref0</strong>: ゴースト名。  </li>
<li><strong>Ref1</strong>: 本体側名。  </li>
<li><strong>Ref2</strong>: 原因列挙（<code>break,communicate,sstp-send,owned,remote,notranslate,plugin-script,plugin-event</code> の <strong>カンマ区切り</strong>）。  </li>
<li><strong>Ref3</strong>: 発話イベント ID。  </li>
<li><strong>Ref4</strong>: 発話スクリプト。  </li>
<li><strong>Ref5</strong>: 0x01 区切りで、ゴーストに渡された Reference 群。</li>
</ul>
<h3 id="411-onghostboot">4.11 <code>OnGhostBoot</code></h3>
<ul>
<li><strong>Ref0</strong>: <strong>起動したゴーストの各キャラクタウィンドウの <code>CGWindowID</code> 列</strong>（未構築は <code>0</code>）。  </li>
<li><strong>Ref1</strong>: ゴースト名。  </li>
<li><strong>Ref2</strong>: 現在のシェル名。  </li>
<li><strong>Ref3</strong>: ゴースト ID（Owned SSTP と同等）。  </li>
<li><strong>Ref4</strong>: ゴーストのフルパス（POSIX/<code>file://</code>）。</li>
</ul>
<h3 id="412-onghostexit-notify">4.12 <code>OnGhostExit</code> <strong>[NOTIFY]</strong></h3>
<ul>
<li><strong>Ref0</strong>: <strong>終了したゴーストの <code>CGWindowID</code> 列</strong>（未構築は <code>0</code>）。  </li>
<li><strong>Ref1..4</strong>: 名称/シェル名/ID/フルパス（POSIX/<code>file://</code>）。</li>
</ul>
<h3 id="413-onghostinfoupdate-notify">4.13 <code>OnGhostInfoUpdate</code> <strong>[NOTIFY]</strong></h3>
<ul>
<li><strong>Ref0</strong>: <strong>変更があったゴーストの <code>CGWindowID</code> 列</strong>（未構築は <code>0</code>）。  </li>
<li><strong>Ref1..4</strong>: 名称/シェル名/ID/フルパス（POSIX/<code>file://</code>）。</li>
</ul>
<h3 id="414-onmenuexec">4.14 <code>OnMenuExec</code></h3>
<ul>
<li><strong>意味</strong>: オーナードローメニューからプラグインが実行された。  </li>
<li><strong>Ref0</strong>: 呼び出し元ゴーストの <strong><code>CGWindowID</code> 列</strong>。  </li>
<li><strong>Ref1..4</strong>: 名称/シェル名/ID/フルパス（POSIX/<code>file://</code>）。</li>
</ul>
<h3 id="415-oninstallcomplete">4.15 <code>OnInstallComplete</code></h3>
<ul>
<li><strong>Ref0</strong>: 0x01 区切りの <strong>インストールタイプ</strong>。  </li>
<li><strong>Ref1</strong>: 0x01 区切りの <strong>名前</strong>。  </li>
<li><strong>Ref2</strong>: 0x01 区切りの <strong>フルパス</strong>（POSIX/<code>file://</code>）。</li>
</ul>
<h3 id="416-onchoiceselectex-onanchorselectex-q">4.16 <code>OnChoiceSelect(Ex)</code> / <code>OnAnchorSelect(Ex)</code> / <code>\q</code> 任意名</h3>
<ul>
<li><strong>意味</strong>: 選択肢/アンカー選択時の <strong>SHIORI Event 横流し</strong>。  </li>
<li><strong>Ref</strong>*: 発生した SHIORI Event の Reference 群（そのまま）。</li>
</ul>
<h3 id="417-raiseplugin-notifyplugin">4.17 <code>\![raiseplugin]</code> / <code>\![notifyplugin]</code> 任意名</h3>
<ul>
<li><strong>意味</strong>: さくらスクリプトの実行でプラグインに通知（<code>notifyplugin</code> は <strong>[NOTIFY]</strong>）。  </li>
<li><strong>Ref</strong>*: 指定された任意引数。</li>
</ul>
<hr />
<h2 id="5">5. 応答・戻り値ポリシー</h2>
<ul>
<li><strong>[NOTIFY]</strong>: スクリプト返却は <strong>無視</strong>。<code>PLUGIN/2.0 204 No Content</code> でよい。  </li>
<li><strong>無印</strong>: <code>GET</code> の場合は <code>PLUGIN/2.0 200 OK</code> で <code>Script:</code> 等を返せる（<code>Target/Event/Reference</code> 可）。</li>
</ul>
<h2 id="6">6. 例: フレーミング</h2>
<pre><code>GET PLUGIN/2.0
ID: OnGhostBoot
Charset: UTF-8
Sender: Ourin
Reference0: 12345,67890
Reference1: 里々さん
Reference2: default.shell
Reference3: ourin-ghost-uuid
Reference4: /Users/you/Library/Application Support/Ourin/Ghosts/Satori

###

PLUGIN/2.0 200 OK
Script: \0\s[0]OK\e
</code></pre>
<h2 id="7">7. 変更履歴</h2>
<ul>
<li>2025-07-27: 初版（完全版、macOS置換つき）。</li>
</ul>
        <div class="footer">
            <p>Ourin (桜鈴) - macOS ネイティブ伺かベースウェア</p>
        </div>
    </div>
</body>
</html>