<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", "Hiragino Kaku Gothic ProN", "Hiragino Sans", "游ゴシック", YuGothic, "メイリオ", Meiryo, sans-serif;
            line-height: 1.6;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .content {
            background-color: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            border-bottom: 3px solid #333;
            padding-bottom: 10px;
            color: #333;
        }
        h2 {
            border-bottom: 2px solid #666;
            padding-bottom: 8px;
            margin-top: 30px;
            color: #444;
        }
        h3 {
            margin-top: 25px;
            color: #555;
        }
        code {
            background-color: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: "SF Mono", "Menlo", "Monaco", "Courier New", monospace;
            font-size: 0.9em;
        }
        pre {
            background-color: #f4f4f4;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            border-left: 4px solid #333;
        }
        pre code {
            background-color: transparent;
            padding: 0;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #f8f8f8;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        a {
            color: #0066cc;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
        blockquote {
            border-left: 4px solid #ddd;
            padding-left: 20px;
            margin-left: 0;
            color: #666;
            font-style: italic;
        }
        ul, ol {
            padding-left: 30px;
        }
        li {
            margin: 8px 0;
        }
        hr {
            border: none;
            border-top: 2px solid #ddd;
            margin: 30px 0;
        }
        .toc {
            background-color: #f8f8f8;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
        }
        input[type="checkbox"] {
            margin-right: 8px;
        }
        .footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            text-align: center;
            color: #666;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="content">
        <h1 id="ourin-yaya-adapter-spec-10m">Ourin — YAYA Adapter SPEC 1.0M（完全版）</h1>
<p><strong>Status:</strong> Draft ✅ / Ready for implementation<br />
<strong>Updated:</strong> 2025-07-30 22:57 UTC+09:00 (JST)<br />
<strong>Scope:</strong> Ourin (macOS, Universal 2) で、ゴーストの <em>YAYA 辞書(.dic)</em> を <strong>Windows DLL に依存せず</strong>ネイティブ実行するための仕様。<br />
<strong>Non‑goals:</strong> Windowsの <code>yaya.dll</code> をそのまま読むこと（不可）。dll→dylib変換もしない。</p>
<hr />
<h2 id="_1">目次</h2>
<ul>
<li>
<ol>
<li>目的と背景</li>
</ol>
</li>
<li>
<ol>
<li>用語</li>
</ol>
</li>
<li>
<ol>
<li>互換方針（SHIORI/3.0M）</li>
</ol>
</li>
<li>
<ol>
<li>全体アーキテクチャ</li>
</ol>
</li>
<li>
<ol>
<li>USL（Universal SHIORI Loader）</li>
</ol>
</li>
<li>
<ol>
<li>YAYA Adapter I/F（プロセス／dylib）</li>
</ol>
</li>
<li>
<ol>
<li>SHIORI/3.0M ブリッジ仕様</li>
</ol>
</li>
<li>
<ol>
<li>.dic ロード／文字コード</li>
</ol>
</li>
<li>
<ol>
<li>インストールから初回表示まで（シーケンス）</li>
</ol>
</li>
<li>
<ol>
<li>エラー処理／タイムアウト／再起動</li>
</ol>
</li>
<li>
<ol>
<li>ロギング／計測</li>
</ol>
</li>
<li>
<ol>
<li>セキュリティ／権限</li>
</ol>
</li>
<li>
<ol>
<li>配置（Bundle）／Universal 2</li>
</ol>
</li>
<li>
<ol>
<li>ライセンス表記</li>
</ol>
</li>
<li>
<ol>
<li>既知差分と互換ルール</li>
</ol>
</li>
<li>
<ol>
<li>付録（メッセージ例・フォーマット・テンプレコード）</li>
</ol>
</li>
</ul>
<hr />
<h2 id="1">1. 目的と背景</h2>
<ul>
<li>既存ゴーストは <code>descript.txt</code> の <strong><code>shiori</code></strong> に <code>yaya.dll</code> 等を指定する。Ourin は <strong>dll をロードせず</strong>、USL が <strong>内蔵 YAYA 実行体</strong>へ振替える（論理置換）。</li>
<li>SHIORI の通信は <strong>SHIORI/3.0</strong> を基準とし、<strong>互換（3.0M）</strong>としてヘッダ・終端・ステータスを忠実に再現。</li>
</ul>
<h2 id="2">2. 用語</h2>
<ul>
<li><strong>USL</strong>: Universal SHIORI Loader。<code>shiori</code> 値を解釈、適切なアダプタに委譲。</li>
<li><strong>YAYA Core</strong>: YAYA ランタイム本体（<strong>ヘルパー実行体</strong>または <strong><code>libyaya.dylib</code></strong>）。</li>
<li><strong>Adapter</strong>: USLと各実行体を結ぶブリッジ。</li>
</ul>
<h2 id="3-shiori30m">3. 互換方針（SHIORI/3.0M）</h2>
<ul>
<li><strong>語彙・挙動互換</strong>：メソッド（GET/NOTIFY）、必須ヘッダ、<strong>CRLF + 空行終端</strong>、Status、Value の扱いを忠実に実装。</li>
<li><strong>ID: capability</strong> を起動時にやり取りし、拡張対応を明示。</li>
</ul>
<h2 id="4">4. 全体アーキテクチャ</h2>
<pre><code>Ourin.app
 └ Contents/
    ├ MacOS/Ourin                 # ベースウェア本体
    ├ Helpers/yaya_core           # ★推奨：YAYA 実行体（Universal 2）
    ├ Frameworks/libyaya.dylib    # 代替：共有ライブラリ
    └ Resources/...
</code></pre>
<ul>
<li><strong>USL</strong> は <code>descript.txt</code> の <code>shiori</code> を横取り解釈し、<strong>YAYA Adapter</strong> を選択。</li>
<li><strong>YAYA Adapter</strong> は <strong>プロセス</strong>（Helpers）または <strong>dylib</strong> 形態で YAYA に接続。</li>
</ul>
<h2 id="5-usluniversal-shiori-loader">5. USL（Universal SHIORI Loader）</h2>
<h3 id="51">5.1 役割</h3>
<ul>
<li><code>shiori</code> 値から <strong>エンジン種別を推定</strong>（<code>yaya.dll</code> 系 → YAYA Adapter）。</li>
<li><strong>複数ゴースト</strong>に対して <strong>インスタンス分離</strong>（プロセス推奨）。</li>
<li>SHIORI/3.0M の <strong>入出力整形</strong>（CRLF/空行・ヘッダ・Value）を担う。</li>
</ul>
<h3 id="52">5.2 設定とマッピング</h3>
<ul>
<li>デフォルトは <strong>論理置換</strong>（<code>descript.txt</code> は書き換えない）。オプションで <code>shiori, ourin-usl</code> へ書換可能（バックアップ保存）。</li>
</ul>
<h2 id="6-yaya-adapter-ifdylib">6. YAYA Adapter I/F（プロセス／dylib）</h2>
<h3 id="61">6.1 形態</h3>
<ul>
<li><strong>推奨：ヘルパー実行体</strong>（<code>Helpers/yaya_core</code>）。クラッシュ隔離／差し替え容易。</li>
<li><strong>代替：dylib 直ロード</strong>（<code>libyaya.dylib</code>）。低レイテンシ。クラッシュ巻き添えリスク。</li>
</ul>
<h3 id="62-ipc-json">6.2 IPC プロトコル（行単位 JSON）</h3>
<ul>
<li>文字コードは <strong>UTF‑8 固定</strong>。1行＝1メッセージ。</li>
<li>Ourin → Adapter：</li>
</ul>
<pre><code class="language-json">{&quot;cmd&quot;:&quot;load&quot;,&quot;ghost_root&quot;:&quot;/path/to/ghost/master&quot;,&quot;dic&quot;:[&quot;a.dic&quot;,&quot;b.dic&quot;],&quot;encoding&quot;:&quot;utf-8&quot;,&quot;env&quot;:{&quot;LANG&quot;:&quot;ja_JP.UTF-8&quot;}}
{&quot;cmd&quot;:&quot;request&quot;,&quot;method&quot;:&quot;GET&quot;,&quot;id&quot;:&quot;OnBoot&quot;,&quot;headers&quot;:{&quot;Charset&quot;:&quot;UTF-8&quot;,&quot;Sender&quot;:&quot;Ourin&quot;},&quot;ref&quot;:[]}
{&quot;cmd&quot;:&quot;unload&quot;}
</code></pre>
<ul>
<li>Adapter → Ourin：</li>
</ul>
<pre><code class="language-json">{&quot;ok&quot;:true,&quot;status&quot;:200,&quot;headers&quot;:{&quot;Charset&quot;:&quot;UTF-8&quot;},&quot;value&quot;:&quot;\0\s[0]Hello from YAYA\e&quot;}
{&quot;ok&quot;:false,&quot;status&quot;:500,&quot;error&quot;:&quot;load failed: ... &quot;}
</code></pre>
<h2 id="7-shiori30m">7. SHIORI/3.0M ブリッジ仕様</h2>
<ul>
<li><strong>メソッド</strong>：<code>GET</code> は Value 必須、<code>NOTIFY</code> は Value 無視。</li>
<li><strong>ヘッダ</strong>（例）：<code>Charset</code>,<code>Sender</code>,<code>SenderType</code>,<code>SecurityLevel</code>,<code>ID</code>,<code>BaseID</code>,<code>Reference0..n</code>。</li>
<li><strong>終端</strong>：ヘッダ群 → 空行 → Value（<code>GET</code> のみ）。改行は <strong>CRLF</strong>。</li>
<li><strong>ステータス</strong>：200/204/400/500 等。</li>
</ul>
<h2 id="8-dic">8. .dic ロード／文字コード</h2>
<ul>
<li><strong>探索順</strong>：
  1) <code>~/Library/Application Support/Ourin/Ghosts/&lt;name&gt;/ghost/master/*.dic</code>
  2) インストール先の <code>ghost/master/*.dic</code>
  3) バンドル同梱テンプレ <code>Resources/Ghosts/&lt;name&gt;/ghost/master/*.dic</code></li>
<li><strong>文字コード</strong>：既定 <strong>UTF‑8</strong>。妥当でなければ <strong>CP932（Windows‑31J）</strong>で再試行。設定で固定可能。</li>
</ul>
<h2 id="9">9. インストールから初回表示まで（シーケンス）</h2>
<p>1) <strong>Ourin を配置（署名・公証済み）</strong><br />
2) <strong>初回起動ウィザード</strong>：ゴーストフォルダ/NARを選択→展開→<code>ghost/master</code> 構成を検証。<br />
3) <strong>USL</strong> が <code>descript.txt</code> を読んで <code>shiori</code> を解析 → <strong>YAYA Adapter</strong> に決定。<br />
4) <strong>YAYA Adapter</strong> を起動：<code>load</code> で <code>.dic</code> 群を読み込む（UTF‑8→CP932の順）。<br />
5) <strong>SHIORI/3.0M</strong>：<code>OnBoot</code> を <code>GET</code> 送信 → <code>Value</code>（SakuraScript）を受領。<br />
6) <strong>レンダラ</strong>：SakuraScript を描画（<code>\0/\1/\n/\w/\e</code> など最小集合から）。<br />
7) <strong>表示</strong>：シェル＆バルーンに初期セリフを表示。</p>
<pre><code>User → Ourin → USL → YAYA Adapter → (YAYA) → USL → Ourin Renderer → Balloon
</code></pre>
<h2 id="10">10. エラー処理／タイムアウト／再起動</h2>
<ul>
<li>既定タイムアウト <strong>5s</strong>。超過はキャンセルし UI に通知。</li>
<li><code>load</code> 失敗：文字コード/パス/辞書破損をメッセージで提示（ログ採取）。</li>
<li>連続クラッシュは <strong>バックオフ</strong>（指数的）。</li>
</ul>
<h2 id="11">11. ロギング／計測</h2>
<ul>
<li>構造化ログ：<code>ts, req_id, id, method, latency_ms, status</code>。</li>
<li>トレース：必要に応じ <strong>tama 互換ログ</strong>を出力。</li>
</ul>
<h2 id="12">12. セキュリティ／権限</h2>
<ul>
<li>外部起動やURLは OS API（NSWorkspace）へ委譲。</li>
<li>SSTP は既定 <strong>localhost</strong> のみ開放。</li>
</ul>
<h2 id="13-bundleuniversal-2">13. 配置（Bundle）／Universal 2</h2>
<ul>
<li><strong>Helpers/</strong> または <strong>Frameworks/</strong> に内蔵実行体を配置。</li>
<li>全バイナリは <strong>Universal 2（arm64 + x86_64）</strong>。</li>
</ul>
<h2 id="14">14. ライセンス表記</h2>
<ul>
<li><strong>YAYA</strong>: BSD‑3‑Clause（LICENSE を同梱／About 画面にクレジット）。</li>
</ul>
<h2 id="15">15. 既知差分と互換ルール</h2>
<ul>
<li><strong>Windows専用 SAORI</strong> は対象外（将来はネイティブ置換/ブリッジ）。</li>
<li><strong>TabletMode 等</strong>は mac に概念がないため未対応。</li>
</ul>
<h2 id="16">16. 付録（メッセージ例・テンプレコード）</h2>
<h3 id="161-ourinadapterswiftjson">16.1 Ourin→Adapter（Swift：標準入出力JSON）</h3>
<pre><code class="language-swift">struct YayaMessage: Codable { let cmd: String; let method: String?; let id: String?; let headers: [String:String]?; let ref: [String]? }
let proc = Process()
proc.executableURL = Bundle.main.url(forAuxiliaryExecutable: &quot;yaya_core&quot;)
let inPipe = Pipe(), outPipe = Pipe()
proc.standardInput = inPipe; proc.standardOutput = outPipe
try proc.run()
let load = YayaMessage(cmd: &quot;load&quot;, method: nil, id: nil, headers: [&quot;Charset&quot;:&quot;UTF-8&quot;], ref: nil)
let data = try JSONEncoder().encode(load)
inPipe.fileHandleForWriting.write(data + &quot;\n&quot;.data(using: .utf8)!)
</code></pre>
<h3 id="162-shiori-crlf">16.2 SHIORI 受発信（CRLF 終端）</h3>
<pre><code class="language-swift">func buildGET(id: String, refs: [String]) -&gt; Data {
  var headers = [
    &quot;ID&quot;: id, &quot;Charset&quot;: &quot;UTF-8&quot;, &quot;Sender&quot;: &quot;Ourin&quot;
  ]
  for (i, r) in refs.enumerated() { headers[&quot;Reference\(i)&quot;] = r }
  let head = headers.map { &quot;\($0): \($1)\r\n&quot; }.joined() + &quot;\r\n&quot;
  return Data(head.utf8)
}
</code></pre>
<hr />
<h2 id="implementation-status">実装状況（Implementation Status）</h2>
<p><strong>更新日:</strong> 2025-10-20</p>
<h3 id="ourin-yaya-adapter">Ourin における YAYA Adapter 実装</h3>
<ul>
<li>[x] <strong>完全実装済み</strong>: YAYA Adapter は実装され、動作確認済み</li>
<li>[x] <strong>USL (Universal SHIORI Loader)</strong>: <code>ShioriLoader.swift</code> にて実装済み</li>
<li>[x] <strong>YAYA Backend</strong>: <code>YayaBackend</code> クラスにて実装済み</li>
<li>[x] <strong>YAYA Adapter</strong>: <code>YayaAdapter.swift</code> にてヘルパープロセスとの通信を実装済み</li>
<li>[x] <strong>SHIORI/3.0M ブリッジ</strong>: リクエスト/レスポンスの変換処理を実装済み</li>
<li>[x] <strong>文字コード対応</strong>: UTF-8 既定、CP932 フォールバックを実装済み</li>
<li>[x] <strong>.dic ファイルロード</strong>: 再帰的な設定ファイル解析を実装済み</li>
</ul>
<h3 id="_2">実装済みの機能</h3>
<ol>
<li><strong>USL (Universal SHIORI Loader)</strong></li>
<li><code>descript.txt</code> の <code>shiori</code> フィールド解析</li>
<li>YAYA 系 DLL の検出と YAYA Backend へのルーティング</li>
<li>
<p>複数バックエンド対応の基盤</p>
</li>
<li>
<p><strong>YAYA Backend</strong></p>
</li>
<li>YAYA ゴーストの検出とロード</li>
<li><code>yaya.txt</code> の解析</li>
<li><code>dic</code> エントリの再帰的収集</li>
<li>include ファイルの処理</li>
<li>
<p>ゴースト master ディレクトリの管理</p>
</li>
<li>
<p><strong>YAYA Adapter</strong></p>
</li>
<li>ヘルパープロセス (<code>yaya_core</code>) との通信</li>
<li><code>load()</code>, <code>request()</code>, <code>unload()</code> API</li>
<li>タイムアウト処理（5秒デフォルト）</li>
<li>
<p>JSON ベースの IPC プロトコル</p>
</li>
<li>
<p><strong>SHIORI/3.0M ブリッジ</strong></p>
</li>
<li><code>GET</code>/<code>NOTIFY</code> メソッドの処理</li>
<li>リクエストパース（ID, Reference*, Charset など）</li>
<li>レスポンス生成（Status, Value, Charset）</li>
<li>
<p>CRLF + 空行終端の処理</p>
</li>
<li>
<p><strong>文字コード処理</strong></p>
</li>
<li>UTF-8 既定での処理</li>
<li>CP932/Shift_JIS のフォールバック</li>
<li>
<p>BOM 付き UTF-8 の許容</p>
</li>
<li>
<p><strong>辞書ロード</strong></p>
</li>
<li><code>yaya.txt</code> の解析</li>
<li><code>dic, filename</code> エントリの処理</li>
<li><code>dic, path/filename, encoding</code> 形式のサポート</li>
<li>相対パス解決（ghost/master 基準）</li>
<li>
<p><code>#include</code> による再帰的設定ファイルロード</p>
</li>
<li>
<p><strong>エラーハンドリング</strong></p>
</li>
<li>ロード失敗の検出</li>
<li>タイムアウトエラー</li>
<li>不正な設定ファイルの処理</li>
<li>ログ出力による診断</li>
</ol>
<h3 id="_3">実装ファイル</h3>
<ul>
<li><code>Ourin/USL/ShioriLoader.swift</code>: USL とバックエンド選択</li>
<li><code>Ourin/Yaya/YayaAdapter.swift</code>: YAYA プロセスとの通信</li>
<li>YAYA Core は別リポジトリ <code>yaya_core/</code> にて実装</li>
</ul>
<h3 id="_4">動作確認済み機能</h3>
<ul>
<li>✅ YAYA ゴーストのロード</li>
<li>✅ <code>OnBoot</code> イベントの処理</li>
<li>✅ <code>OnCommunicate</code> イベントの処理</li>
<li>✅ <code>yaya.txt</code> の解析と dic ファイル収集</li>
<li>✅ UTF-8 および CP932 辞書の読み込み</li>
<li>✅ SHIORI/3.0 プロトコルでの通信</li>
<li>✅ Value の返却とスクリプト表示</li>
</ul>
<h3 id="_5">未実装の機能</h3>
<ol>
<li><strong>dylib 形式の直接ロード</strong></li>
<li>現在はヘルパープロセス方式のみ</li>
<li>
<p><code>libyaya.dylib</code> の直接ロードは未実装</p>
</li>
<li>
<p><strong>高度なエラーリカバリ</strong></p>
</li>
<li>連続クラッシュ時のバックオフ</li>
<li>
<p>自動再起動機能</p>
</li>
<li>
<p><strong>詳細なロギング</strong></p>
</li>
<li>tama 互換ログ形式</li>
<li>
<p>構造化ログの完全実装</p>
</li>
<li>
<p><strong>SAORI 連携</strong></p>
</li>
<li>Windows 専用 SAORI のネイティブ置換</li>
<li>SAORI ブリッジ機能</li>
</ol>
<h3 id="_6">アーキテクチャ</h3>
<pre><code>Ourin.app
 └ Contents/
    ├ MacOS/Ourin              # ベースウェア本体
    │  └ ShioriLoader         # USL 実装
    │     └ YayaBackend       # YAYA 検出・管理
    │        └ YayaAdapter    # プロセス通信
    └ (外部) yaya_core        # YAYA ランタイム（別プロセス）
</code></pre>
<h3 id="ipc">IPC プロトコル実装状況</h3>
<ul>
<li>[x] JSON ベースのメッセージング</li>
<li>[x] <code>load</code> コマンド（ghost_root, dics, encoding）</li>
<li>[x] <code>request</code> コマンド（method, id, headers, refs）</li>
<li>[x] <code>unload</code> コマンド</li>
<li>[x] レスポンス処理（ok, status, headers, value, error）</li>
<li>[x] タイムアウト処理（5秒デフォルト）</li>
</ul>
<hr />
<h2 id="_7">変更履歴</h2>
<ul>
<li>2025-10-20: 実装状況セクションを追加</li>
<li>2025-07-30 22:57 UTC+09:00 (JST): 初版</li>
</ul>
        <div class="footer">
            <p>Ourin (桜鈴) - macOS ネイティブ伺かベースウェア</p>
        </div>
    </div>
</body>
</html>