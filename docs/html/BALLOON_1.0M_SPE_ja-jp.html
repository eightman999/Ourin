<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BALLOON/1.0M — Ourin（macOS）バルーン仕様（Draft）</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", "Hiragino Kaku Gothic ProN", "Hiragino Sans", "游ゴシック", YuGothic, "メイリオ", Meiryo, sans-serif;
            line-height: 1.6;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .content {
            background-color: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .lang-switcher {
            text-align: right;
            margin-bottom: 20px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
        }
        .lang-switcher a {
            margin: 0 5px;
            padding: 5px 15px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 3px;
            text-decoration: none;
            color: #333;
        }
        .lang-switcher a:hover {
            background-color: #e0e0e0;
        }
        .lang-switcher a.active {
            background-color: #0066cc;
            color: white;
            border-color: #0066cc;
        }
        h1 {
            border-bottom: 3px solid #333;
            padding-bottom: 10px;
            color: #333;
        }
        h2 {
            border-bottom: 2px solid #666;
            padding-bottom: 8px;
            margin-top: 30px;
            color: #444;
        }
        h3 {
            margin-top: 25px;
            color: #555;
        }
        code {
            background-color: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: "SF Mono", "Menlo", "Monaco", "Courier New", monospace;
            font-size: 0.9em;
        }
        pre {
            background-color: #f4f4f4;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            border-left: 4px solid #333;
        }
        pre code {
            background-color: transparent;
            padding: 0;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #f8f8f8;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        a {
            color: #0066cc;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
        blockquote {
            border-left: 4px solid #ddd;
            padding-left: 20px;
            margin-left: 0;
            color: #666;
            font-style: italic;
        }
        ul, ol {
            padding-left: 30px;
        }
        li {
            margin: 8px 0;
        }
        hr {
            border: none;
            border-top: 2px solid #ddd;
            margin: 30px 0;
        }
        .footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            text-align: center;
            color: #666;
            font-size: 0.9em;
        }
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #0066cc;
            text-decoration: none;
        }
        .back-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="content">
        <div class="lang-switcher">
            
        </div>
        <div class="back-link">
            <a href="index.html">← 目次に戻る</a>
        </div>
        <h1 id="balloon10m-ourinmacosdraft">BALLOON/1.0M — Ourin（macOS）バルーン仕様（Draft）</h1>
<p><strong>Status:</strong> Draft / macOS 10.15+ / Universal 2（arm64・x86_64）<br />
<strong>Updated:</strong> 2025-07-27 (JST)<br />
<strong>互換方針:</strong> UKADOC「バルーン設定」および周辺仕様（descript.txt / balloons<em>s.txt 等）の</em><em>語彙・挙動互換</em><em>を維持しつつ、ウィンドウ/描画/入力を </em><em>macOS ネイティブ API</em><em> へ置換。<br />
</em><em>非目標:</em>* Windows 固有の UI・レジストリ・GDI 準拠の再現（語彙・挙動互換に限定）。</p>
<hr />
<h2 id="_1">目次</h2>
<ul>
<li><a href="#1-対象と範囲">1. 対象と範囲</a></li>
<li><a href="#2-ファイル構成と文字コード">2. ファイル構成と文字コード</a></li>
<li><a href="#3-画像形式透過ssp互換">3. 画像形式・透過（SSP互換）</a></li>
<li><a href="#4-レンダリングretina多画面">4. レンダリング（Retina/多画面）</a></li>
<li><a href="#5-ウィンドウ特性前面非アクティブヒットテスト">5. ウィンドウ特性（前面/非アクティブ/ヒットテスト）</a></li>
<li><a href="#6-テキスト描画と装飾">6. テキスト描画と装飾</a></li>
<li><a href="#7-入力ボックス付随アセット">7. 入力ボックス・付随アセット</a></li>
<li><a href="#8-互換オプションwindowsmac-置換">8. 互換オプション（Windows→mac 置換）</a></li>
<li><a href="#9-エラーハンドリング">9. エラーハンドリング</a></li>
<li><a href="#10-適合チェックリスト">10. 適合チェックリスト</a></li>
<li><a href="#付録a-主なキー対応差分メモ">付録A. 主なキー対応（差分メモ）</a></li>
<li><a href="#付録b-画像読込パイプライン">付録B. 画像読込パイプライン</a></li>
</ul>
<hr />
<h2 id="1">1. 対象と範囲</h2>
<ul>
<li><code>descript.txt</code> の既定＋ <code>balloons*s.txt/balloonk*s.txt/balloonc*s.txt</code> による上書きを<strong>同等解釈</strong>する。  </li>
<li><code>arrow*.png</code> / <code>online*.png</code> / <code>sstp.png</code> 等、<strong>アセット名の意味</strong>を継承。</li>
</ul>
<h2 id="2">2. ファイル構成と文字コード</h2>
<ul>
<li><strong>UTF‑8 を標準</strong>。<code>descript.txt</code> 等の <code>charset,Shift_JIS</code> 指定があれば <strong>CP932 として受理</strong>。  </li>
<li>配置はベースウェアのバルーン格納フォルダ配下（UKADOC と同様）。</li>
</ul>
<h2 id="3-ssp">3. 画像形式・透過（SSP互換）</h2>
<ul>
<li><strong>読込対応フォーマット（互換）</strong>：<strong>BMP / PNG / JPEG / GIF / MAG / XBM / PI / ICO / CUR</strong>。  </li>
<li>既定は <strong>Image I/O</strong>（PNG/JPEG/GIF/BMP など一般形式）。</li>
<li><strong>ICO/CUR</strong> は内蔵パーサ（本配布の最小実装参照）。</li>
<li><strong>MAG / PI / XBM</strong> は <strong>拡張デコーダ SPI</strong> を通じて段階的に提供。  </li>
<li><strong>32bit PNG（RGBA）による透過表示</strong>をサポート（アルファ合成）。</li>
<li><strong>PNA</strong>（別ファイルアルファ）にも互換対応。</li>
</ul>
<h2 id="4-retina">4. レンダリング（Retina/多画面）</h2>
<ul>
<li>記述座標は<strong>論理px</strong>。描画時に <strong>backingScaleFactor</strong> に応じて解像度を選択し、<strong>高DPIでも見え方を一致</strong>させる。  </li>
<li>画面移動やスケール変更時は <code>viewDidChangeBackingProperties</code> をフックし、画像/フォントスケールを再計算。</li>
</ul>
<h2 id="5">5. ウィンドウ特性（前面/非アクティブ/ヒットテスト）</h2>
<ul>
<li><strong>NSPanel（nonactivating）</strong> を基本に、<strong>フォーカスを奪わず</strong>前面表示（<code>.floating</code> 等の適切なレベル）。  </li>
<li>クリック透過は <code>NSView.hitTest(_:)</code> をオーバーライドして<strong>透明画素のみ背面へ通す</strong>（全体透過は <code>ignoresMouseEvents=true</code> も可）。</li>
</ul>
<h2 id="6">6. テキスト描画と装飾</h2>
<ul>
<li>フォント解決は <strong>NSFont/CTFont</strong>。未インストール時は代替フォント。  </li>
<li>太字/斜体/下線/打消し線/影/アウトラインは <strong>NSAttributedString</strong> 属性で表現。  </li>
<li>折返しは <strong>byCharWrapping</strong> を既定。必要に応じ Core Text で禁則・ルビ等を拡張。</li>
</ul>
<h2 id="7">7. 入力ボックス・付随アセット</h2>
<ul>
<li><code>communicatebox.*</code> は <strong>NSTextView 相当</strong>で再現（半透明は <code>use_input_alpha</code>）。  </li>
<li><code>arrow*.png</code> / <code>online*.png</code> / <code>sstp.png</code> / <code>marker.png</code> 等の意味・優先度を継承。</li>
</ul>
<h2 id="8-windowsmac">8. 互換オプション（Windows→mac 置換）</h2>
<ul>
<li><code>cursor.style</code> は矩形/下線を描画して再現。  </li>
<li><code>wordwrappoint.x</code> は Core Text のレイアウト幅に反映。  </li>
<li>推奨ゴースト（<code>recommended.*</code>）は UI に警告表示。</li>
</ul>
<h2 id="9">9. エラーハンドリング</h2>
<ul>
<li>未知キーはログ警告の上、<strong>既定値で継続</strong>。  </li>
<li>フォント未設置・画像読込失敗は UI 通知＋代替を適用。  </li>
<li>スケール変更時は<strong>即時リレイアウト</strong>しフリンジを抑制。</li>
</ul>
<h2 id="10">10. 適合チェックリスト</h2>
<ul>
<li>[ ] <code>descript.txt</code> と <code>balloons*s.txt</code> の<strong>上書き規則</strong>を実装。  </li>
<li>[ ] <strong>UTF‑8 標準／CP932 受理</strong>。  </li>
<li>[ ] <strong>PNG/JPEG/GIF/BMP</strong> 読込（Image I/O）。  </li>
<li>[ ] <strong>ICO/CUR</strong> 読込（内蔵パーサ）。  </li>
<li>[ ] <strong>MAG/XBM/PI</strong> は SPI で拡張可能。  </li>
<li>[ ] <strong>32bit PNG アルファ</strong>で正しく透過。  </li>
<li>[ ] <strong>Retina/多画面</strong>で等価表示。  </li>
<li>[ ] <strong>非アクティブ前面</strong>＋<strong>透明ヒットテスト</strong>。</li>
</ul>
<hr />
<h2 id="a">付録A. 主なキー対応（差分メモ）</h2>
<ul>
<li><code>font.*</code>、<code>validrect.*</code>、<code>origin.*</code>、<code>windowposition.*</code>、<code>use_self_alpha</code>、<code>use_input_alpha</code>、<code>paint_transparent_region_black</code>、<code>overlay_outside_balloon</code>、<code>communicatebox.*</code>、<code>arrow/online/sstp/marker</code> … <strong>UKADOC の語彙をそのままサポート</strong>。</li>
</ul>
<h2 id="b">付録B. 画像読込パイプライン</h2>
<div class="codehilite"><pre><span></span><code><span class="kt">Data</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">UTI推定</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Image</span><span class="w"> </span><span class="n">I</span><span class="o">/</span><span class="n">O</span><span class="w"> </span><span class="p">(</span><span class="n">PNG</span><span class="o">/</span><span class="n">JPEG</span><span class="o">/</span><span class="n">GIF</span><span class="o">/</span><span class="n">BMP</span><span class="p">)</span><span class="w"> </span>
<span class="w">                  </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">ICO</span><span class="o">/</span><span class="n">CUR</span><span class="w"> </span><span class="err">内蔵パーサ</span><span class="w"> </span><span class="p">(</span><span class="n">PNGペイロード</span><span class="w"> </span><span class="kr">or</span><span class="w"> </span><span class="mi">32</span><span class="n">bpp</span><span class="w"> </span><span class="n">BMP</span><span class="err">→</span><span class="n">RGBA</span><span class="p">)</span>
<span class="w">                  </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">MAG</span><span class="o">/</span><span class="n">PI</span><span class="o">/</span><span class="n">XBM</span><span class="o">:</span><span class="w"> </span><span class="n">Ourin</span><span class="w"> </span><span class="n">Decoder</span><span class="w"> </span><span class="n">SPI</span><span class="err">（拡張）</span>
</code></pre></div>

<hr />
<h3 id="_2">参考（実装者向け補足）</h3>
<ul>
<li>ICO/CUR は <strong>ICONDIR + ICONDIRENTRY</strong> が先頭にあり、各エントリは <strong>PNG か DIB(BMP)</strong> を含む。CUR は <strong>hotspot(x,y)</strong> を ICONDIRENTRY の planes/bitcount フィールド位置に持つ。32bpp BMP は BGRA を α付きとして扱い、αが全ゼロなら AND マスクで補う。  </li>
<li>Retina 対応は <code>backingScaleFactor</code> と <code>viewDidChangeBackingProperties()</code> を利用。  </li>
<li>非アクティブ前面は <strong>nonactivatingPanel</strong>、クリック透過は <strong>hitTest</strong> 制御。</li>
</ul>
        <div class="footer">
            <p>Generated: 2025-10-23 | <a href="../README_ja-jp.md">Source (MD)</a></p>
        </div>
    </div>
</body>
</html>
